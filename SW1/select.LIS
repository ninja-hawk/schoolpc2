                         4 .list
                         5 ***************************************************************
                         6 ** 各種レジスタ定義
                         7 ***************************************************************
                         8 
                         9 ***************
                        10 ** レジスタ群の先頭
                        11 ***************
                        12 .equ REGBASE, 0xFFF000  | DMAP を使用.
                        13 .equ IOBASE,  0x00d00000
                        14 
                        15 ***************
                        16 ** 割り込み関係のレジスタ
                        17 ***************
                        18 .equ IVR,     REGBASE+0x300 | 割り込みベクタレジスタ
                        19 .equ IMR,     REGBASE+0x304 | 割り込みマスクレジスタ
                        20 .equ ISR,     REGBASE+0x30c | 割り込みステータスレジスタ
                        21 .equ IPR,     REGBASE+0x310 | 割り込みペンディングレジスタ
                        22 
                        23 
                        24 ***************
                        25 ** タイマ関係のレジスタ
                        26 ***************
                        27 .equ TCTL1,   REGBASE+0x600 | タイマ1コントロールレジスタ
                        28 .equ TPRER1,  REGBASE+0x602 | タイマ1プリスケーラレジスタ
                        29 .equ TCMP1,   REGBASE+0x604 | タイマ1コンペアレジスタ
                        30 .equ TCN1,    REGBASE+0x608 | タイマ1カウンタレジスタ
                        31 .equ TSTAT1,  REGBASE+0x60a | タイマ1ステータスレジスタ
                        32 ***************
                        33 ** UART1 (送受信)関係のレジスタ
                        34 ***************
                        35 .equ USTCNT1, REGBASE+0x900 | UART1 ステータス / コントロールレジスタ
                        36 .equ UBAUD1,  REGBASE+0x902 | UART1 ボーコントロールレジスタ
                        37 .equ URX1,    REGBASE+0x904 | UART1 受信レジスタ
                        38 .equ UTX1,    REGBASE+0x906 | UART1 送信レジスタ
                        39 ***************
                        40 ** LED
                        41 ***************
                        42 .equ LED7,  IOBASE+0x000002f | ボード搭載のLED用レジスタ
                        43 .equ LED6,  IOBASE+0x000002d | 使用法については付録 A.4.3.1
                        44 .equ LED5,  IOBASE+0x000002b
                        45 .equ LED4,  IOBASE+0x0000029
                        46 .equ LED3,  IOBASE+0x000003f
                        47 .equ LED2,  IOBASE+0x000003d
                        48 .equ LED1,  IOBASE+0x000003b
                        49 .equ LED0,  IOBASE+0x0000039
                        50 
                        51 **************
                        52 **システムコール番号
                        53 **************
                        54 .equ SYSCALL_NUM_GETSTRING,    1
                        55 .equ SYSCALL_NUM_PUTSTRING,    2
                        56 .equ SYSCALL_NUM_RESET_TIMER,  3
                        57 .equ SYSCALL_NUM_SET_TIMER,    4
                        58 
                        59 ***************************************************************
                        60 ** 初期化
                        61 ***************************************************************
                        62 .section .text
                        63 .even
                        64 boot:
                        65 		* スーパーバイザ & 各種設定を行っている最中の割込禁止
000400 46FC 2000        66 		move.w #0x2000,%SR
000404 4FF9 0000        67 		lea.l SYS_STK_TOP, %SP | Set SSP
       0000             67 
                        68 		****************
                        69 		** 割り込みコントローラの初期化
                        70 		****************
00040a 13FC 0040        71 		move.b #0x40, IVR      | ユーザ割り込みベクタ番号を
       00FF F300        71 
                        72 		                       | 0x40+level に設定.
000412 23FC 00FF        73 		move.l #0x00ff3ff9,IMR | 全割り込みマスクMUART=>0,MTMR1=>1
       3FF9 00FF        73 
       F304             73 
                        74 		****************
                        75 		** 送受信 (UART1) 関係の初期化 ( 割り込みレベルは 4 に固定されている )
                        76 		****************
00041c 21FC 0000        77 		move.l #UART1_interrupt, 0x110  | 受信割り込みベクタをセット
       0000 0110        77 
000424 33FC 0000        78 		move.w #0x0000, USTCNT1 | リセット
       00FF F900        78 
00042c 33FC E108        79 		move.w #0xe108, USTCNT1 | 送受信可能 , パリティなし , 1 stop, 8 bit,
       00FF F900        79 
                        80 					| 受信割り込み許可, 送信割り込み禁止
000434 33FC 0038        81 		move.w #0x0038, UBAUD1  | baud rate = 230400 bps
       00FF F902        81 
                        82 		****************
                        83 		** タイマ関係の初期化 ( 割り込みレベルは 6 に固定されている )
                        84 		*****************
00043c 33FC 0004        85 		move.w #0x0004, TCTL1   | restart, 割り込み不可 ,
       00FF F600        85 
                        86 					| システムクロックの 1/16 を単位として計時,
                        87 					| タイマ使用停止
000444 21FC 0000        88 		move.l #COMPARE_INTERPUT, 0x118 /* level 6 */
       0000 0118        88 
                        89 
00044c 21FC 0000        90                 move.l #SYS_CALL, 0x080 /*SYS_CALLの割り込みベクタ設定*/
       0000 0080        90 
                        91 		******************************
                        92 		** キューの初期化
                        93 		******************************
000454 45F9 0000        94 		lea.l  top0, %a2
       0000             94 
00045a 47F9 0000        95 		lea.l  top1, %a3
       0000             95 
000460 23CA 0000        96 		move.l %a2, out0
       0000             96 
000466 23CB 0000        97 		move.l %a3, out1
       0000             97 
00046c 23CA 0000        98 		move.l %a2, in0
       0000             98 
000472 23CB 0000        99 		move.l %a3, in1
       0000             99 
000478 23FC 0000       100 		move.l #0, s0
       0000 0000       100 
       0000            100 
000482 23FC 0000       101 		move.l #0, s1
       0000 0000       101 
       0000            101 
                       102 	
00048c 6000 0002       103 		bra MAIN
                       104 	
                       105 ****************************************************************
                       106 ***プログラム領域
                       107 ****************************************************************
                       108 MAIN:
                       109 		**走行モードとレベルの設定(「ユーザモード」への移行処理)
000490 46FC 0000       110 		move.w #0x0000, %SR    | USER MODE, LEVEL 0
000494 4FF9 0000       111 		lea.l  USR_STK_TOP,%SP | user stackの設定
       0000            111 
                       112 		**システムコールによるRESET_TIMERの起動
00049a 7003            113 		move.l #SYSCALL_NUM_RESET_TIMER, %D0
00049c 4E40            114 		trap   #0
                       115 		**システムコールによるSET_TIMERの起動
00049e 7004            116 		move.l #SYSCALL_NUM_SET_TIMER, %D0
0004a0 323C 2710       117 		move.w #10000, %D1
0004a4 243C 0000       118 		move.l #SELECT,%D2
       0000            118 
0004aa 4E40            119 		trap   #0
                       120 		
                       121 ******************************
                       122 * sys_GETSTRING, sys_PUTSTRINGのテスト
                       123 *ターミナルの入力をエコーバックする
                       124 ******************************
                       125 LOOP:
0004ac 6000 FFFE       126 		bra    LOOP
                       127 		
                       128 ******************************
                       129 ** 選択課題ゾーン
                       130 ******************************
                       131 SELECT:
0004b0 48E7 FFFE       132 		movem.l %D0-%D7/%A0-%A6,-(%SP)
0004b4 0C39 000A       133 		cmpi.b #0x0a,CS1            | CS1カウンタで10回実行したかどうか数える
       0000 0000       133 
0004bc 6700 010A       134 		beq    CS1KILL
                       135 SECOND:
0004c0 0C39 000A       136 		cmpi.b #0x0a,CS2            | CS2カウンタで6回実行したかどうか数える
       0000 0000       136 
0004c8 6700 0110       137 		beq    CS2KILL
                       138 TENSECOND:
0004cc 0C39 000A       139 		cmpi.b #0x0a,SS1            | SS1カウンタで10回実行したかどうか数える
       0000 0000       139 
0004d4 6700 0116       140 		beq    SS1KILL		
                       141 MINUTE:
0004d8 0C39 0006       142 		cmpi.b #0x06,SS2            | SS2カウンタで6回実行したかどうか数える
       0000 0000       142 
0004e0 6700 011C       143 		beq    SS2KILL
                       144 TENMINUTE:
0004e4 0C39 000A       145 		cmpi.b #0x0a,MM1            | MM1カウンタで10回実行したかどうか数える
       0000 0000       145 
0004ec 6700 0122       146 		beq    MM1KILL		
                       147 ENDCLOCK:
0004f0 0C39 0006       148 		cmpi.b #0x06,MM2            | MM2カウンタで10回実行したかどうか数える
       0000 0000       148 
0004f8 6700 0128       149 		beq    MM2KILL	
                       150 
                       151 COUNT:
0004fc 7002            152 		move.l #SYSCALL_NUM_PUTSTRING,%D0
0004fe 7200            153 		move.l #0,    %D1        | ch = 0
000500 243C 0000       154 		move.l #BACK, %D2        | p  = #BACK
       0000            154 
000506 7601            155 		move.l #1,    %D3        | size = 8
000508 4E40            156 		trap   #0
                       157 
00050a 41F9 0000       158 		lea.l  MMSSFF, %a0
       0000            158 
000510 10F9 0000       159 		move.b MM2, (%a0)+
       0000            159 
000516 10F9 0000       160 		move.b MM1, (%a0)+
       0000            160 
00051c 10F9 0000       161 		move.b COLON, (%a0)+
       0000            161 
000522 10F9 0000       162 		move.b SS2, (%a0)+
       0000            162 
000528 10F9 0000       163 		move.b SS1, (%a0)+
       0000            163 
00052e 10F9 0000       164 		move.b PERIOD, (%a0)+
       0000            164 
000534 10F9 0000       165 		move.b CS2, (%a0)+
       0000            165 
00053a 10B9 0000       166 		move.b CS1, (%a0)
       0000            166 
                       167 
000540 7001            168 		move.l #SYSCALL_NUM_GETSTRING, %D0
000542 7200            169 		move.l #0,   %D1        | ch   = 0
000544 243C 0000       170 		move.l #MMSSFF, %D2     | p    = #BUF
       0000            170 
00054a 7608            171 		move.l #8, %D3        | size = 256
00054c 4E40            172 		trap   #0
                       173 
00054e 7002            174 		move.l #SYSCALL_NUM_PUTSTRING,%D0
000550 7200            175 		move.l #0,    %D1        | ch = 0
000552 243C 0000       176 		move.l #MMSSFF, %D2      | p  = #TMSG
       0000            176 
000558 7608            177 		move.l #8,    %D3        | size = 8
00055a 4E40            178 		trap   #0
                       179 		/* c秒 */
00055c 1E39 0000       180 		move.b CS1, %d7
       0000            180 
000562 0607 0030       181 		add.b  #0x30, %d7
000566 13C7 00D0       182 		move.b %d7, LED0
       0039            182 
                       183 		/* 10c秒 */
00056c 1E39 0000       184 		move.b CS2, %d7
       0000            184 
000572 0607 0030       185 		add.b  #0x30, %d7
000576 13C7 00D0       186 		move.b %d7, LED1
       003B            186 
                       187 		/* 秒 */
00057c 1E39 0000       188 		move.b SS1, %d7
       0000            188 
000582 0607 0030       189 		add.b  #0x30, %d7
000586 13C7 00D0       190 		move.b %d7, LED3
       003F            190 
                       191 		/* 10秒 */
00058c 1E39 0000       192 		move.b SS2, %d7
       0000            192 
000592 0607 0030       193 		add.b  #0x30, %d7
000596 13C7 00D0       194 		move.b %d7, LED4
       0029            194 
                       195 		/* 分 */
00059c 1E39 0000       196 		move.b MM1, %d7
       0000            196 
0005a2 0607 0030       197 		add.b  #0x30, %d7
0005a6 13C7 00D0       198 		move.b %d7, LED6
       002D            198 
                       199 		/* 10分 */
0005ac 1E39 0000       200 		move.b MM2, %d7
       0000            200 
0005b2 0607 0030       201 		add.b  #0x30, %d7
0005b6 13C7 00D0       202 		move.b %d7, LED7
       002F            202 
                       203 		/* カウントアップ */
0005bc 0639 0001       204 		addi.b #1,CS1           | SS1カウンタを1つ増やして
       0000 0000       204 
0005c4 6000 00D0       205 		bra    SELECTEND         |そのまま戻る
                       206 CS1KILL:
0005c8 13FC 0000       207 		move.b #0x00, CS1
       0000 0000       207 
0005d0 5239 0000       208 		add.b  #0x01, CS2
       0000            208 
0005d6 6000 FEE8       209 		bra    SECOND
                       210 CS2KILL:
0005da 13FC 0000       211 		move.b #0x00, CS2
       0000 0000       211 
0005e2 5239 0000       212 		add.b  #0x01, SS1
       0000            212 
0005e8 6000 FEE2       213 		bra    TENSECOND
                       214 SS1KILL:
0005ec 13FC 0000       215 		move.b #0x00, SS1
       0000 0000       215 
0005f4 5239 0000       216 		add.b  #0x01, SS2
       0000            216 
0005fa 6000 FEDC       217 		bra    MINUTE
                       218 SS2KILL:
0005fe 13FC 0000       219 		move.b #0x00, SS2
       0000 0000       219 
000606 5239 0000       220 		add.b  #0x01, MM1
       0000            220 
00060c 6000 FED6       221 		bra    TENMINUTE
                       222 MM1KILL:
000610 13FC 0000       223 		move.b #0x00, MM1
       0000 0000       223 
000618 5239 0000       224 		add.b  #0x01, MM2
       0000            224 
00061e 6000 FED0       225 		bra    ENDCLOCK
                       226 MM2KILL:
000622 13FC 0000       227 		move.b #0x00, CS1
       0000 0000       227 
00062a 13FC 0000       228 		move.b #0x00, CS1
       0000 0000       228 
000632 13FC 0000       229 		move.b #0x00, SS1
       0000 0000       229 
00063a 13FC 0000       230 		move.b #0x00, SS1
       0000 0000       230 
000642 13FC 0000       231 		move.b #0x00, MM1
       0000 0000       231 
00064a 13FC 0000       232 		move.b #0x00, MM2
       0000 0000       232 
000652 13FC 004D       233 		move.b	#'M', LED7
       00D0 002F       233 
00065a 13FC 004D       234 		move.b	#'M', LED6
       00D0 002D       234 
000662 13FC 003A       235 		move.b  #':', LED5
       00D0 002B       235 
00066a 13FC 0053       236 		move.b	#'S', LED4
       00D0 0029       236 
000672 13FC 0053       237 		move.b	#'S', LED3
       00D0 003F       237 
00067a 13FC 002E       238 		move.b	#'.', LED2
       00D0 003D       238 
000682 13FC 0066       239 		move.b	#'f', LED1
       00D0 003B       239 
00068a 13FC 0066       240 		move.b	#'f', LED0
       00D0 0039       240 
000692 7003            241 		move.l #SYSCALL_NUM_RESET_TIMER,%D0
000694 4E40            242 		trap   #0		
                       243 
                       244 SELECTEND:
000696 4CDF 7FFF       245 		movem.l (%SP)+,%D0-%D7/%A0-%A6
00069a 4E75            246 		rts
                       247 
                       248 
                       249 
                       250 ******************************
                       251 *タイマのテスト
                       252 * ’******’を表示し改行する．
                       253 *５回実行すると，RESET_TIMERをする．
                       254 ******************************
                       255 TT:
00069c 48E7 FFFE       256 		movem.l %D0-%D7/%A0-%A6,-(%SP)
0006a0 0C79 0005       257 		cmpi.w #5,TTC            | TTCカウンタで5回実行したかどうか数える
       0000 0000       257 
0006a8 6700 001C       258 		beq    TTKILL            | 5回実行したら，タイマを止める
0006ac 7002            259 		move.l #SYSCALL_NUM_PUTSTRING,%D0
0006ae 7200            260 		move.l #0,    %D1        | ch = 0
0006b0 243C 0000       261 		move.l #TMSG, %D2        | p  = #TMSG
       0000            261 
0006b6 7608            262 		move.l #8,    %D3        | size = 8
0006b8 4E40            263 		trap   #0
0006ba 0679 0001       264 		addi.w #1,TTC            | TTCカウンタを1つ増やして
       0000 0000       264 
0006c2 6000 0006       265 		bra    TTEND             |そのまま戻る
                       266 TTKILL:
0006c6 7003            267 		move.l #SYSCALL_NUM_RESET_TIMER,%D0
0006c8 4E40            268 		trap   #0
                       269 TTEND:
0006ca 4CDF 7FFF       270 		movem.l (%SP)+,%D0-%D7/%A0-%A6
0006ce 4E75            271 		rts
                       272 
                       273 ******************************
                       274 ** COMPARE_INTERPUT:	タイマ用のハードウェア割り込みインターフェース
                       275 ******************************
                       276 COMPARE_INTERPUT:
0006d0 48E7 8000       277 		movem.l %d0, -(%sp) /* d0退避 */
0006d4 3039 00FF       278 		move.w  TSTAT1, %d0 /* TSTATの値をd0へ */
       F60A            278 
0006da 0800 0000       279 		btst	#0, %d0 /* タイマ1ステータスレジスタの0ビット目が0か、否か */
0006de 6700 000E       280 		beq	COMPARE_END /* 0ならコンペアイベントなし、つまりカウンタ値とコンペ
0006e2 33FC 0000       281 		move.w	#0x0000, TSTAT1 /* タイマ1ステータスレジスタを0クリア */
       00FF F60A       281 
0006ea 4EBA 02BC       282 		jsr	CALL_RP /* CALL_RPを呼び出す */
                       283 
                       284 COMPARE_END:
0006ee 4CDF 0001       285 		movem.l (%sp)+, %d0 /* d0復帰 */
0006f2 4E73            286 		rte
                       287 
                       288 *************************************
                       289 ** UART1_interrupt
                       290 ** 送受信割り込みを扱うインターフェース
                       291 *************************************
                       292 /* btst : 指定データの指定ビットが0であるか判断し、0であればCCRのZをセ
                       293 UART1_interrupt:
0006f4 48E7 7000       294 		movem.l %d1-%d3, -(%SP)
                       295 		/* 受信FIFOが空でないとき(URX[13]==1)受信割り込みであると判断 */
                       296 		/* URX[13] ->  0: 受信FIFOが空, 1: 受信FIFOが空でない */
0006f8 3639 00FF       297 		move.w URX1, %d3
       F904            297 
0006fe 1403            298 		move.b %d3, %d2       |  %d3.wの下位8bitを%d2.bにコピー
000700 0803 000D       299 		btst.l #13, %d3       |  13ビット目は受信FIFOにデータが存在するか
000704 6700 000C       300 		beq    CALL_INTERPUT  |  if URX1[13] == 0 (受信FIFOが空のとき)
000708 7200            301 		move.l #0, %d1        |  ch = 0 を明示
00070a 4EBA 001E       302 		jsr    INTERGET       |  受信割り込み時処理
00070e 6000 0014       303 		bra    END_interrupt
                       304 CALL_INTERPUT:
                       305 		/* 送信FIFOがに空のとき(UTX[15]==1)送信割り込みであると判断 */
                       306 		/* UTX[15] ->  0: 送信FIFOが空でない, 1: 送信FIFOが空 */
000712 0839 000F       307 		btst.l #15, UTX1      |  15ビット目は送信FIFOが空であるか
       00FF F906       307 
00071a 6700 0008       308 		beq    END_interrupt  |  if UTX1[15] == 0 (送信FIFOが空でないとき終了)
00071e 7200            309 		move.l #0, %d1        |  ch = 0 を明示
000720 4EBA 001E       310 		jsr    INTERPUT       |  送信割り込み時処理
                       311 END_interrupt:
000724 4CDF 000E       312 		movem.l (%SP)+, %d1-%d3
000728 4E73            313 		rte
                       314 
                       315 *************************************
                       316 ** INTERGET  受信割り込みルーチン	
                       317 ** 引数     :  %d1.l = チャネル(ch)	
                       318 **             %d2.b = 受信データdata
                       319 **戻り値　なし		
                       320 *************************************
                       321 INTERGET:
00072a 2F00            322 		move.l %d0, -(%SP)
00072c 0C41 0000       323 		cmp    #0, %d1       | ch = 0 であるか確認
000730 6600 000A       324 		bne    END_INTERGET
000734 7000            325 		move.l #0, %d0       | %d0 = 受信キュー
000736 1202            326 		move.b %d2, %d1      | %d1 = 受信したデータ
000738 4EBA 003E       327 		jsr    IN_Q          | %d0 <= 成功したか否か
                       328 END_INTERGET:
00073c 201F            329 		move.l (%SP)+, %d0
00073e 4E75            330 		rts
                       331 
                       332 *************************************
                       333 ** INTERPUT :  送信割り込み時の処理	
                       334 ** 引数     :  %d1.l = チャネル(ch)	
                       335 *************************************
                       336 INTERPUT:
000740 2F01            337 		move.l  %d1, -(%SP)
000742 46FC 2700       338 		move.w  #0x2700, %SR | 走行レベルを７に設定
000746 0C81 0000       339 		cmpi.l  #0, %d1      | ch = 0 を確認
       0000            339 
00074c 6600 0026       340 		bne     END_INTERPUT | if ch != 0 => 復帰
000750 7001            341                 move.l  #1, %d0
000752 4EBA 00D0       342 		jsr     OUT_Q        | %d1.b = data
000756 0C40 0000       343 		cmpi    #0, %d0      | %d0(OUTQの戻り値) == 0(失敗)
00075a 6600 000E       344 		bne     TX_DATA      | if so => 送信割り込みをマスク(真下)
00075e 33FC E108       345 		move.w  #0xe108, USTCNT1
       00FF F900       345 
000766 6000 000C       346 		bra     END_INTERPUT
                       347 TX_DATA:
00076a 0641 0800       348 		add.w   #0x0800, %d1 | ヘッダを付与
00076e 33C1 00FF       349 		move.w  %d1, UTX1
       F906            349 
                       350 END_INTERPUT:
000774 221F            351 		move.l  (%SP)+, %d1
000776 4E75            352 		rts
                       353 
                       354 ******************************
                       355 ** INQ
                       356 **入力キュー番号,d0.l 書き込むデータ,d1.b
                       357 **出力 d0,成功1, 失敗0
                       358 ******************************
                       359 IN_Q:
000778 0C00 0000       360 		cmp.b   #0x00, %d0         |受信キュー、送信キューの判別
00077c 6600 0008       361 		bne     i_loop1
000780 4EBA 000A       362 		jsr     INQ0
000784 4E75            363 		rts
                       364 i_loop1:
000786 4EBA 0050       365 		jsr     INQ1
00078a 4E75            366 		rts
                       367 INQ0:
00078c 40E7            368 		move.w  %sr, -(%sp)        |レジスタ退避
00078e 48E7 00F8       369 		movem.l %a0-%a4,-(%sp)
000792 46FC 2700       370 		move.w  #0x2700, %SR       |走行レベルを7に設定
000796 2039 0000       371 		move.l  s0, %d0            |s=256 => %d0=0:失敗
       0000            371 
00079c 0480 0000       372 		sub.l   #0x100, %d0
       0100            372 
0007a2 6700 002C       373 		beq     i0_Finish          |s=256 => 復帰
0007a6 2279 0000       374 		movea.l in0, %a1           |書き込み先アドレス=%a1
       0000            374 
0007ac 12C1            375 		move.b  %d1, (%a1)+        |データをキューへ入れる,書き込み先アドレスを更
0007ae 45F9 0000       376 		lea.l   bottom0, %a2       |次回書き込みアドレスa1<キューデータ領域の末尾ア
       0000            376 
0007b4 B3CA            377 		cmp.l   %a2, %a1
0007b6 6300 000A       378 		bls     i0_STEP1
0007ba 47F9 0000       379 		lea.l   top0, %a3          |in=top
       0000            379 
0007c0 224B            380 		move.l  %a3, %a1
                       381 i0_STEP1:
0007c2 23C9 0000       382 		move.l  %a1, in0           |in更新
       0000            382 
0007c8 52B9 0000       383 		add.l   #1, s0             |s+1
       0000            383 
0007ce 7001            384 		move.l  #1, %d0            |d0=1 =>成功
                       385 i0_Finish:
0007d0 4CDF 1F00       386 		movem.l (%sp)+, %a0-%a4    |レジスタ復帰
0007d4 46DF            387 		move.w  (%sp)+, %sr
0007d6 4E75            388 		rts                        |サブルーチン復帰
                       389 INQ1:
0007d8 40E7            390 		move.w  %sr,-(%sp)         |レジスタ退避
0007da 48E7 00F8       391 		movem.l %a0-%a4,-(%sp)
0007de 46FC 2700       392 		move.w  #0x2700, %SR       |走行レベルを7に設定
0007e2 2039 0000       393 		move.l  s1, %d0            |s=256 => %d0=0:失敗
       0000            393 
0007e8 0480 0000       394 		sub.l   #0x100, %d0
       0100            394 
0007ee 6700 002C       395 		beq     i1_Finish          |s=256 => 復帰
0007f2 2279 0000       396 		movea.l in1, %a1           |書き込み先アドレス=%a1
       0000            396 
0007f8 12C1            397 		move.b  %d1, (%a1)+        |データをキューへ入れる,書き込み先アドレスを更
0007fa 45F9 0000       398 		lea.l   bottom1, %a2       |次回書き込みアドレスa1<キューデータ領域の末尾ア
       0000            398 
000800 B3CA            399 		cmp.l   %a2, %a1
000802 6300 000A       400 		bls     i1_STEP1
000806 47F9 0000       401 		lea.l   top1, %a3          |in=top
       0000            401 
00080c 224B            402 		move.l  %a3, %a1
                       403 i1_STEP1:
00080e 23C9 0000       404 		move.l  %a1, in1           |in更新
       0000            404 
000814 52B9 0000       405 		add.l   #1, s1             |s+1
       0000            405 
00081a 7001            406 		move.l  #1, %d0            |d0=1 =>成功
                       407 i1_Finish:
00081c 4CDF 1F00       408 		movem.l (%sp)+, %a0-%a4    |レジスタ復帰
000820 46DF            409 		move.w  (%sp)+, %sr
000822 4E75            410 		rts                        |サブルーチン復帰
                       411 ******************************
                       412 ** OUTQ
                       413 **入力:キュー番号:d0.l
                       414 **出力:d0:0失敗, d0:1成功
                       415 **取り出したデータ:d1.b
                       416 ******************************
                       417 OUT_Q:
000824 0C00 0000       418 		cmp.b #0x00, %d0                |受信キュー、送信キューの判別
000828 6600 0008       419 		bne o_loop1
00082c 4EBA 000A       420 		jsr OUTQ0
000830 4E75            421 		rts
                       422 o_loop1:
000832 4EBA 0050       423 		jsr OUTQ1
000836 4E75            424 		rts
                       425 OUTQ0:
000838 40E7            426 		move.w %sr,-(%sp)               |レジスタ退避
00083a 48E7 00F8       427 		movem.l %a0-%a4,-(%sp)
00083e 46FC 2700       428 		move.w  #0x2700, %SR            |走行レベルを7に設定
000842 2039 0000       429 		move.l  s0, %d0                 |s=0 => %d0=0:失敗
       0000            429 
000848 0C80 0000       430 		cmp.l  #0x00, %d0
       0000            430 
00084e 6700 002C       431 		beq     o0_Finish               |s=0 => 復帰
000852 2279 0000       432 		movea.l out0, %a1               |取り出し先アドレス=%a1
       0000            432 
000858 1219            433 		move.b  (%a1)+, %d1             |キューからデータを取り出し(%d1),取り出し先ア
00085a 45F9 0000       434 		lea.l bottom0, %a2              |次回取り出すアドレスa1<キューデータ領域の末
       0000            434 
000860 B3CA            435 		cmp.l  %a2, %a1
000862 6300 000A       436 		bls     o0_STEP1
000866 47F9 0000       437 		lea.l top0, %a3                 |out=top
       0000            437 
00086c 224B            438 		move.l  %a3, %a1
                       439 o0_STEP1:
00086e 23C9 0000       440 		move.l %a1, out0                |out更新
       0000            440 
000874 53B9 0000       441 		sub.l #1, s0                    |s--
       0000            441 
00087a 7001            442 		move.l  #1, %d0                 |d0=1 =>成功
                       443 o0_Finish:
00087c 4CDF 1F00       444 		movem.l (%sp)+, %a0-%a4         |レジスタ復帰
000880 46DF            445 		move.w (%sp)+, %sr
000882 4E75            446 		rts                             |サブルーチン復帰
                       447 OUTQ1:
000884 40E7            448 		move.w %sr,-(%sp)
000886 48E7 00F8       449 		movem.l %a0-%a4,-(%sp)          |レジスタ退避
00088a 46FC 2700       450 		move.w  #0x2700, %SR            |走行レベルを7に設定
00088e 2039 0000       451 		move.l  s1, %d0                 |s=0 => %d0=0:失敗
       0000            451 
000894 0C80 0000       452 		cmp.l #0x00, %d0
       0000            452 
00089a 6700 002C       453 		beq     o1_Finish               |s=0 => 復帰
00089e 2279 0000       454 		movea.l out1, %a1               |取り出し先アドレス=%a1
       0000            454 
0008a4 1219            455 		move.b  (%a1)+, %d1             |キューからデータを取り出し(%d1),取り出し先ア
0008a6 45F9 0000       456 		lea.l bottom1, %a2              |次回取り出すアドレスa1<キューデータ領域の末
       0000            456 
0008ac B3CA            457 		cmp.l  %a2, %a1
0008ae 6300 000A       458 		bls     o1_STEP1
0008b2 47F9 0000       459 		lea.l top1, %a3                 |out=top
       0000            459 
0008b8 224B            460 		move.l  %a3, %a1
                       461 o1_STEP1:
0008ba 23C9 0000       462 		move.l %a1, out1                |out更新
       0000            462 
0008c0 53B9 0000       463 		sub.l #1, s1                    |s--
       0000            463 
0008c6 7001            464 		move.l  #1, %d0                 |d0=1 =>成功
                       465 o1_Finish:
0008c8 4CDF 1F00       466 		movem.l (%sp)+, %a0-%a4         |レジスタ復帰
0008cc 46DF            467 		move.w (%sp)+, %sr
0008ce 4E75            468 		rts                             |サブルーチン復帰
                       469 
                       470 *************************************
                       471 ** PUTSTRING  送信割り込みの処理	
                       472 ** 引数     :  %d1.l = チャネル(ch)	
                       473 **             %d2.l = データ読み込み先の先頭アドレスp いったんa6にさせて
                       474 **             %d3.l = 送信するデータ数size
                       475 ** 出力     :  %d0.l = 取り出した要素数
                       476 *************************************
                       477 PUTSTRING:
0008d0 0C41 0000       478 		cmp    #0, %d1         | ch = 0 であるか確認
0008d4 6600 003A       479 		bne    END_PUTSTRING   | そうでなければ復帰
0008d8 383C 0000       480 		move.w #0, %d4         | sz = 0 (取った要素数)
0008dc 2A42            481 		move.l  %d2, %a5       | i  = %d2 = 読み込み先 address
0008de 0C43 0000       482 		cmp    #0, %d3         | 取り出すべきサイズが０であるか確認
0008e2 6700 002A       483 		beq    END2_PUTSTRING  | 0であれば復帰
                       484 LOOP1_PUTSTRING:
0008e6 B644            485 		cmp    %d4, %d3        | 取るべき要素数と取った要素数を比較
0008e8 6700 001C       486 		beq    END3_PUTSTRING  | 同等であれば復帰
0008ec 103C 0001       487 		move.b #1, %d0         | %d0 = 1 (キューの番号：送信キュー)
0008f0 1215            488 		move.b (%a5), %d1      | %d1 = 読み込んだ値
0008f2 4EBA FE84       489 		jsr    IN_Q
0008f6 0C40 0000       490 		cmp    #0, %d0         | IN_Qの復帰値が成功（１）であるか確認
0008fa 6700 000A       491                 beq    END3_PUTSTRING  | 失敗ならば復帰
0008fe 5244            492 		add    #1, %d4         | sz ++ 
000900 524D            493 		add    #1, %a5         | i  ++ 
000902 6000 FFE2       494 		bra    LOOP1_PUTSTRING 
                       495 END3_PUTSTRING:
                       496                 
000906 33FC E10C       497 		move.w #0xe10c, USTCNT1 | 送信割り込みを許可（アンマスク）
       00FF F900       497 
                       498 END2_PUTSTRING:
00090e 3004            499 		move   %d4, %d0         | 返り値　%d0 = sz (取った要素数)
                       500 END_PUTSTRING:
000910 4E75            501 		rts
                       502 
                       503 
                       504 		
                       505 *************************************
                       506 ** GETSTRING  受信割り込みの処理	
                       507 ** 引数     :  %d1.l = チャネル(ch)
                       508 ** 	       %d2.l = データ書き込み先の先頭アドレスp
                       509 **             %d3.l = 取り出すデータ数size
                       510 ** 出力     :　%d0.l = 実際に取り出したデータ数		
                       511 *************************************
                       512 GETSTRING:
000912 0C41 0000       513 		cmp    #0, %d1           | ch = 0 であるか確認
000916 6600 0026       514 		bne    END_GETSTRING     | そうでなければ復帰
00091a 383C 0000       515 		move.w #0, %d4           | sz = 0 (取った要素数)
00091e 2A42            516 		move.l %d2, %a5          | i  = %d2 = 書き込み先 address
                       517 LOOP1_GETSTRING:	
000920 B644            518 		cmp    %d4, %d3          | 取るべき要素数と取り出した要素数を比較
000922 6700 0018       519 		beq    END2_GETSTRING    | 同等であれば復帰
000926 7000            520 		move.l #0, %d0           | %d0 = 0 (キューの番号：受信キュー)
000928 4EBA FEFA       521 		jsr    OUT_Q             | OUT_Q ==> %d0: success?, %d1: 取り出したデータ
00092c 0C40 0000       522 		cmp    #0, %d0           | OUT_Qの復帰値が成功(1)であるか確認 
000930 6700 000A       523 		beq    END2_GETSTRING    | 失敗ならば復帰
000934 1AC1            524 		move.b %d1, (%a5)+       | 書き込み先にデータを書き込み
000936 5244            525 		add    #1, %d4           | sz ++
000938 6000 FFE6       526 		bra    LOOP1_GETSTRING
                       527 END2_GETSTRING:
00093c 3004            528 		move   %d4, %d0          | 返り値 %d0 = sz (実際に取り出したデータ数)
                       529 END_GETSTRING:
00093e 4E75            530 		rts
                       531 
                       532 ******************************
                       533 ** RESET_TIMER():	タイマ割り込み→不可、タイマ→停止
                       534 ******************************
                       535 RESET_TIMER:
000940 33FC 0004       536 		move.w	#0x0004, TCTL1 /* タイマ1コントロールレジスタに0x0004を設定→割り込
       00FF F600       536 
000948 4E75            537 		rts
                       538 		
                       539 ******************************
                       540 ** SET_TIMER(t,p):	タイマ割り込み時に呼び出すルーチン設定 
                       541 **			タイマ割り込み周期tを設定（t * 0.1 msec毎に割り込み発生）
                       542 **			タイマ使用およびタイマ割り込み	
                       543 ** 引数 :		t→%d1.w:	タイマの発生周期
                       544 ** 			p→%d2.l	割り込み時に起動するルーチンの先頭アドレス			
                       545 ******************************
                       546 SET_TIMER:
00094a 23C2 0000       547 		move.l	%d2, task_p /* 割り込み時に起動するルーチンの先頭アドレスpを大域
       0000            547 
000950 33FC 0086       548 		move.w	#0206, TPRER1 /* 0.1msec進むとカウンタが1増えるようにする */
       00FF F602       548 
000958 33C1 00FF       549 		move.w	%d1, TCMP1 /* t秒周期に設定 */
       F604            549 
00095e 33FC 0015       550 		move.w  #0x0015, TCTL1 /* タイマ1コントロールレジスタに0x0015を設定→割り込
       00FF F600       550 
000966 13FC 004D       551 		move.b	#'M', LED7
       00D0 002F       551 
00096e 13FC 004D       552 		move.b	#'M', LED6
       00D0 002D       552 
000976 13FC 003A       553 		move.b  #':', LED5
       00D0 002B       553 
00097e 13FC 0053       554 		move.b	#'S', LED4
       00D0 0029       554 
000986 13FC 0053       555 		move.b	#'S', LED3
       00D0 003F       555 
00098e 13FC 002E       556 		move.b	#'.', LED2
       00D0 003D       556 
000996 13FC 0066       557 		move.b	#'f', LED1
       00D0 003B       557 
00099e 13FC 0066       558 		move.b	#'f', LED0
       00D0 0039       558 
0009a6 4E75            559 		rts
                       560 
                       561 ******************************
                       562 ** CALL_RP():	タイマ割り込み時に処理すべきルーチン呼び出し
                       563 ******************************
                       564 CALL_RP:
0009a8 48E7 0080       565 		movem.l	%a0, -(%sp)
0009ac 2079 0000       566 		movea.l task_p, %a0
       0000            566 
0009b2 4E90            567 		jsr (%a0)
0009b4 4CDF 0100       568 		movem.l (%sp)+, %a0
0009b8 4E75            569 		rts
                       570 
                       571 *******************************************
                       572 ** システムコールインターフェース
                       573 ** 入力：
                       574 **　　　　システムコール番号   : %d0.l
                       575 **　　　　システムコールの引数 : %d1以降
                       576 ** 出力：
                       577 **　　　　システムコール呼び出しの結果 : %d0.l
                       578 ** ========================================		
                       579 **        +---+---------------+
                       580 **        | 1 | GETSTRING     |
                       581 **        | 2 | PUTSTRING     |
                       582 **        | 3 | RESET_TIMER   |
                       583 **        | 4 | SET_TIMER     |
                       584 **        +---+---------------+
                       585 *******************************************
                       586 SYS_CALL:
                       587 		
                       588 CALL_1:		
0009ba 0C80 0000       589 		cmpi.l #1, %d0   | コール番号の確認(no.1)
       0001            589 
0009c0 6600 000A       590 		bne    CALL_2    | 異なれば他のコール番号の確認
0009c4 4EBA FF4C       591 		jsr    GETSTRING | 対応するシステムコールを呼び出し
0009c8 6000 0034       592                 bra    END_SYS_CALL
                       593 CALL_2:
0009cc 0C80 0000       594 		cmpi.l #2, %d0
       0002            594 
0009d2 6600 000A       595 		bne    CALL_3
0009d6 4EBA FEF8       596 		jsr    PUTSTRING
0009da 6000 0022       597                 bra    END_SYS_CALL
                       598 CALL_3:
0009de 0C80 0000       599 		cmpi.l #3, %d0
       0003            599 
0009e4 6600 000A       600 		bne    CALL_4
0009e8 4EBA FF56       601 		jsr    RESET_TIMER
0009ec 6000 0010       602                 bra    END_SYS_CALL
                       603 CALL_4:
0009f0 0C80 0000       604 		cmpi.l #4, %d0
       0004            604 
0009f6 6600 0006       605 		bne    END_SYS_CALL
0009fa 4EBA FF4E       606 		jsr    SET_TIMER
                       607 END_SYS_CALL:	
0009fe 4E73            608 		rte		
                       609 ***************************************************************
                       610 ** スタック領域の確保
                       611 ***************************************************************
                       612 .section .bss
                       613 .even
                       614 SYS_STK:
000c34 0000 0000       615 		.ds.b  0x4000 | システムスタック領域
       0000 0000       615 
       0000 0000       615 
       0000 0000       615 
       0000 0000       615 
                       616 		.even
                       617 SYS_STK_TOP: 		      | システムスタック領域の最後尾
                       618 
004c34 0000 0000       619 task_p:		.ds.l 1	      | タイマ割り込み時に起動するルーチン先頭アドレス代
                       620 ****************************************************************
                       621 ***初期値のあるデータ領域***************************************************************
                       622 .section .data
                       623 TMSG:
000a00 2A2A 2A2A       624 		.ascii  "******\r\n"      | \r:行頭へ(キャリッジリターン)
       2A2A 0D0A       624 
                       625 		.even                     | \n:次の行へ(ラインフィード)
                       626 BACK:
000a08 0D              627 		.ascii  "\r"
000a09 00              628 		.even               
                       629 TTC:
000a0a 0000            630 		.dc.w  0
                       631 		.even
                       632 MM2:
000a0c 00              633 		.dc.b  0
000a0d 00              634 		.even
                       635 MM1:
000a0e 00              636 		.dc.b  0
000a0f 00              637 		.even
                       638 COLON:
000a10 2E              639 		.dc.b  0x2e
000a11 00              640 		.even
                       641 SS2:
000a12 00              642 		.dc.b  0
000a13 00              643 		.even
                       644 SS1:
000a14 00              645 		.dc.b  0
000a15 00              646 		.even
                       647 PERIOD:
000a16 3A              648 		.dc.b  0x3a
000a17 00              649 		.even
                       650 CS2:
000a18 00              651 		.dc.b  0
000a19 00              652 		.even
                       653 CS1:
000a1a 00              654 		.dc.b  0
000a1b 00              655 		.even
                       656 
                       657 ****************************************************************
                       658 ***初期値の無いデータ領域***************************************************************
                       659 .section .bss
                       660 BUF:
004c38 0000 0000       661 		.ds.b 256      |BUF[256]
       0000 0000       661 
       0000 0000       661 
       0000 0000       661 
       0000 0000       661 
                       662 		.even
                       663 MMSSFF:
004d38 0000 0000       664 		.ds.b 8      |BUF[256]
       0000 0000       664 
                       665 		.even
                       666 USR_STK:
004d40 0000 0000       667 		.ds.b 0x4000   |ユーザスタック領域
       0000 0000       667 
       0000 0000       667 
       0000 0000       667 
       0000 0000       667 
                       668 		.even
                       669 USR_STK_TOP:                   |ユーザスタック領域の最後尾		
                       670 
                       671 
                       672 ******************************
                       673 ** キュー用のメモリ領域確保
                       674 ******************************
                       675 .section .data
                       676 		.equ  B_SIZE, 256
                       677 top0:
000a1c 0000 0000       678 		.ds.b B_SIZE-1
       0000 0000       678 
       0000 0000       678 
       0000 0000       678 
       0000 0000       678 
                       679 bottom0:
000b1b 00              680 		.ds.b 1
                       681 top1:
000b1c 0000 0000       682 		.ds.b B_SIZE-1
       0000 0000       682 
       0000 0000       682 
       0000 0000       682 
       0000 0000       682 
                       683 bottom1:
000c1b 00              684 		.ds.b 1
                       685 out0:
000c1c 0000 0000       686 		.ds.l 1
                       687 out1:
000c20 0000 0000       688 		.ds.l 1
                       689 in0:
000c24 0000 0000       690 		.ds.l 1
                       691 in1:
000c28 0000 0000       692 		.ds.l 1
                       693 s0:
000c2c 0000 0000       694 		.ds.l 1
                       695 s1:
000c30 0000 0000       696 		.ds.l 1
                       697 
                       698 .end
