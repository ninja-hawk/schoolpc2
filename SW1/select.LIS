                         4 .list
                         5 ***************************************************************
                         6 ** 各種レジスタ定義
                         7 ***************************************************************
                         8 
                         9 ***************
                        10 ** レジスタ群の先頭
                        11 ***************
                        12 .equ REGBASE, 0xFFF000  | DMAP を使用.
                        13 .equ IOBASE,  0x00d00000
                        14 
                        15 ***************
                        16 ** 割り込み関係のレジスタ
                        17 ***************
                        18 .equ IVR,     REGBASE+0x300 | 割り込みベクタレジスタ
                        19 .equ IMR,     REGBASE+0x304 | 割り込みマスクレジスタ
                        20 .equ ISR,     REGBASE+0x30c | 割り込みステータスレジスタ
                        21 .equ IPR,     REGBASE+0x310 | 割り込みペンディングレジスタ
                        22 
                        23 
                        24 ***************
                        25 ** タイマ関係のレジスタ
                        26 ***************
                        27 .equ TCTL1,   REGBASE+0x600 | タイマ1コントロールレジスタ
                        28 .equ TPRER1,  REGBASE+0x602 | タイマ1プリスケーラレジスタ
                        29 .equ TCMP1,   REGBASE+0x604 | タイマ1コンペアレジスタ
                        30 .equ TCN1,    REGBASE+0x608 | タイマ1カウンタレジスタ
                        31 .equ TSTAT1,  REGBASE+0x60a | タイマ1ステータスレジスタ
                        32 ***************
                        33 ** UART1 (送受信)関係のレジスタ
                        34 ***************
                        35 .equ USTCNT1, REGBASE+0x900 | UART1 ステータス / コントロールレジスタ
                        36 .equ UBAUD1,  REGBASE+0x902 | UART1 ボーコントロールレジスタ
                        37 .equ URX1,    REGBASE+0x904 | UART1 受信レジスタ
                        38 .equ UTX1,    REGBASE+0x906 | UART1 送信レジスタ
                        39 ***************
                        40 ** LED
                        41 ***************
                        42 .equ LED7,  IOBASE+0x000002f | ボード搭載のLED用レジスタ
                        43 .equ LED6,  IOBASE+0x000002d | 使用法については付録 A.4.3.1
                        44 .equ LED5,  IOBASE+0x000002b
                        45 .equ LED4,  IOBASE+0x0000029
                        46 .equ LED3,  IOBASE+0x000003f
                        47 .equ LED2,  IOBASE+0x000003d
                        48 .equ LED1,  IOBASE+0x000003b
                        49 .equ LED0,  IOBASE+0x0000039
                        50 
                        51 **************
                        52 **システムコール番号
                        53 **************
                        54 .equ SYSCALL_NUM_GETSTRING,    1
                        55 .equ SYSCALL_NUM_PUTSTRING,    2
                        56 .equ SYSCALL_NUM_RESET_TIMER,  3
                        57 .equ SYSCALL_NUM_SET_TIMER,    4
                        58 
                        59 ***************************************************************
                        60 ** 初期化
                        61 ***************************************************************
                        62 .section .text
                        63 .even
                        64 boot:
                        65 		* スーパーバイザ & 各種設定を行っている最中の割込禁止
000400 46FC 2000        66 		move.w #0x2000,%SR
000404 4FF9 0000        67 		lea.l SYS_STK_TOP, %SP | Set SSP
       0000             67 
                        68 		****************
                        69 		** 割り込みコントローラの初期化
                        70 		****************
00040a 13FC 0040        71 		move.b #0x40, IVR      | ユーザ割り込みベクタ番号を
       00FF F300        71 
                        72 		                       | 0x40+level に設定.
000412 23FC 00FF        73 		move.l #0x00ff3ff9,IMR | 全割り込みマスクMUART=>0,MTMR1=>1
       3FF9 00FF        73 
       F304             73 
                        74 		****************
                        75 		** 送受信 (UART1) 関係の初期化 ( 割り込みレベルは 4 に固定されている )
                        76 		****************
00041c 21FC 0000        77 		move.l #UART1_interrupt, 0x110  | 受信割り込みベクタをセット
       0000 0110        77 
000424 33FC 0000        78 		move.w #0x0000, USTCNT1 | リセット
       00FF F900        78 
00042c 33FC E108        79 		move.w #0xe108, USTCNT1 | 送受信可能 , パリティなし , 1 stop, 8 bit,
       00FF F900        79 
                        80 					| 受信割り込み許可, 送信割り込み禁止
000434 33FC 0038        81 		move.w #0x0038, UBAUD1  | baud rate = 230400 bps
       00FF F902        81 
                        82 		****************
                        83 		** タイマ関係の初期化 ( 割り込みレベルは 6 に固定されている )
                        84 		*****************
00043c 33FC 0004        85 		move.w #0x0004, TCTL1   | restart, 割り込み不可 ,
       00FF F600        85 
                        86 					| システムクロックの 1/16 を単位として計時,
                        87 					| タイマ使用停止
000444 21FC 0000        88 		move.l #COMPARE_INTERPUT, 0x118 /* level 6 */
       0000 0118        88 
                        89 
00044c 21FC 0000        90                 move.l #SYS_CALL, 0x080 /*SYS_CALLの割り込みベクタ設定*/
       0000 0080        90 
                        91 		******************************
                        92 		** キューの初期化
                        93 		******************************
000454 45F9 0000        94 		lea.l  top0, %a2
       0000             94 
00045a 47F9 0000        95 		lea.l  top1, %a3
       0000             95 
000460 23CA 0000        96 		move.l %a2, out0
       0000             96 
000466 23CB 0000        97 		move.l %a3, out1
       0000             97 
00046c 23CA 0000        98 		move.l %a2, in0
       0000             98 
000472 23CB 0000        99 		move.l %a3, in1
       0000             99 
000478 23FC 0000       100 		move.l #0, s0
       0000 0000       100 
       0000            100 
000482 23FC 0000       101 		move.l #0, s1
       0000 0000       101 
       0000            101 
                       102 	
00048c 6000 0002       103 		bra MAIN
                       104 	
                       105 ****************************************************************
                       106 ***プログラム領域
                       107 ****************************************************************
                       108 MAIN:
                       109 		**走行モードとレベルの設定(「ユーザモード」への移行処理)
000490 46FC 0000       110 		move.w #0x0000, %SR    | USER MODE, LEVEL 0
000494 4FF9 0000       111 		lea.l  USR_STK_TOP,%SP | user stackの設定
       0000            111 
                       112 		**システムコールによるRESET_TIMERの起動
00049a 7003            113 		move.l #SYSCALL_NUM_RESET_TIMER, %D0
00049c 4E40            114 		trap   #0
                       115 		**システムコールによるSET_TIMERの起動
00049e 7004            116 		move.l #SYSCALL_NUM_SET_TIMER, %D0
0004a0 323C 0064       117 		move.w #100, %D1
0004a4 243C 0000       118 		move.l #SELECT,%D2
       0000            118 
0004aa 4E40            119 		trap   #0
                       120 		
                       121 ******************************
                       122 * sys_GETSTRING, sys_PUTSTRINGのテスト
                       123 *ターミナルの入力をエコーバックする
                       124 ******************************
                       125 LOOP:
0004ac 6000 FFFE       126 		bra    LOOP
                       127 		
                       128 ******************************
                       129 ** 選択課題ゾーン
                       130 ******************************
                       131 SELECT:
0004b0 48E7 FFFE       132 		movem.l %D0-%D7/%A0-%A6,-(%SP)
0004b4 0C39 003A       133 		cmpi.b #0x3a,CS1            | CS1カウンタで10回実行したかどうか数える
       0000 0000       133 
0004bc 6700 00E4       134 		beq    CS1KILL
                       135 SECOND:
0004c0 0C39 003A       136 		cmpi.b #0x3a,CS2            | CS2カウンタで6回実行したかどうか数える
       0000 0000       136 
0004c8 6700 00EA       137 		beq    CS2KILL
                       138 TENSECOND:
0004cc 0C39 003A       139 		cmpi.b #0x3a,SS1            | SS1カウンタで10回実行したかどうか数える
       0000 0000       139 
0004d4 6700 00F0       140 		beq    SS1KILL		
                       141 MINUTE:
0004d8 0C39 0036       142 		cmpi.b #0x36,SS2            | SS2カウンタで6回実行したかどうか数える
       0000 0000       142 
0004e0 6700 00F6       143 		beq    SS2KILL
                       144 TENMINUTE:
0004e4 0C39 003A       145 		cmpi.b #0x3a,MM1            | MM1カウンタで10回実行したかどうか数える
       0000 0000       145 
0004ec 6700 00FC       146 		beq    MM1KILL		
                       147 ENDCLOCK:
0004f0 0C39 0036       148 		cmpi.b #0x36,MM2            | MM2カウンタで10回実行したかどうか数える
       0000 0000       148 
0004f8 6700 0102       149 		beq    MM2KILL	
                       150 
                       151 COUNT:
0004fc 7002            152 		move.l #SYSCALL_NUM_PUTSTRING,%D0
0004fe 7200            153 		move.l #0,    %D1        | ch = 0
000500 243C 0000       154 		move.l #BACK, %D2        | p  = #BACK
       0000            154 
000506 7608            155 		move.l #8,    %D3        | size = 8
000508 4E40            156 		trap   #0
                       157 
00050a 41F9 0000       158 		lea.l  MMSSFF, %a0
       0000            158 
000510 10F9 0000       159 		move.b MM2, (%a0)+
       0000            159 
000516 10F9 0000       160 		move.b MM1, (%a0)+
       0000            160 
00051c 10F9 0000       161 		move.b COLON, (%a0)+
       0000            161 
000522 10F9 0000       162 		move.b SS2, (%a0)+
       0000            162 
000528 10F9 0000       163 		move.b SS1, (%a0)+
       0000            163 
00052e 10F9 0000       164 		move.b PERIOD, (%a0)+
       0000            164 
000534 10F9 0000       165 		move.b CS2, (%a0)+
       0000            165 
00053a 10B9 0000       166 		move.b CS1, (%a0)
       0000            166 
                       167 
000540 7002            168 		move.l #SYSCALL_NUM_PUTSTRING,%D0
000542 7200            169 		move.l #0,    %D1        | ch = 0
000544 243C 0000       170 		move.l #MMSSFF,  %D2      | p  = #MMSSFF
       0000            170 
00054a 7608            171 		move.l #8,    %D3        | size = 8
00054c 4E40            172 		trap   #0
                       173 		/* c秒 */
00054e 1E39 0000       174 		move.b CS1, %d7
       0000            174 
000554 13C7 00D0       175 		move.b %d7, LED0
       0039            175 
                       176 		/* 10c秒 */
00055a 1E39 0000       177 		move.b CS2, %d7
       0000            177 
000560 13C7 00D0       178 		move.b %d7, LED1
       003B            178 
                       179 		/* 秒 */
000566 1E39 0000       180 		move.b SS1, %d7
       0000            180 
00056c 13C7 00D0       181 		move.b %d7, LED3
       003F            181 
                       182 		/* 10秒 */
000572 1E39 0000       183 		move.b SS2, %d7
       0000            183 
000578 13C7 00D0       184 		move.b %d7, LED4
       0029            184 
                       185 		/* 分 */
00057e 1E39 0000       186 		move.b MM1, %d7
       0000            186 
000584 13C7 00D0       187 		move.b %d7, LED6
       002D            187 
                       188 		/* 10分 */
00058a 1E39 0000       189 		move.b MM2, %d7
       0000            189 
000590 13C7 00D0       190 		move.b %d7, LED7
       002F            190 
                       191 		/* カウントアップ */
000596 0639 0001       192 		addi.b #1,CS1           | SS1カウンタを1つ増やして
       0000 0000       192 
00059e 6000 00D0       193 		bra    SELECTEND         |そのまま戻る
                       194 CS1KILL:
0005a2 13FC 0030       195 		move.b #0x30, CS1
       0000 0000       195 
0005aa 5239 0000       196 		add.b  #0x01, CS2
       0000            196 
0005b0 6000 FF0E       197 		bra    SECOND
                       198 CS2KILL:
0005b4 13FC 0030       199 		move.b #0x30, CS2
       0000 0000       199 
0005bc 5239 0000       200 		add.b  #0x01, SS1
       0000            200 
0005c2 6000 FF08       201 		bra    TENSECOND
                       202 SS1KILL:
0005c6 13FC 0030       203 		move.b #0x30, SS1
       0000 0000       203 
0005ce 5239 0000       204 		add.b  #0x01, SS2
       0000            204 
0005d4 6000 FF02       205 		bra    MINUTE
                       206 SS2KILL:
0005d8 13FC 0030       207 		move.b #0x30, SS2
       0000 0000       207 
0005e0 5239 0000       208 		add.b  #0x01, MM1
       0000            208 
0005e6 6000 FEFC       209 		bra    TENMINUTE
                       210 MM1KILL:
0005ea 13FC 0030       211 		move.b #0x30, MM1
       0000 0000       211 
0005f2 5239 0000       212 		add.b  #0x01, MM2
       0000            212 
0005f8 6000 FEF6       213 		bra    ENDCLOCK
                       214 MM2KILL:
0005fc 13FC 0030       215 		move.b #0x30, CS1
       0000 0000       215 
000604 13FC 0030       216 		move.b #0x30, CS1
       0000 0000       216 
00060c 13FC 0030       217 		move.b #0x30, SS1
       0000 0000       217 
000614 13FC 0030       218 		move.b #0x30, SS1
       0000 0000       218 
00061c 13FC 0030       219 		move.b #0x30, MM1
       0000 0000       219 
000624 13FC 0030       220 		move.b #0x30, MM2
       0000 0000       220 
00062c 13FC 004D       221 		move.b	#'M', LED7
       00D0 002F       221 
000634 13FC 004D       222 		move.b	#'M', LED6
       00D0 002D       222 
00063c 13FC 003A       223 		move.b  #':', LED5
       00D0 002B       223 
000644 13FC 0053       224 		move.b	#'S', LED4
       00D0 0029       224 
00064c 13FC 0053       225 		move.b	#'S', LED3
       00D0 003F       225 
000654 13FC 002E       226 		move.b	#'.', LED2
       00D0 003D       226 
00065c 13FC 0066       227 		move.b	#'f', LED1
       00D0 003B       227 
000664 13FC 0066       228 		move.b	#'f', LED0
       00D0 0039       228 
00066c 7003            229 		move.l #SYSCALL_NUM_RESET_TIMER,%D0
00066e 4E40            230 		trap   #0		
                       231 
                       232 SELECTEND:
000670 4CDF 7FFF       233 		movem.l (%SP)+,%D0-%D7/%A0-%A6
000674 4E75            234 		rts
                       235 
                       236 RAP:
000676 48E7 FFFE       237 		movem.l %D0-%D7/%A0-%A6,-(%SP)
00067a 7002            238 		move.l #SYSCALL_NUM_PUTSTRING,%D0
00067c 7200            239 		move.l #0,    %D1        | ch = 0
00067e 243C 0000       240 		move.l #TMSG,  %D2      | p  = #TMSg
       0000            240 
000684 7608            241 		move.l #8,    %D3        | size = 8
000686 4E40            242 		trap   #0
000688 4CDF 7FFF       243 		movem.l (%SP)+,%D0-%D7/%A0-%A6
00068c 4E73            244 		rte
                       245 
                       246 ******************************
                       247 *タイマのテスト
                       248 * ’******’を表示し改行する．
                       249 *５回実行すると，RESET_TIMERをする．
                       250 ******************************
                       251 TT:
00068e 48E7 FFFE       252 		movem.l %D0-%D7/%A0-%A6,-(%SP)
000692 0C79 0005       253 		cmpi.w #5,TTC            | TTCカウンタで5回実行したかどうか数える
       0000 0000       253 
00069a 6700 001C       254 		beq    TTKILL            | 5回実行したら，タイマを止める
00069e 7002            255 		move.l #SYSCALL_NUM_PUTSTRING,%D0
0006a0 7200            256 		move.l #0,    %D1        | ch = 0
0006a2 243C 0000       257 		move.l #TMSG, %D2        | p  = #TMSG
       0000            257 
0006a8 7608            258 		move.l #8,    %D3        | size = 8
0006aa 4E40            259 		trap   #0
0006ac 0679 0001       260 		addi.w #1,TTC            | TTCカウンタを1つ増やして
       0000 0000       260 
0006b4 6000 0006       261 		bra    TTEND             |そのまま戻る
                       262 TTKILL:
0006b8 7003            263 		move.l #SYSCALL_NUM_RESET_TIMER,%D0
0006ba 4E40            264 		trap   #0
                       265 TTEND:
0006bc 4CDF 7FFF       266 		movem.l (%SP)+,%D0-%D7/%A0-%A6
0006c0 4E75            267 		rts
                       268 
                       269 ******************************
                       270 ** COMPARE_INTERPUT:	タイマ用のハードウェア割り込みインターフェース
                       271 ******************************
                       272 COMPARE_INTERPUT:
0006c2 48E7 8000       273 		movem.l %d0, -(%sp) /* d0退避 */
0006c6 3039 00FF       274 		move.w  TSTAT1, %d0 /* TSTATの値をd0へ */
       F60A            274 
0006cc 0800 0000       275 		btst	#0, %d0 /* タイマ1ステータスレジスタの0ビット目が0か、否か */
0006d0 6700 000E       276 		beq	COMPARE_END /* 0ならコンペアイベントなし、つまりカウンタ値とコンペ
0006d4 33FC 0000       277 		move.w	#0x0000, TSTAT1 /* タイマ1ステータスレジスタを0クリア */
       00FF F60A       277 
0006dc 4EBA 02BC       278 		jsr	CALL_RP /* CALL_RPを呼び出す */
                       279 
                       280 COMPARE_END:
0006e0 4CDF 0001       281 		movem.l (%sp)+, %d0 /* d0復帰 */
0006e4 4E73            282 		rte
                       283 
                       284 *************************************
                       285 ** UART1_interrupt
                       286 ** 送受信割り込みを扱うインターフェース
                       287 *************************************
                       288 /* btst : 指定データの指定ビットが0であるか判断し、0であればCCRのZをセ
                       289 UART1_interrupt:
0006e6 48E7 7000       290 		movem.l %d1-%d3, -(%SP)
                       291 		/* 受信FIFOが空でないとき(URX[13]==1)受信割り込みであると判断 */
                       292 		/* URX[13] ->  0: 受信FIFOが空, 1: 受信FIFOが空でない */
0006ea 3639 00FF       293 		move.w URX1, %d3
       F904            293 
0006f0 1403            294 		move.b %d3, %d2       |  %d3.wの下位8bitを%d2.bにコピー
0006f2 0803 000D       295 		btst.l #13, %d3       |  13ビット目は受信FIFOにデータが存在するか
0006f6 6700 000C       296 		beq    CALL_INTERPUT  |  if URX1[13] == 0 (受信FIFOが空のとき)
0006fa 7200            297 		move.l #0, %d1        |  ch = 0 を明示
0006fc 4EBA 001E       298 		jsr    INTERGET       |  受信割り込み時処理
000700 6000 0014       299 		bra    END_interrupt
                       300 CALL_INTERPUT:
                       301 		/* 送信FIFOがに空のとき(UTX[15]==1)送信割り込みであると判断 */
                       302 		/* UTX[15] ->  0: 送信FIFOが空でない, 1: 送信FIFOが空 */
000704 0839 000F       303 		btst.l #15, UTX1      |  15ビット目は送信FIFOが空であるか
       00FF F906       303 
00070c 6700 0008       304 		beq    END_interrupt  |  if UTX1[15] == 0 (送信FIFOが空でないとき終了)
000710 7200            305 		move.l #0, %d1        |  ch = 0 を明示
000712 4EBA 001E       306 		jsr    INTERPUT       |  送信割り込み時処理
                       307 END_interrupt:
000716 4CDF 000E       308 		movem.l (%SP)+, %d1-%d3
00071a 4E73            309 		rte
                       310 
                       311 *************************************
                       312 ** INTERGET  受信割り込みルーチン	
                       313 ** 引数     :  %d1.l = チャネル(ch)	
                       314 **             %d2.b = 受信データdata
                       315 **戻り値　なし		
                       316 *************************************
                       317 INTERGET:
00071c 2F00            318 		move.l %d0, -(%SP)
00071e 0C41 0000       319 		cmp    #0, %d1       | ch = 0 であるか確認
000722 6600 000A       320 		bne    END_INTERGET
000726 7000            321 		move.l #0, %d0       | %d0 = 受信キュー
000728 1202            322 		move.b %d2, %d1      | %d1 = 受信したデータ
00072a 4EBA 003E       323 		jsr    IN_Q          | %d0 <= 成功したか否か
                       324 END_INTERGET:
00072e 201F            325 		move.l (%SP)+, %d0
000730 4E75            326 		rts
                       327 
                       328 *************************************
                       329 ** INTERPUT :  送信割り込み時の処理	
                       330 ** 引数     :  %d1.l = チャネル(ch)	
                       331 *************************************
                       332 INTERPUT:
000732 2F01            333 		move.l  %d1, -(%SP)
000734 46FC 2700       334 		move.w  #0x2700, %SR | 走行レベルを７に設定
000738 0C81 0000       335 		cmpi.l  #0, %d1      | ch = 0 を確認
       0000            335 
00073e 6600 0026       336 		bne     END_INTERPUT | if ch != 0 => 復帰
000742 7001            337                 move.l  #1, %d0
000744 4EBA 00D0       338 		jsr     OUT_Q        | %d1.b = data
000748 0C40 0000       339 		cmpi    #0, %d0      | %d0(OUTQの戻り値) == 0(失敗)
00074c 6600 000E       340 		bne     TX_DATA      | if so => 送信割り込みをマスク(真下)
000750 33FC E108       341 		move.w  #0xe108, USTCNT1
       00FF F900       341 
000758 6000 000C       342 		bra     END_INTERPUT
                       343 TX_DATA:
00075c 0641 0800       344 		add.w   #0x0800, %d1 | ヘッダを付与
000760 33C1 00FF       345 		move.w  %d1, UTX1
       F906            345 
                       346 END_INTERPUT:
000766 221F            347 		move.l  (%SP)+, %d1
000768 4E75            348 		rts
                       349 
                       350 ******************************
                       351 ** INQ
                       352 **入力キュー番号,d0.l 書き込むデータ,d1.b
                       353 **出力 d0,成功1, 失敗0
                       354 ******************************
                       355 IN_Q:
00076a 0C00 0000       356 		cmp.b   #0x00, %d0         |受信キュー、送信キューの判別
00076e 6600 0008       357 		bne     i_loop1
000772 4EBA 000A       358 		jsr     INQ0
000776 4E75            359 		rts
                       360 i_loop1:
000778 4EBA 0050       361 		jsr     INQ1
00077c 4E75            362 		rts
                       363 INQ0:
00077e 40E7            364 		move.w  %sr, -(%sp)        |レジスタ退避
000780 48E7 00F8       365 		movem.l %a0-%a4,-(%sp)
000784 46FC 2700       366 		move.w  #0x2700, %SR       |走行レベルを7に設定
000788 2039 0000       367 		move.l  s0, %d0            |s=256 => %d0=0:失敗
       0000            367 
00078e 0480 0000       368 		sub.l   #0x100, %d0
       0100            368 
000794 6700 002C       369 		beq     i0_Finish          |s=256 => 復帰
000798 2279 0000       370 		movea.l in0, %a1           |書き込み先アドレス=%a1
       0000            370 
00079e 12C1            371 		move.b  %d1, (%a1)+        |データをキューへ入れる,書き込み先アドレスを更
0007a0 45F9 0000       372 		lea.l   bottom0, %a2       |次回書き込みアドレスa1<キューデータ領域の末尾ア
       0000            372 
0007a6 B3CA            373 		cmp.l   %a2, %a1
0007a8 6300 000A       374 		bls     i0_STEP1
0007ac 47F9 0000       375 		lea.l   top0, %a3          |in=top
       0000            375 
0007b2 224B            376 		move.l  %a3, %a1
                       377 i0_STEP1:
0007b4 23C9 0000       378 		move.l  %a1, in0           |in更新
       0000            378 
0007ba 52B9 0000       379 		add.l   #1, s0             |s+1
       0000            379 
0007c0 7001            380 		move.l  #1, %d0            |d0=1 =>成功
                       381 i0_Finish:
0007c2 4CDF 1F00       382 		movem.l (%sp)+, %a0-%a4    |レジスタ復帰
0007c6 46DF            383 		move.w  (%sp)+, %sr
0007c8 4E75            384 		rts                        |サブルーチン復帰
                       385 INQ1:
0007ca 40E7            386 		move.w  %sr,-(%sp)         |レジスタ退避
0007cc 48E7 00F8       387 		movem.l %a0-%a4,-(%sp)
0007d0 46FC 2700       388 		move.w  #0x2700, %SR       |走行レベルを7に設定
0007d4 2039 0000       389 		move.l  s1, %d0            |s=256 => %d0=0:失敗
       0000            389 
0007da 0480 0000       390 		sub.l   #0x100, %d0
       0100            390 
0007e0 6700 002C       391 		beq     i1_Finish          |s=256 => 復帰
0007e4 2279 0000       392 		movea.l in1, %a1           |書き込み先アドレス=%a1
       0000            392 
0007ea 12C1            393 		move.b  %d1, (%a1)+        |データをキューへ入れる,書き込み先アドレスを更
0007ec 45F9 0000       394 		lea.l   bottom1, %a2       |次回書き込みアドレスa1<キューデータ領域の末尾ア
       0000            394 
0007f2 B3CA            395 		cmp.l   %a2, %a1
0007f4 6300 000A       396 		bls     i1_STEP1
0007f8 47F9 0000       397 		lea.l   top1, %a3          |in=top
       0000            397 
0007fe 224B            398 		move.l  %a3, %a1
                       399 i1_STEP1:
000800 23C9 0000       400 		move.l  %a1, in1           |in更新
       0000            400 
000806 52B9 0000       401 		add.l   #1, s1             |s+1
       0000            401 
00080c 7001            402 		move.l  #1, %d0            |d0=1 =>成功
                       403 i1_Finish:
00080e 4CDF 1F00       404 		movem.l (%sp)+, %a0-%a4    |レジスタ復帰
000812 46DF            405 		move.w  (%sp)+, %sr
000814 4E75            406 		rts                        |サブルーチン復帰
                       407 ******************************
                       408 ** OUTQ
                       409 **入力:キュー番号:d0.l
                       410 **出力:d0:0失敗, d0:1成功
                       411 **取り出したデータ:d1.b
                       412 ******************************
                       413 OUT_Q:
000816 0C00 0000       414 		cmp.b #0x00, %d0                |受信キュー、送信キューの判別
00081a 6600 0008       415 		bne o_loop1
00081e 4EBA 000A       416 		jsr OUTQ0
000822 4E75            417 		rts
                       418 o_loop1:
000824 4EBA 0050       419 		jsr OUTQ1
000828 4E75            420 		rts
                       421 OUTQ0:
00082a 40E7            422 		move.w %sr,-(%sp)               |レジスタ退避
00082c 48E7 00F8       423 		movem.l %a0-%a4,-(%sp)
000830 46FC 2700       424 		move.w  #0x2700, %SR            |走行レベルを7に設定
000834 2039 0000       425 		move.l  s0, %d0                 |s=0 => %d0=0:失敗
       0000            425 
00083a 0C80 0000       426 		cmp.l  #0x00, %d0
       0000            426 
000840 6700 002C       427 		beq     o0_Finish               |s=0 => 復帰
000844 2279 0000       428 		movea.l out0, %a1               |取り出し先アドレス=%a1
       0000            428 
00084a 1219            429 		move.b  (%a1)+, %d1             |キューからデータを取り出し(%d1),取り出し先ア
00084c 45F9 0000       430 		lea.l bottom0, %a2              |次回取り出すアドレスa1<キューデータ領域の末
       0000            430 
000852 B3CA            431 		cmp.l  %a2, %a1
000854 6300 000A       432 		bls     o0_STEP1
000858 47F9 0000       433 		lea.l top0, %a3                 |out=top
       0000            433 
00085e 224B            434 		move.l  %a3, %a1
                       435 o0_STEP1:
000860 23C9 0000       436 		move.l %a1, out0                |out更新
       0000            436 
000866 53B9 0000       437 		sub.l #1, s0                    |s--
       0000            437 
00086c 7001            438 		move.l  #1, %d0                 |d0=1 =>成功
                       439 o0_Finish:
00086e 4CDF 1F00       440 		movem.l (%sp)+, %a0-%a4         |レジスタ復帰
000872 46DF            441 		move.w (%sp)+, %sr
000874 4E75            442 		rts                             |サブルーチン復帰
                       443 OUTQ1:
000876 40E7            444 		move.w %sr,-(%sp)
000878 48E7 00F8       445 		movem.l %a0-%a4,-(%sp)          |レジスタ退避
00087c 46FC 2700       446 		move.w  #0x2700, %SR            |走行レベルを7に設定
000880 2039 0000       447 		move.l  s1, %d0                 |s=0 => %d0=0:失敗
       0000            447 
000886 0C80 0000       448 		cmp.l #0x00, %d0
       0000            448 
00088c 6700 002C       449 		beq     o1_Finish               |s=0 => 復帰
000890 2279 0000       450 		movea.l out1, %a1               |取り出し先アドレス=%a1
       0000            450 
000896 1219            451 		move.b  (%a1)+, %d1             |キューからデータを取り出し(%d1),取り出し先ア
000898 45F9 0000       452 		lea.l bottom1, %a2              |次回取り出すアドレスa1<キューデータ領域の末
       0000            452 
00089e B3CA            453 		cmp.l  %a2, %a1
0008a0 6300 000A       454 		bls     o1_STEP1
0008a4 47F9 0000       455 		lea.l top1, %a3                 |out=top
       0000            455 
0008aa 224B            456 		move.l  %a3, %a1
                       457 o1_STEP1:
0008ac 23C9 0000       458 		move.l %a1, out1                |out更新
       0000            458 
0008b2 53B9 0000       459 		sub.l #1, s1                    |s--
       0000            459 
0008b8 7001            460 		move.l  #1, %d0                 |d0=1 =>成功
                       461 o1_Finish:
0008ba 4CDF 1F00       462 		movem.l (%sp)+, %a0-%a4         |レジスタ復帰
0008be 46DF            463 		move.w (%sp)+, %sr
0008c0 4E75            464 		rts                             |サブルーチン復帰
                       465 
                       466 *************************************
                       467 ** PUTSTRING  送信割り込みの処理	
                       468 ** 引数     :  %d1.l = チャネル(ch)	
                       469 **             %d2.l = データ読み込み先の先頭アドレスp いったんa6にさせて
                       470 **             %d3.l = 送信するデータ数size
                       471 ** 出力     :  %d0.l = 取り出した要素数
                       472 *************************************
                       473 PUTSTRING:
0008c2 0C41 0000       474 		cmp    #0, %d1         | ch = 0 であるか確認
0008c6 6600 003A       475 		bne    END_PUTSTRING   | そうでなければ復帰
0008ca 383C 0000       476 		move.w #0, %d4         | sz = 0 (取った要素数)
0008ce 2A42            477 		move.l  %d2, %a5       | i  = %d2 = 読み込み先 address
0008d0 0C43 0000       478 		cmp    #0, %d3         | 取り出すべきサイズが０であるか確認
0008d4 6700 002A       479 		beq    END2_PUTSTRING  | 0であれば復帰
                       480 LOOP1_PUTSTRING:
0008d8 B644            481 		cmp    %d4, %d3        | 取るべき要素数と取った要素数を比較
0008da 6700 001C       482 		beq    END3_PUTSTRING  | 同等であれば復帰
0008de 103C 0001       483 		move.b #1, %d0         | %d0 = 1 (キューの番号：送信キュー)
0008e2 1215            484 		move.b (%a5), %d1      | %d1 = 読み込んだ値
0008e4 4EBA FE84       485 		jsr    IN_Q
0008e8 0C40 0000       486 		cmp    #0, %d0         | IN_Qの復帰値が成功（１）であるか確認
0008ec 6700 000A       487                 beq    END3_PUTSTRING  | 失敗ならば復帰
0008f0 5244            488 		add    #1, %d4         | sz ++ 
0008f2 524D            489 		add    #1, %a5         | i  ++ 
0008f4 6000 FFE2       490 		bra    LOOP1_PUTSTRING 
                       491 END3_PUTSTRING:
                       492                 
0008f8 33FC E10C       493 		move.w #0xe10c, USTCNT1 | 送信割り込みを許可（アンマスク）
       00FF F900       493 
                       494 END2_PUTSTRING:
000900 3004            495 		move   %d4, %d0         | 返り値　%d0 = sz (取った要素数)
                       496 END_PUTSTRING:
000902 4E75            497 		rts
                       498 
                       499 
                       500 		
                       501 *************************************
                       502 ** GETSTRING  受信割り込みの処理	
                       503 ** 引数     :  %d1.l = チャネル(ch)
                       504 ** 	       %d2.l = データ書き込み先の先頭アドレスp
                       505 **             %d3.l = 取り出すデータ数size
                       506 ** 出力     :　%d0.l = 実際に取り出したデータ数		
                       507 *************************************
                       508 GETSTRING:
000904 0C41 0000       509 		cmp    #0, %d1           | ch = 0 であるか確認
000908 6600 0026       510 		bne    END_GETSTRING     | そうでなければ復帰
00090c 383C 0000       511 		move.w #0, %d4           | sz = 0 (取った要素数)
000910 2A42            512 		move.l %d2, %a5          | i  = %d2 = 書き込み先 address
                       513 LOOP1_GETSTRING:	
000912 B644            514 		cmp    %d4, %d3          | 取るべき要素数と取り出した要素数を比較
000914 6700 0018       515 		beq    END2_GETSTRING    | 同等であれば復帰
000918 7000            516 		move.l #0, %d0           | %d0 = 0 (キューの番号：受信キュー)
00091a 4EBA FEFA       517 		jsr    OUT_Q             | OUT_Q ==> %d0: success?, %d1: 取り出したデータ
00091e 0C40 0000       518 		cmp    #0, %d0           | OUT_Qの復帰値が成功(1)であるか確認 
000922 6700 000A       519 		beq    END2_GETSTRING    | 失敗ならば復帰
000926 1AC1            520 		move.b %d1, (%a5)+       | 書き込み先にデータを書き込み
000928 5244            521 		add    #1, %d4           | sz ++
00092a 6000 FFE6       522 		bra    LOOP1_GETSTRING
                       523 END2_GETSTRING:
00092e 3004            524 		move   %d4, %d0          | 返り値 %d0 = sz (実際に取り出したデータ数)
                       525 END_GETSTRING:
000930 4E75            526 		rts
                       527 
                       528 ******************************
                       529 ** RESET_TIMER():	タイマ割り込み→不可、タイマ→停止
                       530 ******************************
                       531 RESET_TIMER:
000932 33FC 0004       532 		move.w	#0x0004, TCTL1 /* タイマ1コントロールレジスタに0x0004を設定→割り込
       00FF F600       532 
00093a 4E75            533 		rts
                       534 		
                       535 ******************************
                       536 ** SET_TIMER(t,p):	タイマ割り込み時に呼び出すルーチン設定 
                       537 **			タイマ割り込み周期tを設定（t * 0.1 msec毎に割り込み発生）
                       538 **			タイマ使用およびタイマ割り込み	
                       539 ** 引数 :		t→%d1.w:	タイマの発生周期
                       540 ** 			p→%d2.l	割り込み時に起動するルーチンの先頭アドレス			
                       541 ******************************
                       542 SET_TIMER:
00093c 23C2 0000       543 		move.l	%d2, task_p /* 割り込み時に起動するルーチンの先頭アドレスpを大域
       0000            543 
000942 33FC 0086       544 		move.w	#0206, TPRER1 /* 0.1msec進むとカウンタが1増えるようにする */
       00FF F602       544 
00094a 33C1 00FF       545 		move.w	%d1, TCMP1 /* t秒周期に設定 */
       F604            545 
000950 33FC 0015       546 		move.w  #0x0015, TCTL1 /* タイマ1コントロールレジスタに0x0015を設定→割り込
       00FF F600       546 
000958 13FC 004D       547 		move.b	#'M', LED7
       00D0 002F       547 
000960 13FC 004D       548 		move.b	#'M', LED6
       00D0 002D       548 
000968 13FC 003A       549 		move.b  #':', LED5
       00D0 002B       549 
000970 13FC 0053       550 		move.b	#'S', LED4
       00D0 0029       550 
000978 13FC 0053       551 		move.b	#'S', LED3
       00D0 003F       551 
000980 13FC 002E       552 		move.b	#'.', LED2
       00D0 003D       552 
000988 13FC 0066       553 		move.b	#'f', LED1
       00D0 003B       553 
000990 13FC 0066       554 		move.b	#'f', LED0
       00D0 0039       554 
000998 4E75            555 		rts
                       556 
                       557 ******************************
                       558 ** CALL_RP():	タイマ割り込み時に処理すべきルーチン呼び出し
                       559 ******************************
                       560 CALL_RP:
00099a 48E7 0080       561 		movem.l	%a0, -(%sp)
00099e 2079 0000       562 		movea.l task_p, %a0
       0000            562 
0009a4 4E90            563 		jsr (%a0)
0009a6 4CDF 0100       564 		movem.l (%sp)+, %a0
0009aa 4E75            565 		rts
                       566 
                       567 *******************************************
                       568 ** システムコールインターフェース
                       569 ** 入力：
                       570 **　　　　システムコール番号   : %d0.l
                       571 **　　　　システムコールの引数 : %d1以降
                       572 ** 出力：
                       573 **　　　　システムコール呼び出しの結果 : %d0.l
                       574 ** ========================================		
                       575 **        +---+---------------+
                       576 **        | 1 | GETSTRING     |
                       577 **        | 2 | PUTSTRING     |
                       578 **        | 3 | RESET_TIMER   |
                       579 **        | 4 | SET_TIMER     |
                       580 **        +---+---------------+
                       581 *******************************************
                       582 SYS_CALL:
                       583 		
                       584 CALL_1:		
0009ac 0C80 0000       585 		cmpi.l #1, %d0   | コール番号の確認(no.1)
       0001            585 
0009b2 6600 000A       586 		bne    CALL_2    | 異なれば他のコール番号の確認
0009b6 4EBA FF4C       587 		jsr    GETSTRING | 対応するシステムコールを呼び出し
0009ba 6000 0034       588                 bra    END_SYS_CALL
                       589 CALL_2:
0009be 0C80 0000       590 		cmpi.l #2, %d0
       0002            590 
0009c4 6600 000A       591 		bne    CALL_3
0009c8 4EBA FEF8       592 		jsr    PUTSTRING
0009cc 6000 0022       593                 bra    END_SYS_CALL
                       594 CALL_3:
0009d0 0C80 0000       595 		cmpi.l #3, %d0
       0003            595 
0009d6 6600 000A       596 		bne    CALL_4
0009da 4EBA FF56       597 		jsr    RESET_TIMER
0009de 6000 0010       598                 bra    END_SYS_CALL
                       599 CALL_4:
0009e2 0C80 0000       600 		cmpi.l #4, %d0
       0004            600 
0009e8 6600 0006       601 		bne    END_SYS_CALL
0009ec 4EBA FF4E       602 		jsr    SET_TIMER
                       603 END_SYS_CALL:	
0009f0 4E73            604 		rte		
                       605 ***************************************************************
                       606 ** スタック領域の確保
                       607 ***************************************************************
                       608 .section .bss
                       609 .even
                       610 SYS_STK:
000c38 0000 0000       611 		.ds.b  0x4000 | システムスタック領域
       0000 0000       611 
       0000 0000       611 
       0000 0000       611 
       0000 0000       611 
                       612 		.even
                       613 SYS_STK_TOP: 		      | システムスタック領域の最後尾
                       614 
004c38 0000 0000       615 task_p:		.ds.l 1	      | タイマ割り込み時に起動するルーチン先頭アドレス代
                       616 ****************************************************************
                       617 ***初期値のあるデータ領域***************************************************************
                       618 .section .data
                       619 TMSG:
0009f4 2A2A 2A2A       620 		.ascii  "******\r\n"      | \r:行頭へ(キャリッジリターン)
       2A2A 0D0A       620 
                       621 		.even                     | \n:次の行へ(ラインフィード)
                       622 BACK:
0009fc 0D54 494D       623 		.ascii  "\rTIME = "
       4520 3D20       623 
                       624 		.even
                       625 NXROW:
000a04 0A              626 		.ascii  "\n"
000a05 00              627 		.even
                       628 MMSSFF:
000a06 3132 3A33       629 		.ascii  "12:34.56"
       342E 3536       629 
                       630 		.even     
                       631 TTC:
000a0e 0030            632 		.dc.w  0x30
                       633 		.even
                       634 MM2:
000a10 30              635 		.dc.b  0x30
000a11 00              636 		.even
                       637 MM1:
000a12 30              638 		.dc.b  0x30
000a13 00              639 		.even
                       640 COLON:
000a14 3A              641 		.dc.b  0x3a
000a15 00              642 		.even
                       643 SS2:
000a16 30              644 		.dc.b  0x30
000a17 00              645 		.even
                       646 SS1:
000a18 30              647 		.dc.b  0x30
000a19 00              648 		.even
                       649 PERIOD:
000a1a 2E              650 		.dc.b  0x2e
000a1b 00              651 		.even
                       652 CS2:
000a1c 30              653 		.dc.b  0x30
000a1d 00              654 		.even
                       655 CS1:
000a1e 30              656 		.dc.b  0x30
000a1f 00              657 		.even
                       658 
                       659 ****************************************************************
                       660 ***初期値の無いデータ領域***************************************************************
                       661 .section .bss
                       662 BUF:
004c3c 0000 0000       663 		.ds.b 256      |BUF[256]
       0000 0000       663 
       0000 0000       663 
       0000 0000       663 
       0000 0000       663 
                       664 		.even
                       665 USR_STK:
004d3c 0000 0000       666 		.ds.b 0x4000   |ユーザスタック領域
       0000 0000       666 
       0000 0000       666 
       0000 0000       666 
       0000 0000       666 
                       667 		.even
                       668 USR_STK_TOP:                   |ユーザスタック領域の最後尾		
                       669 
                       670 
                       671 ******************************
                       672 ** キュー用のメモリ領域確保
                       673 ******************************
                       674 .section .data
                       675 		.equ  B_SIZE, 256
                       676 top0:
000a20 0000 0000       677 		.ds.b B_SIZE-1
       0000 0000       677 
       0000 0000       677 
       0000 0000       677 
       0000 0000       677 
                       678 bottom0:
000b1f 00              679 		.ds.b 1
                       680 top1:
000b20 0000 0000       681 		.ds.b B_SIZE-1
       0000 0000       681 
       0000 0000       681 
       0000 0000       681 
       0000 0000       681 
                       682 bottom1:
000c1f 00              683 		.ds.b 1
                       684 out0:
000c20 0000 0000       685 		.ds.l 1
                       686 out1:
000c24 0000 0000       687 		.ds.l 1
                       688 in0:
000c28 0000 0000       689 		.ds.l 1
                       690 in1:
000c2c 0000 0000       691 		.ds.l 1
                       692 s0:
000c30 0000 0000       693 		.ds.l 1
                       694 s1:
000c34 0000 0000       695 		.ds.l 1
                       696 
                       697 .end
