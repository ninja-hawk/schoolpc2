                         4 .list
                         5 ***************************************************************
                         6 ** 各種レジスタ定義
                         7 ***************************************************************
                         8 
                         9 ***************
                        10 ** レジスタ群の先頭
                        11 ***************
                        12 .equ REGBASE, 0xFFF000  | DMAP を使用.
                        13 .equ IOBASE,  0x00d00000
                        14 
                        15 ***************
                        16 ** 割り込み関係のレジスタ
                        17 ***************
                        18 .equ IVR,     REGBASE+0x300 | 割り込みベクタレジスタ
                        19 .equ IMR,     REGBASE+0x304 | 割り込みマスクレジスタ
                        20 .equ ISR,     REGBASE+0x30c | 割り込みステータスレジスタ
                        21 .equ IPR,     REGBASE+0x310 | 割り込みペンディングレジスタ
                        22 
                        23 
                        24 ***************
                        25 ** タイマ関係のレジスタ
                        26 ***************
                        27 .equ TCTL1,   REGBASE+0x600 | タイマ1コントロールレジスタ
                        28 .equ TPRER1,  REGBASE+0x602 | タイマ1プリスケーラレジスタ
                        29 .equ TCMP1,   REGBASE+0x604 | タイマ1コンペアレジスタ
                        30 .equ TCN1,    REGBASE+0x608 | タイマ1カウンタレジスタ
                        31 .equ TSTAT1,  REGBASE+0x60a | タイマ1ステータスレジスタ
                        32 ***************
                        33 ** UART1 (送受信)関係のレジスタ
                        34 ***************
                        35 .equ USTCNT1, REGBASE+0x900 | UART1 ステータス / コントロールレジスタ
                        36 .equ UBAUD1,  REGBASE+0x902 | UART1 ボーコントロールレジスタ
                        37 .equ URX1,    REGBASE+0x904 | UART1 受信レジスタ
                        38 .equ UTX1,    REGBASE+0x906 | UART1 送信レジスタ
                        39 ***************
                        40 ** LED
                        41 ***************
                        42 .equ LED7,  IOBASE+0x000002f | ボード搭載のLED用レジスタ
                        43 .equ LED6,  IOBASE+0x000002d | 使用法については付録 A.4.3.1
                        44 .equ LED5,  IOBASE+0x000002b
                        45 .equ LED4,  IOBASE+0x0000029
                        46 .equ LED3,  IOBASE+0x000003f
                        47 .equ LED2,  IOBASE+0x000003d
                        48 .equ LED1,  IOBASE+0x000003b
                        49 .equ LED0,  IOBASE+0x0000039
                        50 
                        51 **************
                        52 **システムコール番号
                        53 **************
                        54 .equ SYSCALL_NUM_GETSTRING,    1
                        55 .equ SYSCALL_NUM_PUTSTRING,    2
                        56 .equ SYSCALL_NUM_RESET_TIMER,  3
                        57 .equ SYSCALL_NUM_SET_TIMER,    4
                        58 
                        59 ***************************************************************
                        60 ** 初期化
                        61 ***************************************************************
                        62 .section .text
                        63 .even
                        64 boot:
                        65 		* スーパーバイザ & 各種設定を行っている最中の割込禁止
000400 46FC 2000        66 		move.w #0x2000,%SR
000404 4FF9 0000        67 		lea.l SYS_STK_TOP, %SP | Set SSP
       0000             67 
                        68 		****************
                        69 		** 割り込みコントローラの初期化
                        70 		****************
00040a 13FC 0040        71 		move.b #0x40, IVR      | ユーザ割り込みベクタ番号を
       00FF F300        71 
                        72 		                       | 0x40+level に設定.
000412 23FC 00FF        73 		move.l #0x00ff3ff9,IMR | 全割り込みマスクMUART=>0,MTMR1=>1
       3FF9 00FF        73 
       F304             73 
                        74 		****************
                        75 		** 送受信 (UART1) 関係の初期化 ( 割り込みレベルは 4 に固定されている )
                        76 		****************
00041c 21FC 0000        77 		move.l #UART1_interrupt, 0x110  | 受信割り込みベクタをセット
       0000 0110        77 
000424 33FC 0000        78 		move.w #0x0000, USTCNT1 | リセット
       00FF F900        78 
00042c 33FC E108        79 		move.w #0xe108, USTCNT1 | 送受信可能 , パリティなし , 1 stop, 8 bit,
       00FF F900        79 
                        80 					| 受信割り込み許可, 送信割り込み禁止
000434 33FC 0038        81 		move.w #0x0038, UBAUD1  | baud rate = 230400 bps
       00FF F902        81 
                        82 		****************
                        83 		** タイマ関係の初期化 ( 割り込みレベルは 6 に固定されている )
                        84 		*****************
00043c 33FC 0004        85 		move.w #0x0004, TCTL1   | restart, 割り込み不可 ,
       00FF F600        85 
                        86 					| システムクロックの 1/16 を単位として計時,
                        87 					| タイマ使用停止
000444 21FC 0000        88 		move.l #COMPARE_INTERPUT, 0x118 /* level 6 */
       0000 0118        88 
                        89 
00044c 21FC 0000        90                 move.l #SYS_CALL, 0x080 /*SYS_CALLの割り込みベクタ設定*/
       0000 0080        90 
                        91 		******************************
                        92 		** キューの初期化
                        93 		******************************
000454 45F9 0000        94 		lea.l  top0, %a2
       0000             94 
00045a 47F9 0000        95 		lea.l  top1, %a3
       0000             95 
000460 23CA 0000        96 		move.l %a2, out0
       0000             96 
000466 23CB 0000        97 		move.l %a3, out1
       0000             97 
00046c 23CA 0000        98 		move.l %a2, in0
       0000             98 
000472 23CB 0000        99 		move.l %a3, in1
       0000             99 
000478 23FC 0000       100 		move.l #0, s0
       0000 0000       100 
       0000            100 
000482 23FC 0000       101 		move.l #0, s1
       0000 0000       101 
       0000            101 
                       102 	
00048c 6000 0002       103 		bra MAIN
                       104 	
                       105 ****************************************************************
                       106 ***プログラム領域
                       107 ****************************************************************
                       108 MAIN:
                       109 		**走行モードとレベルの設定(「ユーザモード」への移行処理)
000490 46FC 0000       110 		move.w #0x0000, %SR    | USER MODE, LEVEL 0
000494 4FF9 0000       111 		lea.l  USR_STK_TOP,%SP | user stackの設定
       0000            111 
                       112 		**システムコールによるRESET_TIMERの起動
00049a 7003            113 		move.l #SYSCALL_NUM_RESET_TIMER, %D0
00049c 4E40            114 		trap   #0
                       115 		**システムコールによるSET_TIMERの起動
00049e 7004            116 		move.l #SYSCALL_NUM_SET_TIMER, %D0
0004a0 323C 0064       117 		move.w #100, %D1
0004a4 243C 0000       118 		move.l #SELECT,%D2
       0000            118 
0004aa 4E40            119 		trap   #0
                       120 		
                       121 ******************************
                       122 * sys_GETSTRING, sys_PUTSTRINGのテスト
                       123 *ターミナルの入力をエコーバックする
                       124 ******************************
                       125 LOOP:
0004ac 6000 FFFE       126 		bra    LOOP
                       127 		
                       128 ******************************
                       129 ** 選択課題ゾーン
                       130 ** 時計(2)
                       131 ** プログラムを実行してからの時間を
                       132 ** ターミナルとLEDを"MM:SS.ff"という形で表示する
                       133 ** CS1, CS2 -> 小数第2位、第1位
                       134 **  SS1,  SS1 -> 秒数1の位、10の位
                       135 **  MM1,  MM2 ->  分数1の位、10の位
                       136 **  MMSSFF       ->  ターミナル表示用メモリ領域
                       137 ** BACK     -> ターミナル表示用ヘッダ(\rTIME = )
                       138 ** COLON    -> :(0x3a)
                       139 ** PERIOED  -> .(0x2e)
                       140 ******************************
                       141 SELECT:
0004b0 48E7 FFFE       142 		movem.l %D0-%D7/%A0-%A6,-(%SP)	| レジスタ退避
0004b4 0C39 003A       143 		cmpi.b #0x3a,CS1            	| CS1カウンタで10回実行したかどうか数える
       0000 0000       143 
0004bc 6700 00E4       144 		beq    CS1KILL				| 0.10秒経っていたら繰り上げ
                       145 SECOND:
0004c0 0C39 003A       146 		cmpi.b #0x3a,CS2           		| CS2カウンタで10回実行したかどうか数える
       0000 0000       146 
0004c8 6700 00EA       147 		beq    CS2KILL				| 1.00秒経っていたら繰り上げ
                       148 TENSECOND:
0004cc 0C39 003A       149 		cmpi.b #0x3a,SS1            	| SS1カウンタで10回実行したかどうか数える
       0000 0000       149 
0004d4 6700 00F0       150 		beq    SS1KILL				| 10.00秒経っていたら繰り上げ
                       151 MINUTE:
0004d8 0C39 0036       152 		cmpi.b #0x36,SS2            	| SS2カウンタで6回実行したかどうか数える
       0000 0000       152 
0004e0 6700 00F6       153 		beq    SS2KILL				| 60.00秒経っていたら繰り上げ
                       154 TENMINUTE:
0004e4 0C39 003A       155 		cmpi.b #0x3a,MM1            	| MM1カウンタで10回実行したかどうか数える
       0000 0000       155 
0004ec 6700 00FC       156 		beq    MM1KILL				| 1.00分経っていたら繰り上げ
                       157 ENDCLOCK:
0004f0 0C39 0036       158 		cmpi.b #0x36,MM2            	| MM2カウンタで6回実行したかどうか数える
       0000 0000       158 
0004f8 6700 0102       159 		beq    MM2KILL				| 60.00分経っていたらタイマストップ
                       160 
                       161 COUNT:
0004fc 7002            162 		move.l #SYSCALL_NUM_PUTSTRING,%D0	| コール番号格納
0004fe 7200            163 		move.l #0,    %D1       			| ch = 0
000500 243C 0000       164 		move.l #BACK, %D2        			| p  = #BACK
       0000            164 
000506 7608            165 		move.l #8,    %D3        			| size = 8
000508 4E40            166 		trap   #0						| 呼び出し
                       167 
00050a 41F9 0000       168 		lea.l  MMSSFF, %a0				| a0レジスタにMMSSFFのメモリ番地
       0000            168 
000510 10F9 0000       169 		move.b MM2, (%a0)+				| 分数10の位代入
       0000            169 
000516 10F9 0000       170 		move.b MM1, (%a0)+				| 分数1の位代入
       0000            170 
00051c 10F9 0000       171 		move.b COLON, (%a0)+				| :代入
       0000            171 
000522 10F9 0000       172 		move.b SS2, (%a0)+				| 秒数10の位代入
       0000            172 
000528 10F9 0000       173 		move.b SS1, (%a0)+				| 秒数1の位代入
       0000            173 
00052e 10F9 0000       174 		move.b PERIOD, (%a0)+				|　.代入
       0000            174 
000534 10F9 0000       175 		move.b CS2, (%a0)+				| 小数第1位代入
       0000            175 
00053a 10B9 0000       176 		move.b CS1, (%a0)				|  小数第2位代入
       0000            176 
                       177 
000540 7002            178 		move.l #SYSCALL_NUM_PUTSTRING,%D0	| コール番号格納
000542 7200            179 		move.l #0,    %D1        			| ch = 0
000544 243C 0000       180 		move.l #MMSSFF,  %D2      			| p  = #MMSSFF
       0000            180 
00054a 7608            181 		move.l #8,    %D3        			| size = 8
00054c 4E40            182 		trap   #0						| システム呼び出し
                       183 
                       184 		/* c秒 */
00054e 1E39 0000       185 		move.b CS1, %d7					| CS1をd7レジスタへ代入
       0000            185 
000554 13C7 00D0       186 		move.b %d7, LED0					| LED0を変化
       0039            186 
                       187 		/* 10c秒 */
00055a 1E39 0000       188 		move.b CS2, %d7					| CS2をd7レジスタへ代入
       0000            188 
000560 13C7 00D0       189 		move.b %d7, LED1					| LED1を変化
       003B            189 
                       190 		/* 秒 */
000566 1E39 0000       191 		move.b SS1, %d7					| SS1をd7レジスタへ代入
       0000            191 
00056c 13C7 00D0       192 		move.b %d7, LED3					| LED3を変化
       003F            192 
                       193 		/* 10秒 */
000572 1E39 0000       194 		move.b SS2, %d7					| SS2をd7レジスタへ代入
       0000            194 
000578 13C7 00D0       195 		move.b %d7, LED4					| LED4を変化
       0029            195 
                       196 		/* 分 */
00057e 1E39 0000       197 		move.b MM1, %d7					| MM1をd7レジスタへ代入
       0000            197 
000584 13C7 00D0       198 		move.b %d7, LED6					| LED6を変化
       002D            198 
                       199 		/* 10分 */
00058a 1E39 0000       200 		move.b MM2, %d7					| CS1をd7レジスタへ代入
       0000            200 
000590 13C7 00D0       201 		move.b %d7, LED7					| MM2を変化
       002F            201 
                       202 		/* カウントアップ */
000596 0639 0001       203 		addi.b #1,CS1      				| CS1カウンタを1つ増やして
       0000 0000       203 
00059e 6000 00D0       204 		bra    SELECTEND         			| サブルーチン終了へ
                       205 
                       206 
                       207 CS1KILL:
0005a2 13FC 0030       208 		move.b #0x30, CS1				| 小数第2位を0に
       0000 0000       208 
0005aa 5239 0000       209 		add.b  #0x01, CS2				| 小数第1位に繰り上げ
       0000            209 
0005b0 6000 FF0E       210 		bra    SECOND
                       211 CS2KILL:
0005b4 13FC 0030       212 		move.b #0x30, CS2				| 小数第1位を0に
       0000 0000       212 
0005bc 5239 0000       213 		add.b  #0x01, SS1				| 秒数1の位に繰り上げ
       0000            213 
0005c2 6000 FF08       214 		bra    TENSECOND
                       215 SS1KILL:
0005c6 13FC 0030       216 		move.b #0x30, SS1				| 秒数1の位を0に
       0000 0000       216 
0005ce 5239 0000       217 		add.b  #0x01, SS2				| 秒数10の位に繰り上げ
       0000            217 
0005d4 6000 FF02       218 		bra    MINUTE
                       219 SS2KILL:
0005d8 13FC 0030       220 		move.b #0x30, SS2				| 秒数10の位を0に
       0000 0000       220 
0005e0 5239 0000       221 		add.b  #0x01, MM1				| 分数1の位に繰り上げ
       0000            221 
0005e6 6000 FEFC       222 		bra    TENMINUTE
                       223 MM1KILL:
0005ea 13FC 0030       224 		move.b #0x30, MM1				| 分数1の位を0に
       0000 0000       224 
0005f2 5239 0000       225 		add.b  #0x01, MM2				| 分数10の位に繰り上げ
       0000            225 
0005f8 6000 FEF6       226 		bra    ENDCLOCK
                       227 MM2KILL:
0005fc 13FC 0030       228 		move.b #0x30, CS1				| 小数第2位を0に
       0000 0000       228 
000604 13FC 0030       229 		move.b #0x30, CS2				| 小数第1位を0に
       0000 0000       229 
00060c 13FC 0030       230 		move.b #0x30, SS1				| 秒数1の位を0に
       0000 0000       230 
000614 13FC 0030       231 		move.b #0x30, SS2				| 秒数10の位を0に
       0000 0000       231 
00061c 13FC 0030       232 		move.b #0x30, MM1				| 分数1の位を0に
       0000 0000       232 
000624 13FC 0030       233 		move.b #0x30, MM2				| 分数10の位を0に
       0000 0000       233 
00062c 13FC 004D       234 		move.b #'M', LED7				| LED7をMに点灯
       00D0 002F       234 
000634 13FC 004D       235 		move.b #'M', LED6				| LED6をMに点灯
       00D0 002D       235 
00063c 13FC 003A       236 		move.b #':', LED5				| LED5を:に点灯
       00D0 002B       236 
000644 13FC 0053       237 		move.b #'S', LED4				| LED4をSに点灯
       00D0 0029       237 
00064c 13FC 0053       238 		move.b #'S', LED3				| LED3をSに点灯
       00D0 003F       238 
000654 13FC 002E       239 		move.b #'.', LED2				| LED2を.に点灯
       00D0 003D       239 
00065c 13FC 0066       240 		move.b #'f', LED1				| LED1をfに点灯
       00D0 003B       240 
000664 13FC 0066       241 		move.b #'f', LED0				| LED0をfに点灯
       00D0 0039       241 
00066c 7003            242 		move.l #SYSCALL_NUM_RESET_TIMER,%D0		| タイマリセット
00066e 4E40            243 		trap   #0					| システムコール呼び出し
                       244 
                       245 SELECTEND:
000670 4CDF 7FFF       246 		movem.l (%SP)+,%D0-%D7/%A0-%A6		| レジスタ復帰
000674 4E75            247 		rts							| サブルーチン呼び出し前へ戻る
                       248 
                       249 
                       250 ******************************
                       251 *タイマのテスト
                       252 * ’******’を表示し改行する．
                       253 *５回実行すると，RESET_TIMERをする．
                       254 ******************************
                       255 TT:
000676 48E7 FFFE       256 		movem.l %D0-%D7/%A0-%A6,-(%SP)
00067a 0C79 0005       257 		cmpi.w #5,TTC            | TTCカウンタで5回実行したかどうか数える
       0000 0000       257 
000682 6700 001C       258 		beq    TTKILL            | 5回実行したら，タイマを止める
000686 7002            259 		move.l #SYSCALL_NUM_PUTSTRING,%D0
000688 7200            260 		move.l #0,    %D1        | ch = 0
00068a 243C 0000       261 		move.l #TMSG, %D2        | p  = #TMSG
       0000            261 
000690 7608            262 		move.l #8,    %D3        | size = 8
000692 4E40            263 		trap   #0
000694 0679 0001       264 		addi.w #1,TTC            | TTCカウンタを1つ増やして
       0000 0000       264 
00069c 6000 0006       265 		bra    TTEND             |そのまま戻る
                       266 TTKILL:
0006a0 7003            267 		move.l #SYSCALL_NUM_RESET_TIMER,%D0
0006a2 4E40            268 		trap   #0
                       269 TTEND:
0006a4 4CDF 7FFF       270 		movem.l (%SP)+,%D0-%D7/%A0-%A6
0006a8 4E75            271 		rts
                       272 
                       273 ******************************
                       274 ** COMPARE_INTERPUT:	タイマ用のハードウェア割り込みインターフェース
                       275 ******************************
                       276 COMPARE_INTERPUT:
0006aa 48E7 8000       277 		movem.l %d0, -(%sp) /* d0退避 */
0006ae 3039 00FF       278 		move.w  TSTAT1, %d0 /* TSTATの値をd0へ */
       F60A            278 
0006b4 0800 0000       279 		btst	#0, %d0 /* タイマ1ステータスレジスタの0ビット目が0か、否か */
0006b8 6700 000E       280 		beq	COMPARE_END /* 0ならコンペアイベントなし、つまりカウンタ値とコンペ
0006bc 33FC 0000       281 		move.w	#0x0000, TSTAT1 /* タイマ1ステータスレジスタを0クリア */
       00FF F60A       281 
0006c4 4EBA 02BC       282 		jsr	CALL_RP /* CALL_RPを呼び出す */
                       283 
                       284 COMPARE_END:
0006c8 4CDF 0001       285 		movem.l (%sp)+, %d0 /* d0復帰 */
0006cc 4E73            286 		rte
                       287 
                       288 *************************************
                       289 ** UART1_interrupt
                       290 ** 送受信割り込みを扱うインターフェース
                       291 *************************************
                       292 /* btst : 指定データの指定ビットが0であるか判断し、0であればCCRのZをセ
                       293 UART1_interrupt:
0006ce 48E7 7000       294 		movem.l %d1-%d3, -(%SP)
                       295 		/* 受信FIFOが空でないとき(URX[13]==1)受信割り込みであると判断 */
                       296 		/* URX[13] ->  0: 受信FIFOが空, 1: 受信FIFOが空でない */
0006d2 3639 00FF       297 		move.w URX1, %d3
       F904            297 
0006d8 1403            298 		move.b %d3, %d2       |  %d3.wの下位8bitを%d2.bにコピー
0006da 0803 000D       299 		btst.l #13, %d3       |  13ビット目は受信FIFOにデータが存在するか
0006de 6700 000C       300 		beq    CALL_INTERPUT  |  if URX1[13] == 0 (受信FIFOが空のとき)
0006e2 7200            301 		move.l #0, %d1        |  ch = 0 を明示
0006e4 4EBA 001E       302 		jsr    INTERGET       |  受信割り込み時処理
0006e8 6000 0014       303 		bra    END_interrupt
                       304 CALL_INTERPUT:
                       305 		/* 送信FIFOがに空のとき(UTX[15]==1)送信割り込みであると判断 */
                       306 		/* UTX[15] ->  0: 送信FIFOが空でない, 1: 送信FIFOが空 */
0006ec 0839 000F       307 		btst.l #15, UTX1      |  15ビット目は送信FIFOが空であるか
       00FF F906       307 
0006f4 6700 0008       308 		beq    END_interrupt  |  if UTX1[15] == 0 (送信FIFOが空でないとき終了)
0006f8 7200            309 		move.l #0, %d1        |  ch = 0 を明示
0006fa 4EBA 001E       310 		jsr    INTERPUT       |  送信割り込み時処理
                       311 END_interrupt:
0006fe 4CDF 000E       312 		movem.l (%SP)+, %d1-%d3
000702 4E73            313 		rte
                       314 
                       315 *************************************
                       316 ** INTERGET  受信割り込みルーチン	
                       317 ** 引数     :  %d1.l = チャネル(ch)	
                       318 **             %d2.b = 受信データdata
                       319 **戻り値　なし		
                       320 *************************************
                       321 INTERGET:
000704 2F00            322 		move.l %d0, -(%SP)
000706 0C41 0000       323 		cmp    #0, %d1       | ch = 0 であるか確認
00070a 6600 000A       324 		bne    END_INTERGET
00070e 7000            325 		move.l #0, %d0       | %d0 = 受信キュー
000710 1202            326 		move.b %d2, %d1      | %d1 = 受信したデータ
000712 4EBA 003E       327 		jsr    IN_Q          | %d0 <= 成功したか否か
                       328 END_INTERGET:
000716 201F            329 		move.l (%SP)+, %d0
000718 4E75            330 		rts
                       331 
                       332 *************************************
                       333 ** INTERPUT :  送信割り込み時の処理	
                       334 ** 引数     :  %d1.l = チャネル(ch)	
                       335 *************************************
                       336 INTERPUT:
00071a 2F01            337 		move.l  %d1, -(%SP)
00071c 46FC 2700       338 		move.w  #0x2700, %SR | 走行レベルを７に設定
000720 0C81 0000       339 		cmpi.l  #0, %d1      | ch = 0 を確認
       0000            339 
000726 6600 0026       340 		bne     END_INTERPUT | if ch != 0 => 復帰
00072a 7001            341                 move.l  #1, %d0
00072c 4EBA 00D0       342 		jsr     OUT_Q        | %d1.b = data
000730 0C40 0000       343 		cmpi    #0, %d0      | %d0(OUTQの戻り値) == 0(失敗)
000734 6600 000E       344 		bne     TX_DATA      | if so => 送信割り込みをマスク(真下)
000738 33FC E108       345 		move.w  #0xe108, USTCNT1
       00FF F900       345 
000740 6000 000C       346 		bra     END_INTERPUT
                       347 TX_DATA:
000744 0641 0800       348 		add.w   #0x0800, %d1 | ヘッダを付与
000748 33C1 00FF       349 		move.w  %d1, UTX1
       F906            349 
                       350 END_INTERPUT:
00074e 221F            351 		move.l  (%SP)+, %d1
000750 4E75            352 		rts
                       353 
                       354 ******************************
                       355 ** INQ
                       356 **入力キュー番号,d0.l 書き込むデータ,d1.b
                       357 **出力 d0,成功1, 失敗0
                       358 ******************************
                       359 IN_Q:
000752 0C00 0000       360 		cmp.b   #0x00, %d0         |受信キュー、送信キューの判別
000756 6600 0008       361 		bne     i_loop1
00075a 4EBA 000A       362 		jsr     INQ0
00075e 4E75            363 		rts
                       364 i_loop1:
000760 4EBA 0050       365 		jsr     INQ1
000764 4E75            366 		rts
                       367 INQ0:
000766 40E7            368 		move.w  %sr, -(%sp)        |レジスタ退避
000768 48E7 00F8       369 		movem.l %a0-%a4,-(%sp)
00076c 46FC 2700       370 		move.w  #0x2700, %SR       |走行レベルを7に設定
000770 2039 0000       371 		move.l  s0, %d0            |s=256 => %d0=0:失敗
       0000            371 
000776 0480 0000       372 		sub.l   #0x100, %d0
       0100            372 
00077c 6700 002C       373 		beq     i0_Finish          |s=256 => 復帰
000780 2279 0000       374 		movea.l in0, %a1           |書き込み先アドレス=%a1
       0000            374 
000786 12C1            375 		move.b  %d1, (%a1)+        |データをキューへ入れる,書き込み先アドレスを更
000788 45F9 0000       376 		lea.l   bottom0, %a2       |次回書き込みアドレスa1<キューデータ領域の末尾ア
       0000            376 
00078e B3CA            377 		cmp.l   %a2, %a1
000790 6300 000A       378 		bls     i0_STEP1
000794 47F9 0000       379 		lea.l   top0, %a3          |in=top
       0000            379 
00079a 224B            380 		move.l  %a3, %a1
                       381 i0_STEP1:
00079c 23C9 0000       382 		move.l  %a1, in0           |in更新
       0000            382 
0007a2 52B9 0000       383 		add.l   #1, s0             |s+1
       0000            383 
0007a8 7001            384 		move.l  #1, %d0            |d0=1 =>成功
                       385 i0_Finish:
0007aa 4CDF 1F00       386 		movem.l (%sp)+, %a0-%a4    |レジスタ復帰
0007ae 46DF            387 		move.w  (%sp)+, %sr
0007b0 4E75            388 		rts                        |サブルーチン復帰
                       389 INQ1:
0007b2 40E7            390 		move.w  %sr,-(%sp)         |レジスタ退避
0007b4 48E7 00F8       391 		movem.l %a0-%a4,-(%sp)
0007b8 46FC 2700       392 		move.w  #0x2700, %SR       |走行レベルを7に設定
0007bc 2039 0000       393 		move.l  s1, %d0            |s=256 => %d0=0:失敗
       0000            393 
0007c2 0480 0000       394 		sub.l   #0x100, %d0
       0100            394 
0007c8 6700 002C       395 		beq     i1_Finish          |s=256 => 復帰
0007cc 2279 0000       396 		movea.l in1, %a1           |書き込み先アドレス=%a1
       0000            396 
0007d2 12C1            397 		move.b  %d1, (%a1)+        |データをキューへ入れる,書き込み先アドレスを更
0007d4 45F9 0000       398 		lea.l   bottom1, %a2       |次回書き込みアドレスa1<キューデータ領域の末尾ア
       0000            398 
0007da B3CA            399 		cmp.l   %a2, %a1
0007dc 6300 000A       400 		bls     i1_STEP1
0007e0 47F9 0000       401 		lea.l   top1, %a3          |in=top
       0000            401 
0007e6 224B            402 		move.l  %a3, %a1
                       403 i1_STEP1:
0007e8 23C9 0000       404 		move.l  %a1, in1           |in更新
       0000            404 
0007ee 52B9 0000       405 		add.l   #1, s1             |s+1
       0000            405 
0007f4 7001            406 		move.l  #1, %d0            |d0=1 =>成功
                       407 i1_Finish:
0007f6 4CDF 1F00       408 		movem.l (%sp)+, %a0-%a4    |レジスタ復帰
0007fa 46DF            409 		move.w  (%sp)+, %sr
0007fc 4E75            410 		rts                        |サブルーチン復帰
                       411 ******************************
                       412 ** OUTQ
                       413 **入力:キュー番号:d0.l
                       414 **出力:d0:0失敗, d0:1成功
                       415 **取り出したデータ:d1.b
                       416 ******************************
                       417 OUT_Q:
0007fe 0C00 0000       418 		cmp.b #0x00, %d0                |受信キュー、送信キューの判別
000802 6600 0008       419 		bne o_loop1
000806 4EBA 000A       420 		jsr OUTQ0
00080a 4E75            421 		rts
                       422 o_loop1:
00080c 4EBA 0050       423 		jsr OUTQ1
000810 4E75            424 		rts
                       425 OUTQ0:
000812 40E7            426 		move.w %sr,-(%sp)               |レジスタ退避
000814 48E7 00F8       427 		movem.l %a0-%a4,-(%sp)
000818 46FC 2700       428 		move.w  #0x2700, %SR            |走行レベルを7に設定
00081c 2039 0000       429 		move.l  s0, %d0                 |s=0 => %d0=0:失敗
       0000            429 
000822 0C80 0000       430 		cmp.l  #0x00, %d0
       0000            430 
000828 6700 002C       431 		beq     o0_Finish               |s=0 => 復帰
00082c 2279 0000       432 		movea.l out0, %a1               |取り出し先アドレス=%a1
       0000            432 
000832 1219            433 		move.b  (%a1)+, %d1             |キューからデータを取り出し(%d1),取り出し先ア
000834 45F9 0000       434 		lea.l bottom0, %a2              |次回取り出すアドレスa1<キューデータ領域の末
       0000            434 
00083a B3CA            435 		cmp.l  %a2, %a1
00083c 6300 000A       436 		bls     o0_STEP1
000840 47F9 0000       437 		lea.l top0, %a3                 |out=top
       0000            437 
000846 224B            438 		move.l  %a3, %a1
                       439 o0_STEP1:
000848 23C9 0000       440 		move.l %a1, out0                |out更新
       0000            440 
00084e 53B9 0000       441 		sub.l #1, s0                    |s--
       0000            441 
000854 7001            442 		move.l  #1, %d0                 |d0=1 =>成功
                       443 o0_Finish:
000856 4CDF 1F00       444 		movem.l (%sp)+, %a0-%a4         |レジスタ復帰
00085a 46DF            445 		move.w (%sp)+, %sr
00085c 4E75            446 		rts                             |サブルーチン復帰
                       447 OUTQ1:
00085e 40E7            448 		move.w %sr,-(%sp)
000860 48E7 00F8       449 		movem.l %a0-%a4,-(%sp)          |レジスタ退避
000864 46FC 2700       450 		move.w  #0x2700, %SR            |走行レベルを7に設定
000868 2039 0000       451 		move.l  s1, %d0                 |s=0 => %d0=0:失敗
       0000            451 
00086e 0C80 0000       452 		cmp.l #0x00, %d0
       0000            452 
000874 6700 002C       453 		beq     o1_Finish               |s=0 => 復帰
000878 2279 0000       454 		movea.l out1, %a1               |取り出し先アドレス=%a1
       0000            454 
00087e 1219            455 		move.b  (%a1)+, %d1             |キューからデータを取り出し(%d1),取り出し先ア
000880 45F9 0000       456 		lea.l bottom1, %a2              |次回取り出すアドレスa1<キューデータ領域の末
       0000            456 
000886 B3CA            457 		cmp.l  %a2, %a1
000888 6300 000A       458 		bls     o1_STEP1
00088c 47F9 0000       459 		lea.l top1, %a3                 |out=top
       0000            459 
000892 224B            460 		move.l  %a3, %a1
                       461 o1_STEP1:
000894 23C9 0000       462 		move.l %a1, out1                |out更新
       0000            462 
00089a 53B9 0000       463 		sub.l #1, s1                    |s--
       0000            463 
0008a0 7001            464 		move.l  #1, %d0                 |d0=1 =>成功
                       465 o1_Finish:
0008a2 4CDF 1F00       466 		movem.l (%sp)+, %a0-%a4         |レジスタ復帰
0008a6 46DF            467 		move.w (%sp)+, %sr
0008a8 4E75            468 		rts                             |サブルーチン復帰
                       469 
                       470 *************************************
                       471 ** PUTSTRING  送信割り込みの処理	
                       472 ** 引数     :  %d1.l = チャネル(ch)	
                       473 **             %d2.l = データ読み込み先の先頭アドレスp いったんa6にさせて
                       474 **             %d3.l = 送信するデータ数size
                       475 ** 出力     :  %d0.l = 取り出した要素数
                       476 *************************************
                       477 PUTSTRING:
0008aa 0C41 0000       478 		cmp    #0, %d1         | ch = 0 であるか確認
0008ae 6600 003A       479 		bne    END_PUTSTRING   | そうでなければ復帰
0008b2 383C 0000       480 		move.w #0, %d4         | sz = 0 (取った要素数)
0008b6 2A42            481 		move.l  %d2, %a5       | i  = %d2 = 読み込み先 address
0008b8 0C43 0000       482 		cmp    #0, %d3         | 取り出すべきサイズが０であるか確認
0008bc 6700 002A       483 		beq    END2_PUTSTRING  | 0であれば復帰
                       484 LOOP1_PUTSTRING:
0008c0 B644            485 		cmp    %d4, %d3        | 取るべき要素数と取った要素数を比較
0008c2 6700 001C       486 		beq    END3_PUTSTRING  | 同等であれば復帰
0008c6 103C 0001       487 		move.b #1, %d0         | %d0 = 1 (キューの番号：送信キュー)
0008ca 1215            488 		move.b (%a5), %d1      | %d1 = 読み込んだ値
0008cc 4EBA FE84       489 		jsr    IN_Q
0008d0 0C40 0000       490 		cmp    #0, %d0         | IN_Qの復帰値が成功（１）であるか確認
0008d4 6700 000A       491                 beq    END3_PUTSTRING  | 失敗ならば復帰
0008d8 5244            492 		add    #1, %d4         | sz ++ 
0008da 524D            493 		add    #1, %a5         | i  ++ 
0008dc 6000 FFE2       494 		bra    LOOP1_PUTSTRING 
                       495 END3_PUTSTRING:
                       496                 
0008e0 33FC E10C       497 		move.w #0xe10c, USTCNT1 | 送信割り込みを許可（アンマスク）
       00FF F900       497 
                       498 END2_PUTSTRING:
0008e8 3004            499 		move   %d4, %d0         | 返り値　%d0 = sz (取った要素数)
                       500 END_PUTSTRING:
0008ea 4E75            501 		rts
                       502 
                       503 
                       504 		
                       505 *************************************
                       506 ** GETSTRING  受信割り込みの処理	
                       507 ** 引数     :  %d1.l = チャネル(ch)
                       508 ** 	       %d2.l = データ書き込み先の先頭アドレスp
                       509 **             %d3.l = 取り出すデータ数size
                       510 ** 出力     :　%d0.l = 実際に取り出したデータ数		
                       511 *************************************
                       512 GETSTRING:
0008ec 0C41 0000       513 		cmp    #0, %d1           | ch = 0 であるか確認
0008f0 6600 0026       514 		bne    END_GETSTRING     | そうでなければ復帰
0008f4 383C 0000       515 		move.w #0, %d4           | sz = 0 (取った要素数)
0008f8 2A42            516 		move.l %d2, %a5          | i  = %d2 = 書き込み先 address
                       517 LOOP1_GETSTRING:	
0008fa B644            518 		cmp    %d4, %d3          | 取るべき要素数と取り出した要素数を比較
0008fc 6700 0018       519 		beq    END2_GETSTRING    | 同等であれば復帰
000900 7000            520 		move.l #0, %d0           | %d0 = 0 (キューの番号：受信キュー)
000902 4EBA FEFA       521 		jsr    OUT_Q             | OUT_Q ==> %d0: success?, %d1: 取り出したデータ
000906 0C40 0000       522 		cmp    #0, %d0           | OUT_Qの復帰値が成功(1)であるか確認 
00090a 6700 000A       523 		beq    END2_GETSTRING    | 失敗ならば復帰
00090e 1AC1            524 		move.b %d1, (%a5)+       | 書き込み先にデータを書き込み
000910 5244            525 		add    #1, %d4           | sz ++
000912 6000 FFE6       526 		bra    LOOP1_GETSTRING
                       527 END2_GETSTRING:
000916 3004            528 		move   %d4, %d0          | 返り値 %d0 = sz (実際に取り出したデータ数)
                       529 END_GETSTRING:
000918 4E75            530 		rts
                       531 
                       532 ******************************
                       533 ** RESET_TIMER():	タイマ割り込み→不可、タイマ→停止
                       534 ******************************
                       535 RESET_TIMER:
00091a 33FC 0004       536 		move.w	#0x0004, TCTL1 /* タイマ1コントロールレジスタに0x0004を設定→割り込
       00FF F600       536 
000922 4E75            537 		rts
                       538 		
                       539 ******************************
                       540 ** SET_TIMER(t,p):	タイマ割り込み時に呼び出すルーチン設定 
                       541 **			タイマ割り込み周期tを設定（t * 0.1 msec毎に割り込み発生）
                       542 **			タイマ使用およびタイマ割り込み	
                       543 ** 引数 :		t→%d1.w:	タイマの発生周期
                       544 ** 			p→%d2.l	割り込み時に起動するルーチンの先頭アドレス			
                       545 ******************************
                       546 SET_TIMER:
000924 23C2 0000       547 		move.l	%d2, task_p /* 割り込み時に起動するルーチンの先頭アドレスpを大域
       0000            547 
00092a 33FC 00CE       548 		move.w	#0xce, TPRER1 /* 0.1msec進むとカウンタが1増えるようにする */
       00FF F602       548 
000932 33C1 00FF       549 		move.w	%d1, TCMP1 /* t秒周期に設定 */
       F604            549 
000938 33FC 0015       550 		move.w  #0x0015, TCTL1 /* タイマ1コントロールレジスタに0x0015を設定→割り込
       00FF F600       550 
000940 13FC 004D       551 		move.b	#'M', LED7
       00D0 002F       551 
000948 13FC 004D       552 		move.b	#'M', LED6
       00D0 002D       552 
000950 13FC 003A       553 		move.b  #':', LED5
       00D0 002B       553 
000958 13FC 0053       554 		move.b	#'S', LED4
       00D0 0029       554 
000960 13FC 0053       555 		move.b	#'S', LED3
       00D0 003F       555 
000968 13FC 002E       556 		move.b	#'.', LED2
       00D0 003D       556 
000970 13FC 0066       557 		move.b	#'f', LED1
       00D0 003B       557 
000978 13FC 0066       558 		move.b	#'f', LED0
       00D0 0039       558 
000980 4E75            559 		rts
                       560 
                       561 ******************************
                       562 ** CALL_RP():	タイマ割り込み時に処理すべきルーチン呼び出し
                       563 ******************************
                       564 CALL_RP:
000982 48E7 0080       565 		movem.l	%a0, -(%sp)
000986 2079 0000       566 		movea.l task_p, %a0
       0000            566 
00098c 4E90            567 		jsr (%a0)
00098e 4CDF 0100       568 		movem.l (%sp)+, %a0
000992 4E75            569 		rts
                       570 
                       571 *******************************************
                       572 ** システムコールインターフェース
                       573 ** 入力：
                       574 **　　　　システムコール番号   : %d0.l
                       575 **　　　　システムコールの引数 : %d1以降
                       576 ** 出力：
                       577 **　　　　システムコール呼び出しの結果 : %d0.l
                       578 ** ========================================		
                       579 **        +---+---------------+
                       580 **        | 1 | GETSTRING     |
                       581 **        | 2 | PUTSTRING     |
                       582 **        | 3 | RESET_TIMER   |
                       583 **        | 4 | SET_TIMER     |
                       584 **        +---+---------------+
                       585 *******************************************
                       586 SYS_CALL:
                       587 		
                       588 CALL_1:		
000994 0C80 0000       589 		cmpi.l #1, %d0   | コール番号の確認(no.1)
       0001            589 
00099a 6600 000A       590 		bne    CALL_2    | 異なれば他のコール番号の確認
00099e 4EBA FF4C       591 		jsr    GETSTRING | 対応するシステムコールを呼び出し
0009a2 6000 0034       592                 bra    END_SYS_CALL
                       593 CALL_2:
0009a6 0C80 0000       594 		cmpi.l #2, %d0
       0002            594 
0009ac 6600 000A       595 		bne    CALL_3
0009b0 4EBA FEF8       596 		jsr    PUTSTRING
0009b4 6000 0022       597                 bra    END_SYS_CALL
                       598 CALL_3:
0009b8 0C80 0000       599 		cmpi.l #3, %d0
       0003            599 
0009be 6600 000A       600 		bne    CALL_4
0009c2 4EBA FF56       601 		jsr    RESET_TIMER
0009c6 6000 0010       602                 bra    END_SYS_CALL
                       603 CALL_4:
0009ca 0C80 0000       604 		cmpi.l #4, %d0
       0004            604 
0009d0 6600 0006       605 		bne    END_SYS_CALL
0009d4 4EBA FF4E       606 		jsr    SET_TIMER
                       607 END_SYS_CALL:	
0009d8 4E73            608 		rte		
                       609 ***************************************************************
                       610 ** スタック領域の確保
                       611 ***************************************************************
                       612 .section .bss
                       613 .even
                       614 SYS_STK:
000c20 0000 0000       615 		.ds.b  0x4000 | システムスタック領域
       0000 0000       615 
       0000 0000       615 
       0000 0000       615 
       0000 0000       615 
                       616 		.even
                       617 SYS_STK_TOP: 		      | システムスタック領域の最後尾
                       618 
004c20 0000 0000       619 task_p:		.ds.l 1	      | タイマ割り込み時に起動するルーチン先頭アドレス代
                       620 ****************************************************************
                       621 ***初期値のあるデータ領域***************************************************************
                       622 .section .data
                       623 TMSG:
0009dc 2A2A 2A2A       624 		.ascii  "******\r\n"      | \r:行頭へ(キャリッジリターン)
       2A2A 0D0A       624 
                       625 		.even                     | \n:次の行へ(ラインフィード)
                       626 
                       627 ******************************
                       628 ** 選択課題ゾーン
                       629 ** CS1, CS2 -> 小数第2位、第1位
                       630 **  SS1,  SS1 -> 秒数1の位、10の位
                       631 **  MM1,  MM2 ->  分数1の位、10の位
                       632 **  MMSSFF       ->  ターミナル表示用メモリ領域
                       633 ** BACK     -> ターミナル表示用ヘッダ(\rTIME = )
                       634 ** COLON    -> :(0x3a)
                       635 ** PERIOED  -> .(0x2e)
                       636 ******************************
                       637 
                       638 BACK:
0009e4 0D54 494D       639 		.ascii  "\rTIME = "
       4520 3D20       639 
                       640 		.even
                       641 MMSSFF:
0009ec 3132 3A33       642 		.ascii  "12:34.56"
       342E 3536       642 
                       643 		.even     
                       644 TTC:
0009f4 0030            645 		.dc.w  0x30
                       646 		.even
                       647 MM2:
0009f6 30              648 		.dc.b  0x30
0009f7 00              649 		.even
                       650 MM1:
0009f8 30              651 		.dc.b  0x30
0009f9 00              652 		.even
                       653 COLON:
0009fa 3A              654 		.dc.b  0x3a
0009fb 00              655 		.even
                       656 SS2:
0009fc 30              657 		.dc.b  0x30
0009fd 00              658 		.even
                       659 SS1:
0009fe 30              660 		.dc.b  0x30
0009ff 00              661 		.even
                       662 PERIOD:
000a00 2E              663 		.dc.b  0x2e
000a01 00              664 		.even
                       665 CS2:
000a02 30              666 		.dc.b  0x30
000a03 00              667 		.even
                       668 CS1:
000a04 30              669 		.dc.b  0x30
000a05 00              670 		.even
                       671 
                       672 ****************************************************************
                       673 ***初期値の無いデータ領域***************************************************************
                       674 .section .bss
                       675 BUF:
004c24 0000 0000       676 		.ds.b 256      |BUF[256]
       0000 0000       676 
       0000 0000       676 
       0000 0000       676 
       0000 0000       676 
                       677 		.even
                       678 USR_STK:
004d24 0000 0000       679 		.ds.b 0x4000   |ユーザスタック領域
       0000 0000       679 
       0000 0000       679 
       0000 0000       679 
       0000 0000       679 
                       680 		.even
                       681 USR_STK_TOP:                   |ユーザスタック領域の最後尾		
                       682 
                       683 
                       684 ******************************
                       685 ** キュー用のメモリ領域確保
                       686 ******************************
                       687 .section .data
                       688 		.equ  B_SIZE, 256
                       689 top0:
000a06 0000 0000       690 		.ds.b B_SIZE-1
       0000 0000       690 
       0000 0000       690 
       0000 0000       690 
       0000 0000       690 
                       691 bottom0:
000b05 00              692 		.ds.b 1
                       693 top1:
000b06 0000 0000       694 		.ds.b B_SIZE-1
       0000 0000       694 
       0000 0000       694 
       0000 0000       694 
       0000 0000       694 
                       695 bottom1:
000c05 00              696 		.ds.b 1
                       697 out0:
000c06 0000 0000       698 		.ds.l 1
                       699 out1:
000c0a 0000 0000       700 		.ds.l 1
                       701 in0:
000c0e 0000 0000       702 		.ds.l 1
                       703 in1:
000c12 0000 0000       704 		.ds.l 1
                       705 s0:
000c16 0000 0000       706 		.ds.l 1
                       707 s1:
000c1a 0000 0000       708 		.ds.l 1
                       709 
                       710 .end
