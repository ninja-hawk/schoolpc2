                         4 .list
                         5 ***************************************************************
                         6 ** 各種レジスタ定義
                         7 ***************************************************************
                         8 
                         9 ***************
                        10 ** レジスタ群の先頭
                        11 ***************
                        12 .equ REGBASE, 0xFFF000  | DMAP を使用.
                        13 .equ IOBASE,  0x00d00000
                        14 
                        15 ***************
                        16 ** 割り込み関係のレジスタ
                        17 ***************
                        18 .equ IVR,     REGBASE+0x300 | 割り込みベクタレジスタ
                        19 .equ IMR,     REGBASE+0x304 | 割り込みマスクレジスタ
                        20 .equ ISR,     REGBASE+0x30c | 割り込みステータスレジスタ
                        21 .equ IPR,     REGBASE+0x310 | 割り込みペンディングレジスタ
                        22 
                        23 
                        24 ***************
                        25 ** タイマ関係のレジスタ
                        26 ***************
                        27 .equ TCTL1,   REGBASE+0x600 | タイマ1コントロールレジスタ
                        28 .equ TPRER1,  REGBASE+0x602 | タイマ1プリスケーラレジスタ
                        29 .equ TCMP1,   REGBASE+0x604 | タイマ1コンペアレジスタ
                        30 .equ TCN1,    REGBASE+0x608 | タイマ1カウンタレジスタ
                        31 .equ TSTAT1,  REGBASE+0x60a | タイマ1ステータスレジスタ
                        32 ***************
                        33 ** UART1 (送受信)関係のレジスタ
                        34 ***************
                        35 .equ USTCNT1, REGBASE+0x900 | UART1 ステータス / コントロールレジスタ
                        36 .equ UBAUD1,  REGBASE+0x902 | UART1 ボーコントロールレジスタ
                        37 .equ URX1,    REGBASE+0x904 | UART1 受信レジスタ
                        38 .equ UTX1,    REGBASE+0x906 | UART1 送信レジスタ
                        39 ***************
                        40 ** LED
                        41 ***************
                        42 .equ LED7,  IOBASE+0x000002f | ボード搭載のLED用レジスタ
                        43 .equ LED6,  IOBASE+0x000002d | 使用法については付録 A.4.3.1
                        44 .equ LED5,  IOBASE+0x000002b
                        45 .equ LED4,  IOBASE+0x0000029
                        46 .equ LED3,  IOBASE+0x000003f
                        47 .equ LED2,  IOBASE+0x000003d
                        48 .equ LED1,  IOBASE+0x000003b
                        49 .equ LED0,  IOBASE+0x0000039
                        50 
                        51 ***************************************************************
                        52 ** スタック領域の確保
                        53 ***************************************************************
                        54 .section .bss
                        55 .even
                        56 SYS_STK:
000884 0000 0000        57 		.ds.b  0x4000 | システムスタック領域
       0000 0000        57 
       0000 0000        57 
       0000 0000        57 
       0000 0000        57 
                        58 		.even
                        59 SYS_STK_TOP: 		      | システムスタック領域の最後尾
                        60 
004884 0000 0000        61 task_p:		.ds.l 1		| タイマ割り込み時に起動するルーチン先頭アドレス代入用
                        62 
                        63 ***************************************************************
                        64 ** 初期化
                        65 ** 内部デバイスレジスタには特定の値が設定されている.
                        66 ** その理由を知るには,付録 B にある各レジスタの仕様を参照すること.
                        67 ***************************************************************
                        68 .section .text
                        69 .even
                        70 boot:
                        71 		* スーパーバイザ & 各種設定を行っている最中の割込禁止
000400 13FC 0041        72 		move.b	#'A', LED7
       00D0 002F        72 
000408 46FC 2000        73 		move.w #0x2000,%SR
00040c 4FF9 0000        74 		lea.l SYS_STK_TOP, %SP | Set SSP
       0000             74 
                        75 		****************
                        76 		** 割り込みコントローラの初期化
                        77 		****************
000412 13FC 0040        78 		move.b #0x40, IVR      | ユーザ割り込みベクタ番号を
       00FF F300        78 
                        79 		                       | 0x40+level に設定.
00041a 23FC 00FF        80 		move.l #0x00ff3ffb,IMR | 全割り込みマスク
       3FFB 00FF        80 
       F304             80 
000424 13FC 0042        81 		move.b	#'B', LED6
       00D0 002D        81 
                        82 		****************
                        83 		** 送受信 (UART1) 関係の初期化 ( 割り込みレベルは 4 に固定されている )
                        84 		****************
00042c 21FC 0000        85 		move.l #UART1_interrupt, 0x110  | 受信割り込みベクタをセット
       0000 0110        85 
000434 13FC 0043        86 		move.b	#'C', LED5
       00D0 002B        86 
00043c 33FC 0000        87 		move.w #0x0000, USTCNT1 | リセット
       00FF F900        87 
000444 13FC 0044        88 		move.b	#'D', LED4
       00D0 0029        88 
00044c 33FC E10C        89 		move.w #0xe10c, USTCNT1 | 送受信可能,パリティなし,1stop,8bit
       00FF F900        89 
000454 13FC 0045        90 		move.b	#'E', LED3
       00D0 003F        90 
                        91 					| 受信割り込み許可,送割り込み禁止
00045c 13FC 0046        92 		move.b	#'F', LED2
       00D0 003D        92 
000464 33FC 0038        93 		move.w #0x0038, UBAUD1  | baud rate = 230400 bps
       00FF F902        93 
00046c 13FC 0047        94 		move.b	#'G', LED1
       00D0 003B        94 
                        95 		****************
                        96 		** タイマ関係の初期化 ( 割り込みレベルは 6 に固定されている )
                        97 		*****************
000474 33FC 0004        98 		move.w #0x0004, TCTL1   | restart, 割り込み不可 ,
       00FF F600        98 
                        99 					| システムクロックの 1/16 を単位として計時,
                       100 					| タイマ使用停止
00047c 13FC 0047       101 		move.b	#'G', LED7
       00D0 002F       101 
                       102 					
000484 4EBA 017A       103 	    jsr Init_Q
000488 6000 01B0       104 		bra MAIN
                       105 
                       106 *************************************
                       107 ** UART1_interrupt
                       108 *************************************
                       109 UART1_interrupt:
                       110 		*move.b #'1', LED7
00048c 0839 000F       111 		btst.l #15, UTX1      |  15ビット目は送信キューが空であるか
       00FF F906       111 
000494 6600 000C       112 		bne    CALL_INTERGET  |  if UTX1[15] !=0  (空のとき)
                       113 		*move.b #'2', LED5
000498 7200            114 		move.l #0, %d1        |  ch = 0 を明示
00049a 4EBA 0008       115 		jsr    INTERPUT       |  送信割り込み時処理
00049e 6000 0002       116 		bra    END_interrupt
                       117 CALL_INTERGET:
                       118 		*jsr   INTERGET
                       119 		*move.b #'2', LED6
                       120 END_interrupt:
0004a2 4E73            121 		rte
                       122 
                       123 *************************************
                       124 ** INTERPUT :  送信割り込み時の処理	
                       125 ** 引数     :  %d1.l = チャネル(ch)	
                       126 *************************************
                       127 INTERPUT:
                       128 		*move.b  #'3', LED4
0004a4 46FC 2700       129 		move.w  #0x2700, %SR | 走行レベルを７に設定
0004a8 0C81 0000       130 		cmpi.l  #0, %d1      | ch = 0 を確認
       0000            130 
0004ae 6600 0022       131 		bne     END_INTERPUT | if ch != 0 => 復帰
                       132 		/* OUTQがあるとして... */
0004b2 7001            133 		move.l  #1, %d0
0004b4 4EBA 001E       134 		jsr     OUT_Q   | %d1.b = data
0004b8 0C40 0000       135 		cmpi    #0, %d0      | %d0(OUTQの戻り値) == 0(失敗)
0004bc 6600 000A       136 		bne     TX_DATA      | ==> 送信割り込みをマスク(真下)
0004c0 33FC E108       137 		move.w  #0xe108, USTCNT1
       00FF F900       137 
                       138 TX_DATA:
                       139 		*move.b  #'3', LED2
0004c8 0641 0800       140 		add.w   #0x0800, %d1 | ヘッダを付与
0004cc 33C1 00FF       141 		move.w  %d1, UTX1
       F906            141 
                       142 END_INTERPUT:
                       143 		*move.b  #'3', LED1
0004d2 4E75            144 		rts
                       145 
                       146 ******************************
                       147 		** OUTQ
                       148 		**入力:キュー番号:d0.l
                       149 		**出力:d0:0失敗, d0:1成功
                       150 		**取り出したデータ:d1.b
                       151 ******************************
                       152 OUT_Q:		
0004d4 103C 0001       153                 move.b #1, %d0
0004d8 0C00 0000       154 		cmp.b #0x00, %d0/*noの値で分岐*/
0004dc 6600 0008       155 		bne o_loop1
0004e0 4EBA 000A       156 		jsr OUTQ0
0004e4 4E75            157 		rts
                       158 o_loop1:
0004e6 4EBA 0050       159 		jsr OUTQ1
0004ea 4E75            160 		rts
                       161 OUTQ0:
0004ec 40E7            162 		move.w %sr,-(%sp)
0004ee 48E7 00F8       163 		movem.l %a0-%a4,-(%sp) /* レジスタ退避(1) */
0004f2 46FC 2700       164 		move.w  #0x2700, %SR /*走行レベル7(2)*/
0004f6 3039 0000       165 		move.w  s0, %d0 /* sの値によって実行できるか判定(3) */
       0000            165 
0004fc 0C40 0000       166 		cmp.w  #0x00, %d0 /* sが0のときd0を0x0:失敗  */
000500 6700 002E       167 		beq     o0_Finish /* 0x0でキューが空なら終了 */
000504 2279 0000       168 		movea.l out0, %a1 /* 次に取り出すのポインタアドレスをa1レジスタへ (4)*/
       0000            168 
00050a 1219            169 		move.b  (%a1)+, %d1 /* キューからデータを読み出し、d1に転送 */
00050c 45F9 0000       170 		lea.l bottom0, %a2 /*次に読み出そうとしているアドレスとキュー領域の末尾
       0000            170 
000512 B3CA            171 		cmp.l  %a2, %a1 
000514 6300 000A       172 		bls     o0_STEP1 /* a1 < a2　ならばSTEP1へ(out++) */
000518 47F9 0000       173 		lea.l top0, %a3 /*out=top*/
       0000            173 
00051e 224B            174 		move.l  %a3, %a1
                       175 o0_STEP1:
000520 23C9 0000       176 		move.l %a1, out0
       0000            176 
000526 5379 0000       177 		sub.w #1, s0 /*s--*/
       0000            177 
00052c 303C 0001       178 		move.w  #1, %d0/* 処理できたのでd0を1に */
                       179 o0_Finish:
000530 4CDF 1F00       180 		movem.l (%sp)+, %a0-%a4 /* レジスタ復帰 */
000534 46DF            181 		move.w (%sp)+, %sr
000536 4E75            182 		rts /* サブルーチンを抜ける */		
                       183 OUTQ1:
000538 40E7            184 		move.w %sr,-(%sp)
00053a 48E7 00F8       185 		movem.l %a0-%a4,-(%sp) /* レジスタ退避(1) */
00053e 46FC 2700       186 		move.w  #0x2700, %SR /*走行レベル7(2)*/
000542 3039 0000       187 		move.w  s1, %d0 /* sの値によって実行できるか判定(3) */
       0000            187 
000548 0C40 0000       188 		cmp.w #0x00, %d0 /* sが0のときd0を0x0:失敗  */
00054c 6700 002E       189 		beq     o1_Finish /* 0x0でキューが空なら終了 */
000550 2279 0000       190 		movea.l out1, %a1 /* 次に取り出すのポインタアドレスをa1レジスタへ (4)*/
       0000            190 
000556 1219            191 		move.b  (%a1)+, %d1 /* キューからデータを読み出し、d1に転送 */
000558 45F9 0000       192 		lea.l bottom1, %a2/*次に読み出そうとしているアドレスとキュー領域の末尾
       0000            192 
00055e B3CA            193 		cmp.l  %a2, %a1 
000560 6300 000A       194 		bls     o1_STEP1/* a1 < a2　ならばSTEP1へ(out++) */
000564 47F9 0000       195 		lea.l top1, %a3/*out=top*/
       0000            195 
00056a 224B            196 		move.l  %a3, %a1
                       197 o1_STEP1:
00056c 23C9 0000       198 		move.l %a1, out1
       0000            198 
000572 5379 0000       199 		sub.w #1, s1
       0000            199 
000578 303C 0001       200 		move.w  #1, %d0/* 処理できたのでd0を1に */
                       201 o1_Finish:
00057c 4CDF 1F00       202 		movem.l (%sp)+, %a0-%a4 /* レジスタ復帰 */
000580 46DF            203 		move.w (%sp)+, %sr
000582 4E75            204 		rts /* サブルーチンを抜ける */
                       205 
                       206 
                       207 ******************************
                       208 ** RESET_TIMER():	タイマ割り込み→不可、タイマ→停止
                       209 ******************************
                       210 RESET_TIMER:
000584 33FC 0004       211 		move.w	#0x0004, TCTL1 /* タイマ1コントロールレジスタに0x0004を設定→割り込
       00FF F600       211 
00058c 4E75            212 		rts
                       213 
                       214 ******************************
                       215 ** SET_TIMER(t,p):	タイマ割り込み時に呼び出すルーチン設定 
                       216 **			タイマ割り込み周期tを設定（t * 0.1 msec毎に割り込み発生）
                       217 **			タイマ使用およびタイマ割り込み	
                       218 ** 引数 :		t→%d1.w:	タイマの発生周期
                       219 ** 			p→%d2.l	割り込み時に起動するルーチンの先頭アドレス			
                       220 ******************************
                       221 SET_TIMER:
00058e 23C2 0000       222 		move.l	%d2, task_p /* 割り込み時に起動するルーチンの先頭アドレスpを大域
       0000            222 
000594 33FC 0086       223 		move.w	#0206, TPRER1 /* 0.1msec進むとカウンタが1増えるようにする */
       00FF F602       223 
00059c 33C1 00FF       224 		move.w	%d1, TCMP1 /* t秒周期に設定 */
       F604            224 
0005a2 33FC 0015       225 		move.w  #0x0015, TCTL1 /* タイマ1コントロールレジスタに0x0015を設定→割り込
       00FF F600       225 
0005aa 4E75            226 		rts
                       227 
                       228 ******************************
                       229 ** CALL_RP():	タイマ割り込み時に処理すべきルーチン呼び出し
                       230 ******************************
                       231 CALL_RP:
0005ac 48E7 0080       232 		movem.l	%a0, -(%sp)
0005b0 2079 0000       233 		movea.l task_p, %a0
       0000            233 
0005b6 4E90            234 		jsr (%a0)
0005b8 4CDF 0100       235 		movem.l (%sp)+, %a0
0005bc 4E75            236 		rts
                       237 
                       238 
                       239 
                       240 TEST_LIGHT:
0005be 13FC 0047       241 		move.b	#'G', LED7
       00D0 002F       241 
0005c6 13FC 0052       242 		move.b	#'R', LED6
       00D0 002D       242 
0005ce 13FC 0038       243 		move.b	#'8', LED5
       00D0 002B       243 
0005d6 13FC 0054       244 		move.b	#'T', LED4
       00D0 0029       244 
0005de 13FC 0049       245 		move.b	#'I', LED3
       00D0 003F       245 
0005e6 13FC 004D       246 		move.b	#'M', LED2
       00D0 003D       246 
0005ee 13FC 0045       247 		move.b	#'E', LED1
       00D0 003B       247 
0005f6 13FC 0052       248 		move.b	#'R', LED0
       00D0 0039       248 
0005fe 4E75            249 		rts
                       250 
                       251 
                       252 
                       253 
                       254 
                       255 ******************************
                       256 ** キューの初期化
                       257 ******************************
                       258 Init_Q:
000600 45F9 0000       259 lea.l top0, %a2
       0000            259 
000606 47F9 0000       260 lea.l top1, %a3
       0000            260 
00060c 23CA 0000       261 move.l %a2, out0
       0000            261 
000612 23CB 0000       262 move.l %a3, out1
       0000            262 
000618 23CA 0000       263 move.l %a2, in0
       0000            263 
00061e 23CB 0000       264 move.l %a3, in1
       0000            264 
000624 23FC 0000       265 move.l #0, s0
       0000 0000       265 
       0000            265 
00062e 23FC 0000       266 move.l #0, s1
       0000 0000       266 
       0000            266 
000638 4E75            267 rts
                       268 
                       269 
                       270 
                       271 
                       272 
                       273 ******************************
                       274 ** キュー用のメモリ領域確保
                       275 ******************************
                       276 .section .data
                       277 .equ B_SIZE, 256
000670 0000 0000       278 top0:.ds.b B_SIZE-1
       0000 0000       278 
       0000 0000       278 
       0000 0000       278 
       0000 0000       278 
00076f 00              279 bottom0:.ds.b 1
000770 0000 0000       280 top1:.ds.b B_SIZE-1
       0000 0000       280 
       0000 0000       280 
       0000 0000       280 
       0000 0000       280 
00086f 00              281 bottom1:.ds.b 1
000870 0000 0000       282 out0:.ds.l 1
000874 0000 0000       283 out1:.ds.l 1
000878 0000 0000       284 in0:.ds.l 1
00087c 0000 0000       285 in1:.ds.l 1
000880 0000            286 s0:.ds.w 1
000882 0000            287 s1:.ds.w 1
                       288 		
                       289 		
                       290 		
                       291 		
                       292 ***************************************************************
                       293 ** 現段階での初期化ルーチンの正常動作を確認するため,最後に ’a’ を
                       294 ** 送信レジスタ UTX1 に書き込む. ’a’ が出力されれば, OK.
                       295 ***************************************************************
                       296 .section .text
                       297 .even
                       298 MAIN:
                       299 	        *move.w #0x0800+'A', UTX1
00063a 4EBA FF48       300 		jsr	RESET_TIMER
00063e 243C 0000       301 		move.l	#TEST_LIGHT, %d2
       0000            301 
000644 323C C350       302 		move.w	#50000, %d1
000648 4EBA FF44       303 		jsr	SET_TIMER
00064c 13FC 0047       304 		move.b	#'G', LED7
       00D0 002F       304 
                       305 
                       306 		
                       307 LOOP:
                       308 ******************************
                       309 ** COMPARE_INTERPUT:	タイマ用のハードウェア割り込みインターフェース
                       310 ******************************
                       311 COMPARE_INTERPUT:
000654 0839 0000       312 		btst	#0, TSTAT1 /* タイマ1ステータスレジスタの0ビット目が0か、否か */
       00FF F60A       312 
00065c 6700 000E       313 		beq	COMPARE_END /* 0ならコンペアイベントなし、つまりカウンタ値とコンペ
000660 33FC 0000       314 		move.w	#0x0000, TSTAT1 /* タイマ1ステータスレジスタを0クリア */
       00FF F60A       314 
000668 4EBA FF42       315 		jsr	CALL_RP /* CALL_RPを呼び出す */
                       316 
                       317 COMPARE_END:
                       318 		*rte
                       319 
00066c 6000 FFE6       320 		bra LOOP		
                       321 
                       322 
