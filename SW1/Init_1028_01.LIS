                         4 .list
                         5 ***************************************************************
                         6 ** 各種レジスタ定義
                         7 ***************************************************************
                         8 
                         9 ***************
                        10 ** レジスタ群の先頭
                        11 ***************
                        12 .equ REGBASE, 0xFFF000  | DMAP を使用.
                        13 .equ IOBASE,  0x00d00000
                        14 
                        15 ***************
                        16 ** 割り込み関係のレジスタ
                        17 ***************
                        18 .equ IVR,     REGBASE+0x300 | 割り込みベクタレジスタ
                        19 .equ IMR,     REGBASE+0x304 | 割り込みマスクレジスタ
                        20 .equ ISR,     REGBASE+0x30c | 割り込みステータスレジスタ
                        21 .equ IPR,     REGBASE+0x310 | 割り込みペンディングレジスタ
                        22 
                        23 
                        24 ***************
                        25 ** タイマ関係のレジスタ
                        26 ***************
                        27 .equ TCTL1,   REGBASE+0x600 | タイマ1コントロールレジスタ
                        28 .equ TPRER1,  REGBASE+0x602 | タイマ1プリスケーラレジスタ
                        29 .equ TCMP1,   REGBASE+0x604 | タイマ1コンペアレジスタ
                        30 .equ TCN1,    REGBASE+0x608 | タイマ1カウンタレジスタ
                        31 .equ TSTAT1,  REGBASE+0x60a | タイマ1ステータスレジスタ
                        32 ***************
                        33 ** UART1 (送受信)関係のレジスタ
                        34 ***************
                        35 .equ USTCNT1, REGBASE+0x900 | UART1 ステータス / コントロールレジスタ
                        36 .equ UBAUD1,  REGBASE+0x902 | UART1 ボーコントロールレジスタ
                        37 .equ URX1,    REGBASE+0x904 | UART1 受信レジスタ
                        38 .equ UTX1,    REGBASE+0x906 | UART1 送信レジスタ
                        39 ***************
                        40 ** LED
                        41 ***************
                        42 .equ LED7,  IOBASE+0x000002f | ボード搭載のLED用レジスタ
                        43 .equ LED6,  IOBASE+0x000002d | 使用法については付録 A.4.3.1
                        44 .equ LED5,  IOBASE+0x000002b
                        45 .equ LED4,  IOBASE+0x0000029
                        46 .equ LED3,  IOBASE+0x000003f
                        47 .equ LED2,  IOBASE+0x000003d
                        48 .equ LED1,  IOBASE+0x000003b
                        49 .equ LED0,  IOBASE+0x0000039
                        50 
                        51 ***************************************************************
                        52 ** スタック領域の確保
                        53 ***************************************************************
                        54 .section .bss
                        55 .even
                        56 SYS_STK:
000b58 0000 0000        57 		.ds.b  0x4000 | システムスタック領域
       0000 0000        57 
       0000 0000        57 
       0000 0000        57 
       0000 0000        57 
                        58 		.even
                        59 SYS_STK_TOP: 		      | システムスタック領域の最後尾
                        60 
                        61 ***************************************************************
                        62 ** 初期化
                        63 ** 内部デバイスレジスタには特定の値が設定されている.
                        64 ** その理由を知るには,付録 B にある各レジスタの仕様を参照すること.
                        65 ***************************************************************
                        66 .section .text
                        67 .even
                        68 boot:
                        69 		* スーパーバイザ & 各種設定を行っている最中の割込禁止
000400 46FC 2000        70 		move.w #0x2000,%SR
000404 4FF9 0000        71 		lea.l SYS_STK_TOP, %SP | Set SSP
       0000             71 
                        72 		****************
                        73 		** 割り込みコントローラの初期化
                        74 		****************
00040a 13FC 0040        75 		move.b #0x40, IVR      | ユーザ割り込みベクタ番号を
       00FF F300        75 
                        76 		                       | 0x40+level に設定.
000412 23FC 00FF        77 		move.l #0x00fffffb,IMR | 全割り込みマスク
       FFFB 00FF        77 
       F304             77 
                        78 		****************
                        79 		** 送受信 (UART1) 関係の初期化 ( 割り込みレベルは 4 に固定されている )
                        80 		****************
00041c 21FC 0000        81 		move.l #UART1_interrupt, 0x110  | 受信割り込みベクタをセット
       0000 0110        81 
000424 33FC 0000        82 		move.w #0x0000, USTCNT1 | リセット
       00FF F900        82 
00042c 33FC E138        83 		move.w #0xe138, USTCNT1 | 送受信可能 , パリティなし , 1 stop, 8 bit, /* 変更 */
       00FF F900        83 
                        84 					| 受信割り込み許可, 送割り込み禁止
000434 33FC 0038        85 		move.w #0x0038, UBAUD1  | baud rate = 230400 bps
       00FF F902        85 
                        86 		****************
                        87 		** タイマ関係の初期化 ( 割り込みレベルは 6 に固定されている )
                        88 		*****************
00043c 33FC 0004        89 		move.w #0x0004, TCTL1   | restart, 割り込み不可 ,
       00FF F600        89 
                        90 					| システムクロックの 1/16 を単位として計時,
                        91 					| タイマ使用停止
                        92 IN_Q:		
000444 4EBA 0134        93 		jsr Init_Q
000448 6000 0124        94 		bra MAIN
                        95 
                        96 *************************************
                        97 ** UART1_interrupt
                        98 *************************************
                        99 UART1_interrupt:
00044c 13FC 0031       100 		move.b #'1', LED7
       00D0 002F       100 
000454 0839 000F       101 		btst.l #15, UTX1      |  15ビット目は送信キューが空であるか
       00FF F906       101 
00045c 6700 0014       102 		beq    CALL_INTERGET  |  if UTX1[15] == 1 (空のとき)
000460 13FC 0032       103 		move.b #'2', LED5
       00D0 002B       103 
000468 7200            104 		move.l #0, %d1        |  ch = 0 を明示
00046a 4EBA 0010       105 		jsr    INTERPUT       |  送信割り込み時処理
00046e 6000 000A       106 		bra    END_interrupt
                       107 CALL_INTERGET:
                       108 		*jsr   INTERGET
000472 13FC 0032       109 		move.b #'2', LED6
       00D0 002D       109 
                       110 END_interrupt:
00047a 4E73            111 		rte
                       112 
                       113 *************************************
                       114 ** INTERPUT :  送信割り込み時の処理	
                       115 ** 引数     :  %d1.l = チャネル(ch)	
                       116 *************************************
                       117 INTERPUT:
00047c 13FC 0033       118 		move.b  #'3', LED4
       00D0 0029       118 
000484 46FC 2700       119 		move.w  #0x2700, %SR | 走行レベルを７に設定
000488 0C81 0000       120 		cmpi.l  #0, %d1      | ch = 0 を確認
       0000            120 
00048e 6600 0028       121 		bne     END_INTERPUT | if ch != 0 => 復帰
                       122 		/* OUTQがあるとして... */
000492 4EBA 002E       123 		jsr     OUT_Q         | %d1.b = data
000496 0C40 0000       124 		cmpi    #0, %d0      | %d0(OUTQの戻り値) == 0(失敗)
00049a 6600 000A       125 		bne     TX_DATA      | ==> 送信割り込みをマスク(真下)
00049e 33FC E138       126 		move.w  #0xe138, USTCNT1
       00FF F900       126 
                       127 TX_DATA:
0004a6 13FC 0033       128 		move.b  #'3', LED2
       00D0 003D       128 
0004ae 0641 0800       129 		add.w   #0x0800, %d1 | ヘッダを付与
0004b2 33C1 00FF       130 		move.w  %d1, UTX1
       F906            130 
                       131 END_INTERPUT:
0004b8 13FC 0033       132 		move.b  #'3', LED1
       00D0 003B       132 
0004c0 4E75            133 		rts
                       134 
                       135 ******************************
                       136 ** OUTQ
                       137 ******************************
                       138 OUT_Q:		
0004c2 0C00 0000       139 		cmp.b #0x00, %d0/*noの値で分岐*/
0004c6 6600 0008       140 		bne o_loop1
0004ca 4EBA 000A       141 		jsr OUTQ0
0004ce 4E75            142 		rts
                       143 o_loop1:
0004d0 4EBA 0050       144 		jsr OUTQ1
0004d4 4E75            145 		rts
                       146 OUTQ0:
0004d6 40E7            147 		move.w %sr,-(%sp)
0004d8 48E7 00F8       148 		movem.l %a0-%a4,-(%sp) /* レジスタ退避(1) */
0004dc 46FC 2700       149 		move.w  #0x2700, %SR /*走行レベル7(2)*/
0004e0 3039 0000       150 		move.w  s0, %d0 /* 書き込み許可フラグをd0レジスタへ(3) */
       0000            150 
0004e6 0C40 0000       151 		cmp.w  #0x00, %d0 /* 書き込み許可フラグ 0x00:禁止 | 0xff:許可 */
0004ea 6700 002E       152 		beq     o0_Finish /* 0x100でキューが満杯なら終了 */
0004ee 2279 0000       153 		movea.l out0, %a1 /* 書き込み用のポインタアドレスをa1レジスタへ (4)*/
       0000            153 
0004f4 1219            154 		move.b  (%a1)+, %d1 /* データをキューへ入れ、書き込むデータアドレスと書
0004f6 45F9 0000       155 		lea.l botton0, %a2 
       0000            155 
0004fc B3CA            156 		cmp.l  %a2, %a1 /* 次書き込もうとしているアドレスa1とキューデータ領域の
0004fe 6300 000A       157 		bls     o0_STEP1 /* a1 < a3　ならば、そのままPUT_BUF_STEP1へ */
000502 47F9 0000       158 		lea.l top0, %a3
       0000            158 
000508 224B            159 		move.l  %a3, %a1
                       160 o0_STEP1:
00050a 23C9 0000       161 		move.l %a1, out0
       0000            161 
000510 5379 0000       162 		sub.w #1, s0
       0000            162 
000516 303C 0001       163 		move.w  #1, %d0/* キューが一杯でなくなったので読み出し用ポインタを「許
                       164 o0_Finish:
00051a 4CDF 1F00       165 		movem.l (%sp)+, %a0-%a4 /* レジスタ復帰 */
00051e 46DF            166 		move.w (%sp)+, %sr
000520 4E75            167 		rts /* サブルーチンを抜ける */		
                       168 OUTQ1:
000522 40E7            169 		move.w %sr,-(%sp)
000524 48E7 00F8       170 		movem.l %a0-%a4,-(%sp) /* レジスタ退避(1) */
000528 46FC 2700       171 		move.w  #0x2700, %SR /*走行レベル7(2)*/
00052c 3039 0000       172 		move.w  s1, %d0 /* 書き込み許可フラグをd0レジスタへ(3) */
       0000            172 
000532 0C40 0000       173 		cmp.w #0x00, %d0 /* 書き込み許可フラグ 0x00:禁止 | 0xff:許可 */
000536 6700 002E       174 		beq     o1_Finish /* 0x100でキューが満杯なら終了 */
00053a 2279 0000       175 		movea.l out1, %a1 /* 書き込み用のポインタアドレスをa1レジスタへ (4)*/
       0000            175 
000540 1219            176 		move.b  (%a1)+, %d1 /* データをキューへ入れ、書き込むデータアドレスと書
000542 45F9 0000       177 		lea.l botton1, %a2
       0000            177 
000548 B3CA            178 		cmp.l  %a2, %a1 /* 次書き込もうとしているアドレスa1とキューデータ領域の
00054a 6300 000A       179 		bls     o1_STEP1 /* a1 < a3　ならば、そのままPUT_BUF_STEP1へ */
00054e 47F9 0000       180 		lea.l top1, %a3
       0000            180 
000554 224B            181 		move.l  %a3, %a1
                       182 o1_STEP1:
000556 23C9 0000       183 		move.l %a1, out1
       0000            183 
00055c 5379 0000       184 		sub.w #1, s1
       0000            184 
000562 303C 0001       185 		move.w  #1, %d0/* キューが一杯でなくなったので読み出し用ポインタを「許
                       186 o1_Finish:
000566 4CDF 1F00       187 		movem.l (%sp)+, %a0-%a4 /* レジスタ復帰 */
00056a 46DF            188 		move.w (%sp)+, %sr
00056c 4E75            189 		rts /* サブルーチンを抜ける */
                       190 		
                       191 		
                       192 ***************************************************************
                       193 ** 現段階での初期化ルーチンの正常動作を確認するため,最後に ’a’ を
                       194 ** 送信レジスタ UTX1 に書き込む. ’a’ が出力されれば, OK.
                       195 ***************************************************************
                       196 .section .text
                       197 .even
                       198 MAIN:
00056e 33FC 0841       199 	        move.w #0x0800+'A', UTX1
       00FF F906       199 
                       200 		
                       201 LOOP:
000576 6000 FFFE       202 		bra LOOP		
                       203 
                       204 ******************************
                       205 ** キューの初期化
                       206 ******************************
                       207 Init_Q:
00057a 45F9 0000       208 lea.l top0, %a2
       0000            208 
000580 47F9 0000       209 lea.l top1, %a3
       0000            209 
000586 23CA 0000       210 move.l %a2, out0
       0000            210 
00058c 23CB 0000       211 move.l %a3, out1
       0000            211 
000592 23CA 0000       212 move.l %a2, in0
       0000            212 
000598 23CB 0000       213 move.l %a3, in1
       0000            213 
00059e 23FC 0000       214 move.l #0, s0
       0000 0000       214 
       0000            214 
0005a8 23FC 0000       215 move.l #0, s1
       0000 0000       215 
       0000            215 
0005b2 4E75            216 rts
                       217 
                       218 
                       219 
                       220 
                       221 
                       222 ******************************
                       223 ** キュー用のメモリ領域確保
                       224 ******************************
                       225 .section .data
                       226 .equ B_SIZE, 256
0005b4 0000 0000       227 top0:.ds.b B_SIZE-1
       0000 0000       227 
       0000 0000       227 
       0000 0000       227 
       0000 0000       227 
0006b3 00              228 botton0:.ds.b 1
0006b4 0000 0000       229 top1:.ds.b B_SIZE-1
       0000 0000       229 
       0000 0000       229 
       0000 0000       229 
       0000 0000       229 
0007b3 00              230 botton1:.ds.b 1
0007b4 0000 0000       231 out0:.ds.l 1
0007b8 0000 0000       232 out1:.ds.l 1
0007bc 0000 0000       233 in0:.ds.l 1
0007c0 0000 0000       234 in1:.ds.l 1
0007c4 0000            235 s0:.ds.w 1
0007c6 0000            236 s1:.ds.w 1
                       237 **********
                       238 **sannpuru
                       239 **********
                       240 		.equ S2, 300
0007c8 0000 0000       241 D1:	.ds.b S2
       0000 0000       241 
       0000 0000       241 
       0000 0000       241 
       0000 0000       241 
0008f4 0000 0000       242 D2:	.ds.b S2
       0000 0000       242 
       0000 0000       242 
       0000 0000       242 
       0000 0000       242 
000a20 0000 0000       243 D3:	.ds.b S2
       0000 0000       243 
       0000 0000       243 
       0000 0000       243 
       0000 0000       243 
000b4c 4142 4344       244 D4:		.ascii "ABCDEFGHIJKL"
       4546 4748       244 
       494A 4B4C       244 
                       245 		
                       246 		**DATA_QUE  .ascii "ABC"
