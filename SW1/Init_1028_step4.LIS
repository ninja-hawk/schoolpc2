                         4 .list
                         5 ***************************************************************
                         6 ** 各種レジスタ定義
                         7 ***************************************************************
                         8 
                         9 ***************
                        10 ** レジスタ群の先頭
                        11 ***************
                        12 .equ REGBASE, 0xFFF000  | DMAP を使用.
                        13 .equ IOBASE,  0x00d00000
                        14 
                        15 ***************
                        16 ** 割り込み関係のレジスタ
                        17 ***************
                        18 .equ IVR,     REGBASE+0x300 | 割り込みベクタレジスタ
                        19 .equ IMR,     REGBASE+0x304 | 割り込みマスクレジスタ
                        20 .equ ISR,     REGBASE+0x30c | 割り込みステータスレジスタ
                        21 .equ IPR,     REGBASE+0x310 | 割り込みペンディングレジスタ
                        22 
                        23 
                        24 ***************
                        25 ** タイマ関係のレジスタ
                        26 ***************
                        27 .equ TCTL1,   REGBASE+0x600 | タイマ1コントロールレジスタ
                        28 .equ TPRER1,  REGBASE+0x602 | タイマ1プリスケーラレジスタ
                        29 .equ TCMP1,   REGBASE+0x604 | タイマ1コンペアレジスタ
                        30 .equ TCN1,    REGBASE+0x608 | タイマ1カウンタレジスタ
                        31 .equ TSTAT1,  REGBASE+0x60a | タイマ1ステータスレジスタ
                        32 ***************
                        33 ** UART1 (送受信)関係のレジスタ
                        34 ***************
                        35 .equ USTCNT1, REGBASE+0x900 | UART1 ステータス / コントロールレジスタ
                        36 .equ UBAUD1,  REGBASE+0x902 | UART1 ボーコントロールレジスタ
                        37 .equ URX1,    REGBASE+0x904 | UART1 受信レジスタ
                        38 .equ UTX1,    REGBASE+0x906 | UART1 送信レジスタ
                        39 ***************
                        40 ** LED
                        41 ***************
                        42 .equ LED7,  IOBASE+0x000002f | ボード搭載のLED用レジスタ
                        43 .equ LED6,  IOBASE+0x000002d | 使用法については付録 A.4.3.1
                        44 .equ LED5,  IOBASE+0x000002b
                        45 .equ LED4,  IOBASE+0x0000029
                        46 .equ LED3,  IOBASE+0x000003f
                        47 .equ LED2,  IOBASE+0x000003d
                        48 .equ LED1,  IOBASE+0x000003b
                        49 .equ LED0,  IOBASE+0x0000039
                        50 
                        51 ***************************************************************
                        52 ** スタック領域の確保
                        53 ***************************************************************
                        54 .section .bss
                        55 .even
                        56 SYS_STK:
0007c8 0000 0000        57 		.ds.b  0x4000 | システムスタック領域
       0000 0000        57 
       0000 0000        57 
       0000 0000        57 
       0000 0000        57 
                        58 		.even
                        59 SYS_STK_TOP: 		      | システムスタック領域の最後尾
                        60 
                        61 ***************************************************************
                        62 ** 初期化
                        63 ** 内部デバイスレジスタには特定の値が設定されている.
                        64 ** その理由を知るには,付録 B にある各レジスタの仕様を参照すること.
                        65 ***************************************************************
                        66 .section .text
                        67 .even
                        68 boot:
                        69 		* スーパーバイザ & 各種設定を行っている最中の割込禁止
000400 46FC 2000        70 		move.w #0x2000,%SR
000404 4FF9 0000        71 		lea.l SYS_STK_TOP, %SP | Set SSP
       0000             71 
                        72 		****************
                        73 		** 割り込みコントローラの初期化
                        74 		****************
00040a 13FC 0040        75 		move.b #0x40, IVR      | ユーザ割り込みベクタ番号を
       00FF F300        75 
                        76 		                       | 0x40+level に設定.
000412 23FC 00FF        77 		move.l #0x00ff3ffb,IMR | 全割り込みマスク
       3FFB 00FF        77 
       F304             77 
                        78 		****************
                        79 		** 送受信 (UART1) 関係の初期化 ( 割り込みレベルは 4 に固定されている )
                        80 		****************
00041c 21FC 0000        81 		move.l #UART1_interrupt, 0x110  | 受信割り込みベクタをセット
       0000 0110        81 
000424 33FC 0000        82 		move.w #0x0000, USTCNT1 | リセット
       00FF F900        82 
00042c 33FC E10C        83 		move.w #0xe10c, USTCNT1 | 送受信可能 , パリティなし , 1 stop, 8 bit, /* 変更 */
       00FF F900        83 
                        84 					| 受信割り込み許可, 送割り込み禁止
000434 33FC 0038        85 		move.w #0x0038, UBAUD1  | baud rate = 230400 bps
       00FF F902        85 
                        86 		****************
                        87 		** タイマ関係の初期化 ( 割り込みレベルは 6 に固定されている )
                        88 		*****************
00043c 33FC 0004        89 		move.w #0x0004, TCTL1   | restart, 割り込み不可 ,
       00FF F600        89 
                        90 					| システムクロックの 1/16 を単位として計時,
                        91 					| タイマ使用停止
                        92 					
000444 4EBA 012E        93 	    jsr Init_Q
000448 6000 0164        94 		bra MAIN
                        95 
                        96 *************************************
                        97 ** UART1_interrupt
                        98 *************************************
                        99 UART1_interrupt:
00044c 13FC 0031       100 		move.b #'1', LED7
       00D0 002F       100 
000454 0839 000F       101 		btst.l #15, UTX1      |  15ビット目は送信キューが空であるか
       00FF F906       101 
00045c 6600 0014       102 		bne    CALL_INTERGET  |  if UTX1[15] !=0  (空のとき)
000460 13FC 0032       103 		move.b #'2', LED5
       00D0 002B       103 
000468 7200            104 		move.l #0, %d1        |  ch = 0 を明示
00046a 4EBA 0010       105 		jsr    INTERPUT       |  送信割り込み時処理
00046e 6000 000A       106 		bra    END_interrupt
                       107 CALL_INTERGET:
                       108 		*jsr   INTERGET
000472 13FC 0032       109 		move.b #'2', LED6
       00D0 002D       109 
                       110 END_interrupt:
00047a 4E73            111 		rte
                       112 
                       113 *************************************
                       114 ** INTERPUT :  送信割り込み時の処理	
                       115 ** 引数     :  %d1.l = チャネル(ch)	
                       116 *************************************
                       117 INTERPUT:
00047c 13FC 0033       118 		move.b  #'3', LED4
       00D0 0029       118 
000484 46FC 2700       119 		move.w  #0x2700, %SR | 走行レベルを７に設定
000488 0C81 0000       120 		cmpi.l  #0, %d1      | ch = 0 を確認
       0000            120 
00048e 6600 002A       121 		bne     END_INTERPUT | if ch != 0 => 復帰
                       122 		/* OUTQがあるとして... */
000492 7001            123 		move.l  #1, %d0
000494 4EBA 002E       124 		jsr     OUT_Q   | %d1.b = data
000498 0C40 0000       125 		cmpi    #0, %d0      | %d0(OUTQの戻り値) == 0(失敗)
00049c 6600 000A       126 		bne     TX_DATA      | ==> 送信割り込みをマスク(真下)
0004a0 33FC E108       127 		move.w  #0xe108, USTCNT1
       00FF F900       127 
                       128 TX_DATA:
0004a8 13FC 0033       129 		move.b  #'3', LED2
       00D0 003D       129 
0004b0 0641 0800       130 		add.w   #0x0800, %d1 | ヘッダを付与
0004b4 33C1 00FF       131 		move.w  %d1, UTX1
       F906            131 
                       132 END_INTERPUT:
0004ba 13FC 0033       133 		move.b  #'3', LED1
       00D0 003B       133 
0004c2 4E75            134 		rts
                       135 
                       136 ******************************
                       137 		** OUTQ
                       138 		**入力:キュー番号:d0.l
                       139 		**出力:d0:0失敗, d0:1成功
                       140 		**取り出したデータ:d1.b
                       141 ******************************
                       142 OUT_Q:		
0004c4 103C 0001       143                 move.b #1, %d0
0004c8 0C00 0000       144 		cmp.b #0x00, %d0/*noの値で分岐*/
0004cc 6600 0008       145 		bne o_loop1
0004d0 4EBA 000A       146 		jsr OUTQ0
0004d4 4E75            147 		rts
                       148 o_loop1:
0004d6 4EBA 0050       149 		jsr OUTQ1
0004da 4E75            150 		rts
                       151 OUTQ0:
0004dc 40E7            152 		move.w %sr,-(%sp)
0004de 48E7 00F8       153 		movem.l %a0-%a4,-(%sp) /* レジスタ退避(1) */
0004e2 46FC 2700       154 		move.w  #0x2700, %SR /*走行レベル7(2)*/
0004e6 3039 0000       155 		move.w  s0, %d0 /* sの値によって実行できるか判定(3) */
       0000            155 
0004ec 0C40 0000       156 		cmp.w  #0x00, %d0 /* sが0のときd0を0x0:失敗  */
0004f0 6700 002E       157 		beq     o0_Finish /* 0x0でキューが空なら終了 */
0004f4 2279 0000       158 		movea.l out0, %a1 /* 次に取り出すのポインタアドレスをa1レジスタへ (4)*/
       0000            158 
0004fa 1219            159 		move.b  (%a1)+, %d1 /* キューからデータを読み出し、d1に転送 */
0004fc 45F9 0000       160 		lea.l bottom0, %a2 /*次に読み出そうとしているアドレスとキュー領域の末尾
       0000            160 
000502 B3CA            161 		cmp.l  %a2, %a1 
000504 6300 000A       162 		bls     o0_STEP1 /* a1 < a2　ならばSTEP1へ(out++) */
000508 47F9 0000       163 		lea.l top0, %a3 /*out=top*/
       0000            163 
00050e 224B            164 		move.l  %a3, %a1
                       165 o0_STEP1:
000510 23C9 0000       166 		move.l %a1, out0
       0000            166 
000516 5379 0000       167 		sub.w #1, s0 /*s--*/
       0000            167 
00051c 303C 0001       168 		move.w  #1, %d0/* 処理できたのでd0を1に */
                       169 o0_Finish:
000520 4CDF 1F00       170 		movem.l (%sp)+, %a0-%a4 /* レジスタ復帰 */
000524 46DF            171 		move.w (%sp)+, %sr
000526 4E75            172 		rts /* サブルーチンを抜ける */		
                       173 OUTQ1:
000528 40E7            174 		move.w %sr,-(%sp)
00052a 48E7 00F8       175 		movem.l %a0-%a4,-(%sp) /* レジスタ退避(1) */
00052e 46FC 2700       176 		move.w  #0x2700, %SR /*走行レベル7(2)*/
000532 3039 0000       177 		move.w  s1, %d0 /* sの値によって実行できるか判定(3) */
       0000            177 
000538 0C40 0000       178 		cmp.w #0x00, %d0 /* sが0のときd0を0x0:失敗  */
00053c 6700 002E       179 		beq     o1_Finish /* 0x0でキューが空なら終了 */
000540 2279 0000       180 		movea.l out1, %a1 /* 次に取り出すのポインタアドレスをa1レジスタへ (4)*/
       0000            180 
000546 1219            181 		move.b  (%a1)+, %d1 /* キューからデータを読み出し、d1に転送 */
000548 45F9 0000       182 		lea.l bottom1, %a2/*次に読み出そうとしているアドレスとキュー領域の末尾
       0000            182 
00054e B3CA            183 		cmp.l  %a2, %a1 
000550 6300 000A       184 		bls     o1_STEP1/* a1 < a2　ならばSTEP1へ(out++) */
000554 47F9 0000       185 		lea.l top1, %a3/*out=top*/
       0000            185 
00055a 224B            186 		move.l  %a3, %a1
                       187 o1_STEP1:
00055c 23C9 0000       188 		move.l %a1, out1
       0000            188 
000562 5379 0000       189 		sub.w #1, s1
       0000            189 
000568 303C 0001       190 		move.w  #1, %d0/* 処理できたのでd0を1に */
                       191 o1_Finish:
00056c 4CDF 1F00       192 		movem.l (%sp)+, %a0-%a4 /* レジスタ復帰 */
000570 46DF            193 		move.w (%sp)+, %sr
000572 4E75            194 		rts /* サブルーチンを抜ける */
                       195 ******************************
                       196 ** キューの初期化
                       197 ******************************
                       198 Init_Q:
000574 45F9 0000       199 lea.l top0, %a2
       0000            199 
00057a 47F9 0000       200 lea.l top1, %a3
       0000            200 
000580 23CA 0000       201 move.l %a2, out0
       0000            201 
000586 23CB 0000       202 move.l %a3, out1
       0000            202 
00058c 23CA 0000       203 move.l %a2, in0
       0000            203 
000592 23CB 0000       204 move.l %a3, in1
       0000            204 
000598 23FC 0000       205 move.l #0, s0
       0000 0000       205 
       0000            205 
0005a2 23FC 0000       206 move.l #0, s1
       0000 0000       206 
       0000            206 
0005ac 4E75            207 rts
                       208 
                       209 
                       210 
                       211 
                       212 
                       213 ******************************
                       214 ** キュー用のメモリ領域確保
                       215 ******************************
                       216 .section .data
                       217 .equ B_SIZE, 256
0005b4 0000 0000       218 top0:.ds.b B_SIZE-1
       0000 0000       218 
       0000 0000       218 
       0000 0000       218 
       0000 0000       218 
0006b3 00              219 bottom0:.ds.b 1
0006b4 0000 0000       220 top1:.ds.b B_SIZE-1
       0000 0000       220 
       0000 0000       220 
       0000 0000       220 
       0000 0000       220 
0007b3 00              221 bottom1:.ds.b 1
0007b4 0000 0000       222 out0:.ds.l 1
0007b8 0000 0000       223 out1:.ds.l 1
0007bc 0000 0000       224 in0:.ds.l 1
0007c0 0000 0000       225 in1:.ds.l 1
0007c4 0000            226 s0:.ds.w 1
0007c6 0000            227 s1:.ds.w 1
                       228 		
                       229 		
                       230 		
                       231 		
                       232 ***************************************************************
                       233 ** 現段階での初期化ルーチンの正常動作を確認するため,最後に ’a’ を
                       234 ** 送信レジスタ UTX1 に書き込む. ’a’ が出力されれば, OK.
                       235 ***************************************************************
                       236 .section .text
                       237 .even
                       238 MAIN:
                       239 	        *move.w #0x0800+'A', UTX1
                       240 		
                       241 LOOP:
0005ae 6000 FFFE       242 		bra LOOP		
                       243 
                       244 
