                         4 .list
                         5 ***************************************************************
                         6 ** 各種レジスタ定義
                         7 ***************************************************************
                         8 
                         9 ***************
                        10 ** レジスタ群の先頭
                        11 ***************
                        12 .equ REGBASE, 0xFFF000  | DMAP を使用.
                        13 .equ IOBASE,  0x00d00000
                        14 
                        15 ***************
                        16 ** 割り込み関係のレジスタ
                        17 ***************
                        18 .equ IVR,     REGBASE+0x300 | 割り込みベクタレジスタ
                        19 .equ IMR,     REGBASE+0x304 | 割り込みマスクレジスタ
                        20 .equ ISR,     REGBASE+0x30c | 割り込みステータスレジスタ
                        21 .equ IPR,     REGBASE+0x310 | 割り込みペンディングレジスタ
                        22 
                        23 
                        24 ***************
                        25 ** タイマ関係のレジスタ
                        26 ***************
                        27 .equ TCTL1,   REGBASE+0x600 | タイマ1コントロールレジスタ
                        28 .equ TPRER1,  REGBASE+0x602 | タイマ1プリスケーラレジスタ
                        29 .equ TCMP1,   REGBASE+0x604 | タイマ1コンペアレジスタ
                        30 .equ TCN1,    REGBASE+0x608 | タイマ1カウンタレジスタ
                        31 .equ TSTAT1,  REGBASE+0x60a | タイマ1ステータスレジスタ
                        32 ***************
                        33 ** UART1 (送受信)関係のレジスタ
                        34 ***************
                        35 .equ USTCNT1, REGBASE+0x900 | UART1 ステータス / コントロールレジスタ
                        36 .equ UBAUD1,  REGBASE+0x902 | UART1 ボーコントロールレジスタ
                        37 .equ URX1,    REGBASE+004 | UART1 受信レジスタ
                        38 .equ UTX1,    REGBASE+0x906 | UART1 送信レジスタ
                        39 ***************
                        40 ** LED
                        41 ***************
                        42 .equ LED7,IOBASE+0x000002f | ボード搭載のLED用レジスタ
                        43 .equ LED6,IOBASE+0x000002d | 使用法については付録 A.4.3.1
                        44 .equ LED5,IOBASE+0x000002b
                        45 .equ LED4,IOBASE+0x0000029
                        46 .equ LED3,IOBASE+0x000003f
                        47 .equ LED2,IOBASE+0x000003d
                        48 .equ LED1,IOBASE+0x000003b
                        49 .equ LED0,IOBASE+0x0000039
                        50 
                        51 ***************************************************************
                        52 ** スタック領域の確保
                        53 ***************************************************************
                        54 .section .bss
                        55 .even
                        56 SYS_STK:
0004b8 0000 0000        57 		.ds.b  0x4000 | システムスタック領域
       0000 0000        57 
       0000 0000        57 
       0000 0000        57 
       0000 0000        57 
                        58 		.even
                        59 SYS_STK_TOP: 		      | システムスタック領域の最後尾
                        60 
                        61 ***************************************************************
                        62 ** 初期化
                        63 ** 内部デバイスレジスタには特定の値が設定されている.
                        64 ** その理由を知るには,付録 B にある各レジスタの仕様を参照すること.
                        65 ***************************************************************
                        66 .section .text
                        67 .even
                        68 boot:
                        69 		* スーパーバイザ & 各種設定を行っている最中の割込禁止
000400 13FC 0031        70 		move.b	#'1', LED0
       00D0 0039        70 
000408 46FC 2000        71 		move.w #0x2000,%SR
00040c 4FF9 0000        72 		lea.l SYS_STK_TOP, %SP | Set SSP
       0000             72 
                        73 		****************
                        74 		** 割り込みコントローラの初期化
                        75 		****************
000412 13FC 0040        76 		move.b #0x40, IVR      | ユーザ割り込みベクタ番号を
       00FF F300        76 
                        77 		                       | 0x40+level に設定.
00041a 23FC 00FF        78 		move.l #0x00fffffb,IMR | 全割り込みマスク
       FFFB 00FF        78 
       F304             78 
000424 13FC 0031        79 		move.b	#'1', LED1
       00D0 003B        79 
                        80 		****************
                        81 		** 送受信 (UART1) 関係の初期化 ( 割り込みレベルは 4 に固定されている )
                        82 		****************
00042c 21FC 0000        83 		move.l #UART1_interrupt, 0x110  | 受信割り込みベクタをセット
       0000 0110        83 
000434 13FC 0031        84 		move.b	#'1', LED2
       00D0 003D        84 
00043c 33FC 0000        85 		move.w #0x0000, USTCNT1 | リセット
       00FF F900        85 
000444 13FC 0031        86 		move.b	#'1', LED3
       00D0 003F        86 
00044c 33FC E138        87 		move.w #0xe138, USTCNT1 | 送受信可能 , パリティなし , 1 stop, 8 bit, /* 変更 */
       00FF F900        87 
                        88 					| 受信割り込み許可, 送割り込み禁止
000454 13FC 0031        89 		move.b	#'1', LED4
       00D0 0029        89 
00045c 33FC 0038        90 		move.w  #0x0038, UBAUD1 | baud rate = 230400 bps
       00FF F902        90 
000464 13FC 0031        91 		move.b	#'1', LED5
       00D0 002B        91 
                        92 		****************
                        93 		** タイマ関係の初期化 ( 割り込みレベルは 6 に固定されている )
                        94 		*****************
00046c 13FC 0031        95 		move.b	#'1', LED6
       00D0 002D        95 
000474 33FC 0004        96 		move.w #0x0004, TCTL1   | restart, 割り込み不可 ,
       00FF F600        96 
                        97 					| システムクロックの 1/16 を単位として計時,
                        98 					| タイマ使用停止
00047c 13FC 0031        99 		move.b	#'1', LED7
       00D0 002F        99 
000484 6000 002E       100 		bra MAIN
                       101 
                       102 *************************************
                       103 ** UART1_interrupt
                       104 *************************************
                       105 UART1_interrupt:            
                       106 		/* sample */
000488 48A7 8080       107 		movem.w %d0/%a0, -(%sp)
                       108 		/*lea.l  URX1, %a0
                       109 		move.w (%a0), %d0
                       110 		add.w  #0x0800, %d0
                       111 		move.w %d0, UTX1  /* #0x08XX : XXはASCII */
00048c 4C9F 0101       112 	        movem.w (%sp)+, %d0/%a0
000490 4E73            113 		rte
                       114 
                       115 *************************************
                       116 ** INTERPUT :  送信割り込み時の処理	
                       117 ** 引数     :  %d1.l = チャネル(ch)	
                       118 *************************************
                       119 INTERPUT:
000492 46FC 2700       120 		move.w  #0x2700,%SR | 走行レベルを７に設定
000496 0C81 0000       121 		cmpi.l  #0, %d1      | ch = 0 を確認
       0000            121 
00049c 6600 0014       122 		bne     END_INTERPUT | if ch != 0 => 復帰
                       123 		/* OUTQがあるとして... */
                       124 		** jsr     OUTQ         | %d1.b = data
0004a0 0C40 0000       125 		cmpi    #0, %d0      | OUTQの戻り値 == 0(失敗)
0004a4 6600 0002       126 		bne     TX_DATA      | ==> 送信割り込みをマスク(真下)
                       127 		** move.w  #0xe138, USTCNT1
                       128 TX_DATA:
0004a8 0641 0800       129 		add.w   #0x0800, %d1
0004ac 33C1 00FF       130 		move.w  %d1, UTX1
       F906            130 
                       131 END_INTERPUT:
0004b2 4E73            132 		rte
                       133 		
                       134 		
                       135 ***************************************************************
                       136 ** 現段階での初期化ルーチンの正常動作を確認するため,最後に ’a’ を
                       137 ** 送信レジスタ UTX1 に書き込む. ’a’ が出力されれば, OK.
                       138 ***************************************************************
                       139 .section .data
                       140 .section .text
                       141 .even
                       142 MAIN:	
                       143 LOOP:
0004b4 6000 FFFE       144 		bra LOOP		
                       145 
                       146 
