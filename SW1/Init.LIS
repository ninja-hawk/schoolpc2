                         4 .list
                         5 ***************************************************************
                         6 ** 各種レジスタ定義
                         7 ***************************************************************
                         8 
                         9 ***************
                        10 ** レジスタ群の先頭
                        11 ***************
                        12 .equ REGBASE, 0xFFF000  | DMAP を使用.
                        13 .equ IOBASE,  0x00d00000
                        14 
                        15 ***************
                        16 ** 割り込み関係のレジスタ
                        17 ***************
                        18 .equ IVR,     REGBASE+0x300 | 割り込みベクタレジスタ
                        19 .equ IMR,     REGBASE+0x304 | 割り込みマスクレジスタ
                        20 .equ ISR,     REGBASE+0x30c | 割り込みステータスレジスタ
                        21 .equ IPR,     REGBASE+0x310 | 割り込みペンディングレジスタ
                        22 
                        23 
                        24 ***************
                        25 ** タイマ関係のレジスタ
                        26 ***************
                        27 .equ TCTL1,   REGBASE+0x600 | タイマ1コントロールレジスタ
                        28 .equ TPRER1,  REGBASE+0x602 | タイマ1プリスケーラレジスタ
                        29 .equ TCMP1,   REGBASE+0x604 | タイマ1コンペアレジスタ
                        30 .equ TCN1,    REGBASE+0x608 | タイマ1カウンタレジスタ
                        31 .equ TSTAT1,  REGBASE+0x60a | タイマ1ステータスレジスタ
                        32 ***************
                        33 ** UART1 (送受信)関係のレジスタ
                        34 ***************
                        35 .equ USTCNT1, REGBASE+0x900 | UART1 ステータス / コントロールレジスタ
                        36 .equ UBAUD1,  REGBASE+0x902 | UART1 ボーコントロールレジスタ
                        37 .equ URX1,    REGBASE+0x904 | UART1 受信レジスタ
                        38 .equ UTX1,    REGBASE+0x906 | UART1 送信レジスタ
                        39 ***************
                        40 ** LED
                        41 ***************
                        42 .equ LED7,　IOBASE+0x000002f | ボード搭載のLED用レジスタ
                        43 .equ LED6,　IOBASE+0x000002d | 使用法については付録 A.4.3.1
                        44 .equ LED5,  IOBASE+0x000002b
                        45 .equ LED4,  IOBASE+0x0000029
                        46 .equ LED3,  IOBASE+0x000003f
                        47 .equ LED2,  IOBASE+0x000003d
                        48 .equ LED1,  IOBASE+0x000003b
                        49 .equ LED0,  IOBASE+0x0000039
                        50 
                        51 ***************************************************************
                        52 ** スタック領域の確保
                        53 ***************************************************************
                        54 .section .bss
                        55 .even
                        56 SYS_STK:
000458 0000 0000        57 		.ds.b  0x4000 | システムスタック領域
       0000 0000        57 
       0000 0000        57 
       0000 0000        57 
       0000 0000        57 
                        58 		.even
                        59 SYS_STK_TOP: 		      | システムスタック領域の最後尾
                        60 
                        61 ***************************************************************
                        62 ** 初期化
                        63 ** 内部デバイスレジスタには特定の値が設定されている.
                        64 ** その理由を知るには,付録 B にある各レジスタの仕様を参照すること.
                        65 ***************************************************************
                        66 .section .text
                        67 .even
                        68 boot:
                        69 		* スーパーバイザ & 各種設定を行っている最中の割込禁止
000400 46FC 2000        70 		move.w #0x2000,%SR
000404 4FF9 0000        71 		lea.l SYS_STK_TOP, %SP | Set SSP
       0000             71 
                        72 		****************
                        73 		** 割り込みコントローラの初期化
                        74 		****************
00040a 13FC 0040        75 		move.b #0x40, IVR      | ユーザ割り込みベクタ番号を
       00FF F300        75 
                        76 		                       | 0x40+level に設定.
000412 23FC 00FF        77 		move.l #0x00fffffb,IMR | 全割り込みマスク
       FFFB 00FF        77 
       F304             77 
                        78 		****************
                        79 		** 送受信 (UART1) 関係の初期化 ( 割り込みレベルは 4 に固定されている )
                        80 		****************
00041c 21FC 0000        81 		move.l #UART1_interrupt, 0x110  | 受信割り込みベクタをセット
       0000 0110        81 
000424 33FC 0000        82 		move.w #0x0000, USTCNT1 | リセット
       00FF F900        82 
00042c 33FC E107        83 		move.w #0xe107, USTCNT1 | 送受信可能 , パリティなし , 1 stop, 8 bit, /* 変更 */
       00FF F900        83 
                        84 					| 受信割り込み許可, 送割り込み禁止
000434 33FC 0038        85 		move.w #0x0038, UBAUD1  | baud rate = 230400 bps
       00FF F902        85 
                        86 		****************
                        87 		** タイマ関係の初期化 ( 割り込みレベルは 6 に固定されている )
                        88 		*****************
00043c 33FC 0004        89 		move.w #0x0004, TCTL1   | restart, 割り込み不可 ,
       00FF F600        89 
                        90 					| システムクロックの 1/16 を単位として計時,
                        91 					| タイマ使用停止
000444 6000 000C        92 		bra MAIN
                        93 
                        94 *************************************
                        95 ** UART1_interrupt
                        96 *************************************
                        97 UART1_interrupt:
000448 33FC 0861        98                 move.w #0x0800+'a',UTX1 /* 変更 */
       00FF F906        98 
                        99 
                       100 		/* sample */
                       101 		/* movem.w %d0/%a0, -(%sp)
                       102 		lea.l  URX1, %a0
                       103 		move.w (%a0), %d0
                       104 		add.w  #0x0800, %d0
                       105 		move.w %d0, UTX1  /* #0x08XX : XXはASCII */
                       106 	       /*	movem.w (%sp)+, %d0/%a0 */
000450 4E73            107 		rte
                       108 
                       109 ***************************************************************
                       110 ** 現段階での初期化ルーチンの正常動作を確認するため,最後に ’a’ を
                       111 ** 送信レジスタ UTX1 に書き込む. ’a’ が出力されれば, OK.
                       112 ***************************************************************
                       113 .section .data
                       114 .section .text
                       115 .even
                       116 MAIN:
                       117 		
                       118 		
                       119 LOOP:
                       120 		
000452 6000 FFFE       121 		bra LOOP		
                       122 
                       123 
