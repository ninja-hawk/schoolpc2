                         4 .list
                         5  .section .text
                         6 ******************************
                         7 ** メインルーチン
                         8 ** a0:書き込む/読み出すデータの始めアドレス
                         9 ** a4:書き込みデータの一時保存アドレス（データ量が256バイトを超える場
                        10 ** a5:読み出しデータの一時保存アドレス（データ量が256バイトを超える場
                        11 ** d3:キューの書き込み上限
                        12 ** d4:書き込み/読み出しデータ数
                        13 ******************************
                        14 Start:
000400 4EBA 0060        15 	jsr     Init_Q /* キューの初期化処理 */
000404 41F9 0000        16 	lea.l   Data_to_Que, %a0 /* 書き込むデータの先頭アドレスをa0レジスタへ */
       0000             16 
00040a 283C 0000        17 	move.l  #LENGTH, %d4 /* 書き込み回数をd4レジスタへ */
       0003             17 
000410 263C 0000        18 	move.l  #257, %d3 /* 書き込み上限 */
       0101             18 
                        19 
                        20 Loop1:
000416 5344             21 	subq.w  #1, %d4 /* 書き込みデータ数 - 1 */
000418 6500 0010        22 	bcs     End_put /* d4 - 1 < 0 ならば書き込み完全終了 */
00041c 5343             23 	subq.w  #1, %d3 /* 書き込み上限 - 1 */
00041e 6500 000A        24 	bcs     End_put /* d3 - 1 < 0 ならば書き込み一旦終了 */
000422 4EBA 0062        25 	jsr     QueueIn /* 書き込み処理 */
000426 6000 FFEE        26 	bra     Loop1 /* ループに戻る */
                        27 
                        28 End_put:
00042a 2848             29 	movea.l %a0,%a4 /* 次に書き込むデータの先頭アドレスを一時保存 */
00042c 41F9 0000        30 	lea.l   COPY, %a0 /* 書き込むデータの先頭アドレスをa0レジスタへ */
       0000             30 
000432 283C 0000        31 	move.l  #LENGTH, %d4 /* 読み出し回数をd4レジスタへ */
       0003             31 
000438 263C 0000        32 	move.l  #257, %d3 /* 読み出し上限 */
       0101             32 
                        33 
                        34 Loop2:
00043e 5344             35 	subq.w  #1, %d4 /* 読み出しデータ数 - 1 */
000440 6500 001C        36 	bcs     End_program /* d4 - 1 < 0 ならば読み出し完全終了 */
000444 5343             37 	subq.w  #1, %d3 /* 読み出し上限 - 1 */
000446 6500 000A        38 	bcs     End_get /* d3 - 1 < 0 ならば読み出し一旦終了 */
00044a 4EBA 0094        39 	jsr     QueueOut /* 読み出し処理 */
00044e 6000 FFEE        40 	bra     Loop2 /* ループに戻る */
                        41 
                        42 End_get:
000452 204C             43 	movea.l %a4,%a0 /* 一時保存していた次に書き込むデータの先頭アドレスをa0
000454 263C 0000        44 	move.l  #257, %d3 /* 書き込み上限 */
       0101             44 
00045a 6000 FFBA        45 	bra     Loop1
                        46 
                        47 End_program:
00045e 4E72 2700        48 	stop    #0x2700 /* 終了 */
                        49 **********************
                        50 ** キューの初期化処理 (サブルーチン1）(p15)
                        51 **********************
                        52 Init_Q:
000462 45F9 0000        53 	lea.l   BF_START, %a2 /* キューのデータ領域の先頭アドレスをa2レジスタへ */
       0000             53 
000468 23CA 0000        54 	move.l  %a2, PUT_PTR /* キューのデータ領域の先頭アドレス（a2）を書き込み用
       0000             54 
00046e 23CA 0000        55 	move.l  %a2, GET_PTR /* キューのデータ領域の先頭アドレス（a2）を読み出し用
       0000             55 
000474 13FC 00FF        56 	move.b  #0xff, PUT_FLG /* キューは「空」なので書き込み「許可」に設定 */
       0000 0000        56 
00047c 13FC 0000        57 	move.b  #0x00, GET_FLG /* キューは「空」なので読み出し「禁止」に設定 */
       0000 0000        57 
000484 4E75             58 	rts
                        59 
                        60 ***********************************
                        61 ** QueueIn キューへのデータ書き込み（サブルーチン2）
                        62 ** a0:書き込むデータのアドレス
                        63 ** d0:結果(00:失敗, 00以外:成功)
                        64 ***********************************
                        65 QueueIn:
000486 4EBA 0004        66 	jsr PUT_BUF/* キューへの書き込み*/
00048a 4E75             67 	rts /* メインルーチンへ */
                        68 ****************************************
                        69 ** キューへのデータ書き込みPUT_BUF（サブルーチン2-1）(p15)
                        70 ** a0:書き込むデータのアドレス
                        71 ** d0:結果(00:失敗, 00以外:成功)
                        72 ****************************************
                        73 PUT_BUF:
00048c 48E7 0078        74 	movem.l %a1-%a4,-(%sp) /* レジスタ退避 */
000490 1039 0000        75 	move.b  PUT_FLG, %d0 /* 書き込み許可フラグをd0レジスタへ */
       0000             75 
000496 0C00 0000        76 	cmp.b   #0x00, %d0 /* 書き込み許可フラグ 0x00:禁止 | 0xff:許可 */
00049a 6700 003E        77 	beq     PUT_BUF_Finish /* 0x00で書き込み「禁止」なら終了 */
00049e 2279 0000        78 	movea.l PUT_PTR, %a1 /* 書き込み用のポインタアドレスをa1レジスタへ */
       0000             78 
0004a4 12D8             79 	move.b  (%a0)+,(%a1)+ /* データをキューへ入れ、書き込むデータアドレスと書
0004a6 47F9 0000        80 	lea.l   BF_END, %a3 /* キューデータ領域の末尾アドレスをa3レジスタへ */
       0000             80 
0004ac B3CB             81 	cmpa.l  %a3, %a1 /* 次書き込もうとしているアドレスa1とキューデータ領域の
0004ae 6300 000A        82 	bls     PUT_BUF_STEP1 /* a1 < a3　ならば、そのままPUT_BUF_STEP1へ */
0004b2 45F9 0000        83 	lea.l   BF_START, %a2 /* 次書き込もうとしているアドレスa1とキューデータ領
       0000             83 
0004b8 224A             84 	movea.l %a2,%a1 /* 書き込み用ポインタ(a1)をキューデータ領域の先頭アドレス
                        85 PUT_BUF_STEP1:
0004ba 23C9 0000        86 	move.l  %a1,PUT_PTR /* 書き込み用ポインタを更新 */
       0000             86 
0004c0 B3F9 0000        87 	cmpa.l  GET_PTR,%a1 /* 読み出し用ポインタと書き込み用ポインタ(a1)を比較す
       0000             87 
0004c6 6600 000A        88 	bne     PUT_BUF_STEP2 /* 書き込み用ポインタと読み出し用ポインタが異なる、
0004ca 13FC 0000        89 	move.b  #0x00,PUT_FLG /* 書き込み用ポインタと読み出し用ポインタが同じなら
       0000 0000        89 
                        90 PUT_BUF_STEP2:
0004d2 13FC 00FF        91 	move.b  #0xff, GET_FLG /* キューが一杯でなくなったので読み出し用ポインタを
       0000 0000        91 
                        92 PUT_BUF_Finish:
0004da 4CDF 1E00        93 	movem.l (%sp)+, %a1-%a4 /* レジスタ復帰 */
0004de 4E75             94 	rts /* サブルーチンを抜ける */
                        95 
                        96 
                        97 
                        98 ***********************************
                        99 ** QueueOut キューからのデータ読み出し（サブルーチン3）
                       100 ** a0:読み出すデータのアドレス
                       101 ** d0:結果(00:失敗, 00以外:成功)
                       102 ***********************************
                       103 QueueOut:
0004e0 4EBA 0004       104 	jsr GET_BUF/* キューへの書き込み*/
0004e4 4E75            105 	rts /* メインルーチンへ */
                       106 ****************************************
                       107 ** キューへからのデータ読み出しGET_BUF（サブルーチン3-1）(p16)
                       108 ** a0:読み出すデータのアドレス
                       109 ** d0:結果(00:失敗, 00以外:成功)
                       110 ****************************************
                       111 GET_BUF:
0004e6 48E7 0078       112 	movem.l %a1-%a4,-(%sp) /* レジスタ退避 */
0004ea 1039 0000       113 	move.b  GET_FLG, %d0 /* 読み出し許可フラグをd0レジスタへ */
       0000            113 
0004f0 0C00 0000       114 	cmp.b   #0x00, %d0 /* 読み出し許可フラグ 0x00:禁止 | 0xff:許可 */
0004f4 6700 003E       115 	beq     GET_BUF_Finish /* 0x00で読み出し「禁止」なら終了 */
0004f8 2279 0000       116 	movea.l GET_PTR, %a1 /* 読み出し用のポインタアドレスをa1レジスタへ */
       0000            116 
0004fe 10D9            117 	move.b  (%a1)+,(%a0)+ /* データをキューへ入れ、読み出しデータアドレスa1と
000500 47F9 0000       118 	lea.l   BF_END, %a3 /* キューデータ領域の末尾アドレスをa3レジスタへ */
       0000            118 
000506 B3CB            119 	cmpa.l  %a3, %a1 /* 次書き込もうとしているアドレスa1とキューデータ領域の
000508 6300 000A       120 	bls     GET_BUF_STEP1 /* a1 < a3　ならば、そのままGET_BUF_STEP1へ */
00050c 45F9 0000       121 	lea.l   BF_START, %a2 /* 次読み込もうとしているアドレスa1とキューデータ領
       0000            121 
000512 224A            122 	movea.l %a2,%a1 /* 読み込み用ポインタ(a1)をキューデータ領域の先頭アドレス
                       123 GET_BUF_STEP1:
000514 23C9 0000       124 	move.l  %a1,GET_PTR /* 読み出し用ポインタを更新 */
       0000            124 
00051a B3F9 0000       125 	cmpa.l  PUT_PTR,%a1 /* 書き込み用ポインタと読み出し用ポインタ(a1)を比較す
       0000            125 
000520 6600 000A       126 	bne     GET_BUF_STEP2 /* 書き込み用ポインタと読み出し用ポインタが異なる、
000524 13FC 0000       127 	move.b  #0x00,GET_FLG /* 書き込み用ポインタと読み出し用ポインタが同じなら
       0000 0000       127 
                       128 GET_BUF_STEP2:
00052c 13FC 00FF       129 	move.b  #0xff, GET_FLG /* キューが空でなくなったので読み出し用ポインタを「
       0000 0000       129 
                       130 GET_BUF_Finish:
000534 2A48            131 	movea.l  %a0, %a5 /* 更新された読み出しデータ出力先のアドレスa0をCOPYに一
000536 4CDF 1E00       132 	movem.l (%sp)+, %a1-%a4 /* レジスタ復帰 */
00053a 4E75            133 	rts /* サブルーチンを抜ける */
                       134 
                       135 
                       136 
                       137 
                       138 
                       139 ******************************
                       140 .section .data
                       141 ******************************
                       142 **
                       143 **
                       144 ** キュー用のメモリ領域確保
                       145 **
                       146 **
                       147 ******************************
                       148 **キューのデータ領域は256バイト(p12)
                       149 	.equ	B_SIZE, 256 
                       150 ******************************
                       151 **キューデータ領域の先頭アドレス(p12)
00053c 0000 0000       152 BF_START:	.ds.b	B_SIZE-1
       0000 0000       152 
       0000 0000       152 
       0000 0000       152 
       0000 0000       152 
                       153 ******************************
                       154 **キューデータ領域の末尾アドレス(p13)
00063b 00              155 BF_END:		.ds.b	1
                       156 ******************************
                       157 **キューに書き込むべきデータアドレスを管理するポインタ(p13)
00063c 0000 0000       158 PUT_PTR:	.ds.l	1
                       159 ******************************
                       160 **キューから読み出すデータアドレスを管理するポインタ(p13)
000640 0000 0000       161 GET_PTR:	.ds.l	1
                       162 ******************************
                       163 **書き込み許可フラグ(p14)
                       164 **0x00 -> 書き込み禁止（buffer FULL）
                       165 **0xFF -> 書き込み許可
000644 00              166 PUT_FLG:	.ds.b	1
                       167 ******************************
                       168 **読み出し許可フラグ(p14)
                       169 **0x00 -> 読み出し禁止（buffer EMPTY）
                       170 **0xFF -> 読み出し許可
000645 00              171 GET_FLG:	.ds.b	1
                       172 ******************************
                       173 
                       174 
                       175 ******************************
                       176 **
                       177 ** 書き込むデータ（サンプル）
                       178 **
                       179 ******************************
                       180 ** 書き込みデータの長さ
                       181 	.equ        LENGTH,3
                       182 ******************************
                       183 ** 書き込むデータ
000646 4142 43         184 Data_to_Que:	.ascii	"ABC"
                       185 ******************************
                       186 
                       187 ******************************
                       188 **
                       189 ** 読み出し先
                       190 **
                       191 ******************************
                       192 COPY:
000649 0000 0000       193 	.ds.b 20          /* 読み出しデータ出力先 */
       0000 0000       193 
       0000 0000       193 
       0000 0000       193 
       0000 0000       193 
                       194 
                       195 .end
